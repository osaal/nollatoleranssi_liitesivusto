# Anonymisointi {#sec-anonymisointi}

---
eval: false
---

Tutkimus anonymisoidaan [anonymisointisuunnitelman](https://osf.io/r3hs2) mukaisesti.

```{r}
#| label: anon-00-funktiot

# HUOM: Funktio ei nimeä kuvia! Funktio tulostaa NA jos niitä on.
plot_freq <- function(x) {
  as.matrix(x) %>%
    table(useNA = "ifany") %>%
    barplot()
}

# Projektipäällikön kirjoittama funktio k-anonymiteetin tarkistamiseksi.
# Funktio haettu manuaalisesti GitHubista (osaal/ranon#a114b6a).
# Funktio vaatii paketit checkmate, cli, dplyr ja rlang.
# HUOM: Muutettu paketin versiosta toimivaksi.
k_anonymity <- function(data, limit, ...) {
  # Argument checks
  if (!(checkmate::check_data_frame(data) || checkmate::check_tibble(data))) {
    cli::cli_abort(c(
      "{.var data} must be a data frame or tibble",
      "x" = "You supplied the type {.cls class(data)}"
    ))
  }
  if (!(checkmate::check_int(limit))) {
    cli::cli_abort(c(
      "{.var limit} must be a single integer",
      "x" = "You supplied the type {.cls class(limit)}"
    ))
  }

  # Select data according to variables
  cols <- dplyr::quos(...)

  # Capture error from incorrect cols and return more helpful error message
  selected_data <- rlang::try_fetch(
    data |> dplyr::select(!!!cols),
    error = function(cnd) {
      cli::cli_abort(c(
        "All supplied columns must exist in {.var data}",
        "X" = "You supplied the column names {sapply(cols, rlang::f_text)}",
        "i" = "{.var data} contains the columns {names(data)}",
        "i" = "Tip: Negated columns must also exist in the data"
      ),
      parent = cnd)
    }
  )

  # Crosstabulate and retrieve all unique combinations that fall below the limit
  low_count_cells <- table(selected_data, useNA = "always") |>
    as.data.frame() |>
    dplyr::filter(Freq < limit)

  # Exit early if no cells fall below the threshold
  if (length(low_count_cells) == 0) {
    message("All variable combinations are at or above the supplied threshold")
    return(NULL)
  }

  return(low_count_cells)
}

```

```{r}
#| label: anon-01-valmistelu

library(tidyverse)

data <- read.csv2("output/puhdistettudata.csv")

```

## Järjestys {#sec-anonymisointi-jarjestys}

1.  Tarkistetaan taustamuuttujien kategoriat harvinaisten vastausten osalta yksitellen, ja yhdistetään kategorioita tarpeen mukaan.
2.  Tarkistetaan harvinaisten ilmiöiden muuttujien kategoriat harvinaisten vastausten osalta yksitellen, ja yhdistetään tai poistetaan kategorioita/muuttujia tarpeen mukaan.
3.  Taustamuuttujat 5-anonymisoidaan kahden ja kolmen muuttujan yhdistelmissä, ja yhdistetään kategorioita tarpeen mukaan.
4.  Harvinaiset ilmiöt 5-anonymisoidaan taustamuuttujia vastaan kahden muuttujan yhdistelmissä, ja yhdistetään tai poistetaan kategorioita/muuttujia tarpeen mukaan.

**Kohta 1: Käsiteltävät taustamuuttujat:**

1.  Organisaatiokuuluvuus (`k2`, neljä kategoriaa)
    1.  Kaikilla vastaajilla tulee olla yksi arvo.
    2.  Määräsääntö: `n > 5`
    3.  Yhdistetään luokat `1` ja `2` sekä `3` ja `4` tarpeen vaatiessa.
2.  Sukupuoli (`k31`, neljä kategoriaa)
    1.  Kaikilla vastaajilla tulee olla yksi arvo.
    2.  Määräsääntö: `n > 30`
    3.  Yhdistetään luokat `1`, `3` ja `4` pienimpään toiseen luokkaan, joka täyttää määräsäännön.
3.  Työrytmi (`k32-k35`, `k37`)
    1.  Kaikilla vastaajilla tulee olla yksi arvo, organisaatiokuuluvuudensa mukaisesti.
    2.  Määräsääntö: `n > 10`
    3.  Muuttuja `k32`: Yhdistetään samanaiheiseen kategoriaan tarpeen vaatiessa.
    4.  Muuttuja `k33`: Yhdistetään viereiseen kategoriaan tarpeen vaatiessa.
    5.  Muuttuja `k34`: Ei muutoksia.
    6.  Muuttuja `k35`: Yhdistetään viereiseen kategoriaan tarpeen vaatiessa.
    7.  Muuttuja `k37`: Yhdistetään samanaiheiseen kategoriaan tarpeen vaatiessa.
4.  Organisaatioasema (`Organisaatioasema`, kuusi kategoriaa)
    1.  Kaikilla vastaajilla tulee olla yksi arvo.
    2.  Rakennetaan eri organisaatioasemamuuttujista, ks. @sec-valmistelu-uudelleenkoodaukset-organisaatioasema
    3.  Määräsääntö: `n > 10`
    4.  Yhdistetään luokat `1` ja `4` tarpeen vaatiessa.
    5.  Muut luokat yhdistetään aiheittain tarpeen vaatiessa.
5.  Työuran pituus (`k41`) --\> Viiden fraktiilin luokitus
    1.  Kaikilla vastaajilla tulee olla yksi arvo.
    2.  Luokitellaan viiteen fraktiiliin, mikä riittää yksimuuttuja-anonymisoinnille.

**Kohta 2: Harvinaisten ilmiöiden muuttujat:**

1.  Epäasiallisen ja väkivaltaisen kohtelun yleisyys (`k3_1:k4_7`, `k12_1:k13_7`)
    1.  Yhteensä 28 muuttujaa
    2.  Kaikilla vastaajilla tulee olla yksi arvo, mikä voi myös olla arvo `NA`
    3.  Sovelletaan 5-anonymiteettia (ks. kohta 4)
2.  Kohtelun selventävät mittarit (`k5_3_1:k5_3_2`, `k7_10_1:k7_10_2`, `k8_11_1:k8_11_2`, `k9_5_1:k9_5_2`, `k9_10_1:k9_10_2`, `k10_2_1:k10_2_2`, `k10_10_1:k10_10_2`, `k10_11_1:k10_11_2`, `k11_6_1:k11_6_2`, `k14_3_1:k14_3_2`, `k16_10_1:k16_10_2`, `k17_11_1:k17_11_2`, `k18_5_1:k18_5_2`, `k18_10_1:k18_10_2`, `k19_2_1:k19_2_2`, `k19_10_1:k19_10_2`, `k19_11_1:k19_11_2`)
    1.  Yhteensä 34 muuttujaa
    2.  Kaikilla vastaajilla tulee olla yksi arvo, mikä voi myös olla arvo `NA` tai `-1`
    3.  Määräsääntö: `n > 5`
    4.  Muuttuja poistetaan jos määräsääntö ei täyty jokaisen kategorian osalta (`NA`, `-1`, `1`)
3.  Vaikutukset jatkuvat yhä (`k22_1_1:k22_3_1`)
    1.  Yhteensä 3 muuttujaa
    2.  Kaikilla vastaajilla tulee olla yksi arvo, mikä voi myös olla arvo `NA` tai `-1`
    3.  Sovelletaan 5-anonymiteettia (ks. kohta 4)
4.  Reaktiot kohteluun (`k23_1:k23_11`)
    1.  Yhteensä 11 muuttujaa
    2.  Kaikilla vastaajilla tulee olla yksi arvo, mikä voi myös olla arvo `NA` tai `-1`
    3.  Sovelletaan 5-anonymiteettia (ks. kohta 4)

**Kohta 3: Taustamuuttujien 5-anonymisointi ristiintaulukoimalla**

1.  Organisaatiokuuluvuus x Organisaatioasema (`k2 * Organisaatioasema`)
2.  Organisaatiokuuluvuus \* Organisaatioasema \* Sukupuoli (`k2 * Organisaatioasema * k31`)
3.  Organisaatiokuuluvuus x Organisaatioasema x Työrytmi (`k2 * Organisaatioasema * k32, k33, k34, k35, k37`)
4.  Organisaatiokuuluvuus x Organisaatioasema x Työuran pituus (`k2 * Organisaatioasema * k41`)

Kaikilla taustamuuttujilla seurataan seuraavaa prioriteettijärjestystä muutoksissa:

1.  Organisaatioaseman (`Organisaatioasema`) kategoriat yhdistetään vähintään neljäksi kategoriaksi.
2.  Työrytmin (`k32, k33, k34, k35, k37`) kategoriat yhdistetään vähintään kolmeksi kategoriaksi.
    1.  Poikkeuksena `k34`, jolle ei voida tehdä muutoksia.
3.  Työuran pituuden (`k41`) fraktiileja vähennetään vähintään kolmeen fraktiiliin.
4.  Sukupuolen (`k31`) kategoriat yhdistetään vähintään kahteen kategoriaan.
5.  Organisaatiokuuluvuuden (`k2`) kategoriat yhdistetään vähintään kolmeen kategoriaan.

**Kohta 4: Harvinaisten ilmiöiden 5-anonymisointi taustamuuttujia vastaan**

Jokainen kohdassa 2 listattu muuttuja ristiintaulukoidaan yksitellen jokaista taustamuuttujaa kohtaan. Koska taustamuuttujia on yhdeksän kappaletta ja harvinaisia ilmiöitä 62, vertailuja tehdään yhteensä 558 kappaletta.

Tätä varten projektipäällikkö on kirjoittanut funktion `k_anonymity()`, joka löytyy osana R-pakettia `ranon` ([GitHubissa](https://github.com/osaal/ranon) `osaal/ranon`). Funktio ottaa yhden tai useamman kategorisen muuttujan, ja palauttaa kaikki kategoriayhdistelmät, joiden solumäärät ristiintaulukoinnissa alittavat ennalta määritetyn raja-arvon (tässä tutkimuksessa viisi). Jos funktiolle annetaan vain yksi muuttuja, tarkistus tehdään muuttujan kategorioille, jolloin kyseessä on yksinkertainen määräsäännön anonymisointitarkistus.

**HUOM:** Kirjoitushetkellä (12.9.2024) paketin funktio ei toimi kuten pitäisi. Olemme korjanneet funktion ja testanneet kaikki alla olevat koodaukset simuloidulla datalla ennen anonymisoinnin suorittamista. Korjattu funktio löytyy tämän luvun alusta, ensimmäisestä koodiblokista.

## Kohta 1: Taustamuuttujien anonymisointi {#sec-anonymisointi-kohta1}

```{r}
#| label: anon-02-taustamuuttujat

# Muuttujaa voi käyttää myöhemmin looppaamiseen
taustamuuttujat <- rlang::exprs(
  k2,
  k31, k32, k33, k34, k35, k37,
  Organisaatioasema,
  k41
)

# Tässä ei voida loopata helposti, sillä muuttujien raja-arvot eroavat ja muuttujaa k41 ei tarkisteta ollenkaan
# Testattu toimivaksi tekaistulla datalla. HUOM: Vaatii nykyiset funktiossa olevat korjaukset (ks. code block 00_anon_funktiot)

k_anonymity(data, limit = 5, k2)
k_anonymity(data, limit = 30, k31)
k_anonymity(data, limit = 10, k32)
k_anonymity(data, limit = 10, k33)
k_anonymity(data, limit = 10, k34)
k_anonymity(data, limit = 10, k35)
k_anonymity(data, limit = 10, k37)
k_anonymity(data, limit = 10, Organisaatioasema)
```

Tulokset kuvaillaan tässä.

Muutokset kuvaillaan tässä.

```{r}
#| label: anon-03-muutokset



```

## Kohta 2: Harvinaisten ilmiöiden anonymisointi {#sec-anonymisointi-kohta2}

```{r}
#| label: anon-04-harvinaisetilmiot

# Muuttujaa voi käyttää nyt ja myöhemmin looppaamiseen
muuttujat <- rlang::exprs(
  k3_1, k3_2, k3_3, k3_4, k3_5, k3_6, k3_7,
  k4_1, k4_2, k4_3, k4_4, k4_5, k4_6, k4_7,
  k12_1, k12_2, k12_3, k12_4, k12_5, k12_6, k12_7,
  k13_1, k13_2, k13_3, k13_4, k13_5, k13_6, k13_7,
  k5_3_1, k5_3_2,
  k7_10_1, k7_10_2,
  k8_11_1, k8_11_2,
  k9_5_1, k9_5_2, k9_10_1, k9_10_2,
  k10_2_1, k10_2_2, k10_10_1, k10_10_2, k10_11_1, k10_11_2,
  k11_6_1, k11_6_2,
  k14_3_1, k14_3_2,
  k16_10_1, k16_10_2,
  k17_11_1, k17_11_2,
  k18_5_1, k18_5_2, k18_10_1, k18_10_2,
  k19_2_1, k19_2_2, k19_10_1, k19_10_2, k19_11_1, k19_11_2,
  k22_1_1, k22_2_1, k22_3_1,
  k23_1, k23_2, k23_3, k23_4, k23_5, k23_6, k23_7, k23_8, k23_9, k23_10, k23_11
  )

# Loopataan harvinaisten ilmiöiden muuttujien läpi ja suoritettaan yhden muuttujan k-anonymisointi (eli yksinkertainen solujen tarkastus)
# HUOM: Listaus sisältää muuttujaryhmät k3_1:k4_7, k12_1:k13_7, k22_1_1:k22_3_1 ja k23_1:k23_11. Näitä ei anonymisointisuunnitelman mukaisesti kuitenkaan tarkisteta.
# Testattu toimivaksi tekaistulla datalla. HUOM: Vaatii nykyiset funktiossa olevat korjaukset (ks. code block 00_anon_funktiot)

tulokset_kohta2 <- list()
for (i in muuttujat) {
  tulokset_kohta2[[rlang::as_string(i)]] <- k_anonymity(data, limit = 5, i)
}

# Poistetaan väliaikaiset muuttujat siisteyden vuoksi
rm(i, temp)

```

Tulokset kuvaillaan tässä.

Muutokset kuvaillaan tässä.

```{r}
#| label: anon-05-muutokset



```

## Kohta 3: Taustamuuttujien k-anonymisointi toisiaan vastaan {#sec-anonymisointi-kohta3}

```{r}
#| label: anon-06-taustamuuttujat-k_anon

# Testattu toimivaksi tekaistulla datalla. HUOM: Vaatii nykyiset funktiossa olevat korjaukset (ks. code block 00_anon_funktiot)

k_anonymity(data, limit = 5, k2, Organisaatioasema)
k_anonymity(data, limit = 5, k2, Organisaatioasema, k31)
k_anonymity(data, limit = 5, k2, Organisaatioasema, k32)
k_anonymity(data, limit = 5, k2, Organisaatioasema, k33)
k_anonymity(data, limit = 5, k2, Organisaatioasema, k34)
k_anonymity(data, limit = 5, k2, Organisaatioasema, k35)
k_anonymity(data, limit = 5, k2, Organisaatioasema, k37)
k_anonymity(data, limit = 5, k2, Organisaatioasema, k41)

```

Tulokset kuvaillaan tässä.

Muutokset kuvaillaan tässä.

```{r}
#| label: anon-07-muutokset



```

## Kohta 4: Harvinaisten ilmiöiden k-anonymisointi taustamuuttujia vastaan {#sec-anonymisointi-kohta4}

```{r}
#| label: anon-08-harvinaiset_k-anon

# Testattu toimivaksi tekaistulla datalla. HUOM: Vaatii nykyiset funktiossa olevat korjaukset (ks. code block 00_anon_funktiot)

tulokset_kohta4 <- list()

for (i in muuttujat) {
  temp <- list()
  for (j in taustamuuttujat) {
    temp[[rlang::as_string(j)]] <- k_anonymity(data, limit = 5, i, j)
  }
  tulokset_kohta4[[rlang::as_string(i)]] <- temp
}

# Poistetaan väliaikaiset muuttujat siisteyden vuoksi
rm(i, j, temp)
```

Tulokset kuvaillaan tässä.

Muutokset kuvaillaan tässä.

```{r}
#| label: anon-09-muutokset



```

## Datan tallennus {#sec-anonymisointi-datantallennus}

Anonymisoinnin jälkeen tallensimme lopullisen datatiedoston `csv`-muotoon. Tallennusta ei ole saatavilla verkkosivun lähdekoodista tietosuojan takia.

```{r}
#| label: anon-10-tallennus

write.csv2(data, file = "output/anonymisoitudata.csv")

```
