# Epäasiallisen ja väkivaltaisen kohtelun esiintyvyyden mittarin validointi {#sec-kohtelu_validointi}

---
eval: true
cache: true
---

Tässä osiossa suoritamme tilastollisen validoinnin epäasiallisen ja väkivaltaisen kohtelun esiintyvyyden mittarille. Osio liittyy rekisteröityyn tutkimusraporttiin "Epäasiallisen ja väkivaltaisen kohtelun suomen- ja ruotsinkielisen mittarin validointi pelastus- ja ensihoitoalalla" (Saal, Silfverhuth & Huovinen, 2024). Viittaamme raportin rekisteröityihin protokolliin tekstissä.

```{r}
#| label: kohtelu_validointi-00-paketit
#| code-summary: "Osiossa käytetyt paketit"
#| output: false

library(ggstatsplot)
library(naniar)
library(HH)
library(EFAtools)
library(lavaan)
library(dynamic)
library(semTools)
library(moments)
library(tidyverse) # Tidyverse viimeiseksi, sillä HH:ssa useat dplyrin funktiot peittyvät

```

```{r}
#| label: kohtelu_validointi-01-avaaminen
#| code-summary: "Datan avaaminen"

data <- read.csv2("output/valmisdata.csv", tryLogical = FALSE)

```

## Protokollamuutokset {#sec-kohtelu_validointi-protokollamuutokset}

Raportin luvussa 2.1. (Kohderyhmä) esitimme neljä kohderyhmää, niiden määritelmät sekä niiden yhteenlasketut otoskoot (ks. raportin Taulukko 2). Nämä kohderyhmät määriteltiin kontrollimuuttujina luvussa 2.5. (Kontrollimuuttujat). Olemme poikenneet kohderyhmistä seuraavalla tavalla:

-   Järjestöjen kohderyhmään lisättiin myös alueellisten pelastusliittojen henkilöstö

-   Anonymisoinnissa jouduimme yhdistämään järjestöt ja koulutusorganisaatiot yhdeksi muuttujaksi, jotta heidän anonymiteettinsa säilyisivät.

Raportin luvussa 2.2. (Yhteydenottomenetelmät) esitimme jokaiselle kohderyhmälle eritellyt yhteydenottomenetelmät. Menetelmät tarkentuivat ja laajenivat rekisteröinnin jälkeen (ks. @sec-tiedonkeruu). Poikkesimme suunnitelmasta seuraavalla tavalla:

-   Yhteydenottomenetelmät nimettiin uudelleen vastaamaan toteutettuja menetelmiä paremmin.

-   Vaihdoimme hyvinvointialueiden kirjaamot ja pelastuslaitosten viestinnät pelastuslaitosten ja ensihoidon yhteyshenkilöiksi.

-   Suomen Pelastusalan Keskusjärjestön kautta pelastusliittojen viestintään lähetetty viesti lähetettiin pelastusliittojen johdolle, samanaikaisesti kuin SPEK:n kautta pelastusliittojen johdolle lähetetty viesti.

-   Lisäsimme SPEK:n kautta sopimuspalokuntalaisten HAKA-järjestelmään ja siitä edelleen sopimuspalokunnille ja palokuntayhdistyksille välittetävä viesti. Tämä menetelmä laskettiin yhteyshenkilöiden ja viestinnän kautta välitettäväksi viestiksi.

-   Lisäsimme uutiskirjeet seuraavissa palveluissa: Palokuntaan.fi ja Pelastusopiston uutiskirjeet ensihoidolle, pelastustoimelle, onnettomuuksien ehkäisyyn sekä pelastustoimintaan. Nämä laskettiin yhteyshenkilöiden ja viestinnän kautta välitettäviksi viesteiksi.

-   Lisäsimme Spek.fi-sivustolla julkaistun tiedotteen sekä SSPL:n jäsenille lähetettävän tiedotteen. Nämä laskettiin median kautta välitettäviksi viesteiksi.

-   Lähetimme muistutusviestit järjestöjen ja koulutusorganisaatioiden johtajille, ensihoidon ja pelastuslaitosten yhteyshenkilöille sekä järjestöjen ja koulutusorganisaatioiden toimistoihin ja viestintään 3.9.2024.

## Deskriptiiviset tulokset {#sec-kohtelu_validointi-deskriptiiviset}

Tiedonkeruu suoritettiin 15.8.-15.9.2024 välisenä aikana. Aineistoon kuuluu n = `r nrow(data)` vastaajaa.

```{r}
#| label: kohtelu_validointi-02-taustamuuttujat
#| code-summary: "Sukupuoli"

sukupuoli <- data |>
  select(k31) |>
  mutate(
    k31 = factor(
      k31,
      labels = c("Nainen", "Mies", "Muu/EHV")
    )
  ) |>
  table() |>
  as.data.frame() |>
  mutate(
    Pros = (Freq / nrow(data)) * 100
  )
  
```

Vastaajista `r round(sukupuoli[2, "Pros"], digits = 1)` prosenttia (n = `r sukupuoli[2, "Freq"]`) olivat miehiä, `r round(sukupuoli[1, "Pros"], digits = 1)` prosenttia (n = `r sukupuoli[1, "Freq"]`) olivat naisia ja `r round(sukupuoli[3, "Pros"], digits = 1)` prosenttia (n = `r sukupuoli[3, "Freq"]`) muunsukupuolisia tai kieltäytyivät vastaamasta.

Verrattuna tunnettuihin sukupuolijakaumiin, aineistossa on yliedustettuna naissukupuoliset henkilöt.

```{r}
#| label: kohtelu_validointi-03-taustamuuttujat
#| code-summary: "Kohderyhmä"

kohderyhma <- data |>
  select(k2) |>
  mutate(
    k2 = factor(
      k2,
      labels = c(
        "Pelastuslaitos tai ensihoito",
        "Sopimuspalokunta tai palokuntayhdistys",
        "Järjestö, pelastusliitto tai koulu")
    )
  ) |>
  table() |>
  as.data.frame() |>
  mutate(
    Pros = (Freq / nrow(data)) * 100
  )
  
```

Vastaajista `r round(kohderyhma[1, "Pros"], digits = 1)` prosenttia (n = `r kohderyhma[1, "Freq"]`) olivat pelastuslaitokselta tai ensihoidosta, `r round(kohderyhma[2, "Pros"], digits = 1)` prosenttia (n = `r kohderyhma[2, "Freq"]`) olivat sopimuspalokunnista tai palokuntayhdistyksistä ja `r round(kohderyhma[3, "Pros"], digits = 1)` prosenttia (n = `r kohderyhma[3, "Freq"]`) olivat järjestöistä, pelastusliitoista tai koulutusorganisaatioista.

Kohderyhmätaulukon mukaan pelastuslaitosten ja ensihoidon osuus koko kohderyhmästä on noin 23,9 prosenttia, sopimuspalokuntien ja palokuntayhdistysten osuus noin 73,8 prosenttia, ja yhdistysten sekä koulutusorganisaatioiden yhteenlaskettu osuus noin 2,2 prosenttia. Aineistossamme on selkeästi yliedustettuina pelastuslaitokset ja ensihoito sekä hieman pienemmässä määrässä järjestöt, liitot ja koulutusorganisaatiot, ja aliedustettuina sopimuspalokunnat ja palokuntayhdistykset.

```{r}
#| label: kohtelu_validointi-04-taustamuuttujat
#| code-summary: "Ammattiasema"

ophenk_n <- data |>
  filter(Organisaatioasema == 2) |>
  filter(k2 == 1) |>
  nrow() - 70 # 70 henkilöä ovat alinta johtoa, eivätkä vastanneet suorittavan henkilöstön osuuteen. Jotta prosenttiosuudet olisivat oikein, arvoa on korjattava tämän verran.

ammattiasema <- data |>
  filter(Organisaatioasema == 2) |>
  select(k40) |>
  mutate(
    k40 = factor(
      k40,
      levels = c(1, 2, 3, -1),
      labels = c(
        "Pelastaja",
        "Ensihoitaja",
        "Muu",
        "Sopimuspalokuntalainen operatiivisessa toiminnassa"
      )
    )
  ) |>
  table() |>
  as.data.frame() |>
  mutate(
    Pros = (Freq / ophenk_n) * 100
  )

```

Operatiivista toimintaa suorittavasta pelastuslaitosten ja ensihoidon henkilöstöstä (n = `r ophenk_n`[^kohtelu_validointi-1]) `r round(ammattiasema[1, "Pros"], digits = 1)` prosenttia (n = `r ammattiasema[1, "Freq"]`) olivat pelastajia, `r round(ammattiasema[2, "Pros"], digits = 1)` prosenttia (n = `r ammattiasema[2, "Freq"]`) olivat ensihoitajia ja `r round(ammattiasema[3, "Pros"], digits = 1)` prosenttia (n = `r ammattiasema[3, "Freq"]`) ilmoittivat muun ammattiryhmän.

[^kohtelu_validointi-1]: Operatiiviseen henkilöstöön kuuluvat sekä suorittava henkilöstö (pelastajat, ensihoitajat) että alin johto (ryhmänjohtajat). Alin johto ei kuitenkaan kyselyvirheen takia vastanneet kysymykseen suorittavalle henkilöstölle. Tämän takia määrät ja prosenttiosuudet eivät vastaa todellisia. Prosenttiosuudet on laskettu käsin jakamalla kunkin ryhmän osiot oikealla otoskoolla (n = 428 operatiivista henkilöstöä - 70 alinta johtoa = 358 suorittavaa henkilöstöä **KORJAA**).

Kohderyhmätaulukon mukaisesti pelastajien osuus pelastuslaitosten henkilöstöstä on noin 49,4 prosenttia, ensihoitajien osuus noin 42,0 prosenttia ja muun henkilöstön osuus noin 8,6 prosenttia. Otoksessamme ensihoitajat ovat lievästi yliedustettuna ja pelastajat vastaavasti aliedustettuna, muun henkilöstön osuus vastaa käytännössä populaation osuutta.

```{r}
#| label: kohtelu_validointi-05-taustamuuttujat
#| code-summary: "Kieliversio"

kieli <- data |>
  select(Kieliversio) |>
  mutate(
    Kieliversio = factor(
      Kieliversio,
      labels = c(
        "Suomi",
        "Ruotsi"
      )
    )
  ) |>
  table() |>
  as.data.frame() |>
  mutate(
    Pros = (Freq / nrow(data)) * 100
  )
  
```

Vastaajista `r round(kieli[1, "Pros"], digits = 1)` prosenttia (n = `r kieli[1, "Freq"]`) vastasivat suomeksi ja `r round(kieli[2, "Pros"], digits = 1)` prosenttia (n = `r kieli[2, "Freq"]`) vastasivat ruotsiksi. Vastauskieli ei välttämättä edusta äidinkielen tai käytetyn kielen jakautumista kohdepopulaatiossa.

```{r}
#| label: kohtelu_validointi-06-taustamuuttujat
#| code-summary: "Yhteydenottomenetelmät"

yhteydenotto <- data |>
  select(Linkkiversio) |>
  mutate(
    Linkkiversio = factor(
      Linkkiversio,
      labels = c(
        "Johdon kautta",
        "Henkilöstön kautta",
        "Median kautta"
      )
    )
  ) |>
  table() |>
  as.data.frame() |>
  mutate(
    Pros = (Freq / nrow(data)) * 100
  )
  
```

Vastaajista `r round(yhteydenotto[1, "Pros"], digits = 1)` prosenttia (n = `r yhteydenotto[1, "Freq"]`) vastasivat johdon kautta välitettyyn linkkiin, `r round(yhteydenotto[2, "Pros"], digits = 1)` prosenttia (n = `r yhteydenotto[2, "Freq"]`) vastasivat yhteyshenkilöiden tai toimistojen kautta välitettyyn linkkiin, ja `r round(yhteydenotto[3, "Pros"], digits = 1)` prosenttia (n = `r yhteydenotto[3, "Freq"]`) vastasivat median kautta välitettyyn linkkiin.

```{r}
#| label: tbl-kohtelu_validointi-07-kohtelu
#| tbl-cap: "Epäasiallisen ja väkivaltaisen kohtelun muuttujien keskiarvot, mediaanit, keskihajonnat ja validit otoskoot"
#| code-summary: "Kohtelun avainluvut"

# Korjataan muuttujien järjestys putkessa myöhemmin
jarjestys <- c(
  "k3_1", "k3_2", "k3_3", "k3_4", "k3_5", "k3_6", "k3_7",
  "k4_1", "k4_2", "k4_3", "k4_4", "k4_5", "k4_6", "k4_7",
  "k12_1", "k12_2", "k12_3", "k12_4", "k12_5", "k12_6", "k12_7",
  "k13_1", "k13_2", "k13_3", "k13_4", "k13_5", "k13_6", "k13_7"
)

kohtelu <- data |>
  select(k3_1:k4_7, k12_1:k13_7) |>
  summarise(
    across(
      everything(),
      list(
        mean = ~ round(mean(.x, na.rm = TRUE), digits = 2),
        sd = ~ round(sd(.x, na.rm = TRUE), digits = 2),
        skew = ~ round(skewness(.x, na.rm = TRUE), digits = 2),
        kurtosis = ~ round(kurtosis(.x, na.rm = TRUE), digits = 2),
        n = ~ sum(!is.na(.x))
      )
    )
  ) |>
  pivot_longer(
    cols = everything(),
    names_to = c("variable", "statistic"),
    names_pattern = "^(.*_\\d+)_(.*)$"
  ) |>
  pivot_wider(
    names_from = statistic,
    values_from = value
  ) |>
  arrange(
    factor(variable, levels = jarjestys)
  )

colnames(kohtelu) <- c("Muuttuja", "Keskiarvo", "Keskihajonta", "Vinous", "Huipukkuus", "Validi N")

kohtelu |>
  knitr::kable()

```

```{r}
#| label: fig-kohtelu_validointi-08-kohtelukorrelaatio
#| fig-cap: "Epäasiallisen ja väkivaltaisen kohtelun mittareiden korrelaatiomatriisi. Pearsonin tulomomenttikorrelaatiokerroin, Holm-muunnetut merkitsevyysarvot. Risti esittää 5 % alfatason ylittymistä, mustat viivat erottavat muuttujat neljään muuttujaryhmään kyselyssä mitatun tekokontekstin ja kohteen mukaisesti."
#| code-summary: "Kohtelun korrelaatiomatriisi"

kohtelu_korr <- data |>
  select(k3_1:k4_7, k12_1:k13_7) |>
  cor(method = "pearson", use = "pairwise.complete.obs")

data |>
  select(k3_1:k4_7, k12_1:k13_7) |>
  ggcorrmat(
    ggcorrplot.args = list(lab_size = 1, tl.cex = 7, tl.srt = 90)
  ) +
  geom_vline(xintercept = 7.5, color = "black", size = 0.5) +
  geom_vline(xintercept = 14.5, color = "black", size = 0.5) +
  geom_vline(xintercept = 21.5, color = "black", size = 0.5) +
  geom_hline(yintercept = 6.5, color = "black", size = 0.5) +
  geom_hline(yintercept = 13.5, color = "black", size = 0.5) +
  geom_hline(yintercept = 20.5, color = "black", size = 0.5)

```

Epäasiallisen ja väkivaltaisen kohtelun mittarit näyttävät korreloivan kahdessa osiossa: organisaatiosisäiset mittarit korreloivat toistensa kanssa merkitsevästi ja keskikokoisilla tai jopa suurilla kerroimilla, ja sama koskee organisaatioulkoisia mittareita. Mittarit korreloivat keskenään kuitenkin heikommin ja useammin ei-merkitsevästi, kuten näkyy korrelelogramin ylävasemmasta kulmasta (@fig-kohtelu_validointi-08-kohtelukorrelaatio).

Korrelaatioiden vahvuudet vaihtelevat välillä $r = `r min(kohtelu_korr[lower.tri(kohtelu_korr)])` - `r max(kohtelu_korr[lower.tri(kohtelu_korr)])`$. Pääsääntöisesti korrelaatiot ovat positiivisia. Korrelaatiomatriisin determinantti on $\det A = `r det(kohtelu_korr)`$.

```{r}
#| label: tbl-kohtelu_validointi-09-uupumus
#| tbl-cap: "BAT 4-menetelmän työuupumuksen muuttujien keskiarvot, mediaanit, keskihajonnat ja validit otoskoot"
#| code-summary: "Työuupumuksen avainluvut"

# Korjataan muuttujien järjestys putkessa myöhemmin
jarjestys <- c("k27_1", "k27_2", "k27_3", "k27_4")

uupumus <- data |>
  select(k27_1:k27_4) |>
  summarise(
    across(
      everything(),
      list(
        mean = ~ round(mean(.x, na.rm = TRUE), digits = 2),
        sd = ~ round(sd(.x, na.rm = TRUE), digits = 2),
        skew = ~ round(skewness(.x, na.rm = TRUE), digits = 2),
        kurtosis = ~ round(kurtosis(.x, na.rm = TRUE), digits = 2),
        n = ~ sum(!is.na(.x))
      )
    )
  ) |>
  pivot_longer(
    cols = everything(),
    names_to = c("variable", "statistic"),
    names_pattern = "^(.*_\\d+)_(.*)$"
  ) |>
  pivot_wider(
    names_from = statistic,
    values_from = value
  ) |>
  arrange(
    factor(variable, levels = jarjestys)
  )

colnames(uupumus) <- c("Muuttuja", "Keskiarvo", "Keskihajonta", "Vinous", "Huipukkuus", "Validi N")

uupumus |>
  knitr::kable()

```

```{r}
#| label: fig-kohtelu_validointi-10-uupumuskorrelaatio
#| fig-cap: "BAT 4-menetelmän työuupumuksen mittareiden korrelaatiomatriisi. Pearsonin tulomomenttikorrelaatiokerroin, Holm-muunnetut merkitsevyysarvot. Risti esittää 5 % alfatason ylittymistä."
#| code-summary: "Työuupumuksen korrelaatiomatriisi"

uupumus_korr <- data |>
  select(k27_1:k27_4) |>
  cor(method = "pearson", use = "pairwise.complete.obs")

data |>
  select(k27_1:k27_4) |>
  ggcorrmat()

```

Korrelaatiot ovat kaikki merkitsevästi positiivisia ja vaihtelevat välillä $r = `r min(uupumus_korr[lower.tri(uupumus_korr)])` - `r max(uupumus_korr[lower.tri(uupumus_korr)])`$. Korrelaatiomatriisin determinantti on $\det A = `r det(uupumus_korr)`$.

```{r}
#| label: kohtelu_validointi-11-puuttuviendata
#| code-summary: "Puuttuvien vastausten koodaus"

valitut <- data |>
  select(k3_1:k4_7, k12_1:k13_7)

puuttuvat_valitut <- data |>
  select(k3_1:k4_7, k12_1:k13_7, k2, k40, Kieliversio, Linkkiversio) |>
  mutate(
    across(
      k3_1:k13_7,
      ~ case_match(
        .x,
        NA ~ 1,
        .default = 0
      )
    )
  )

```

```{r}
#| label: kohtelu_validointi-12-kuvailevattallennus
#| code-summary: "Kuvailevien tulosten tallennus omiin tiedostoihin"

# Kuvailevat mitat esiintyvyys- ja työuupumusmittareille
write.csv2(
  x = bind_rows(kohtelu, uupumus),
  file = "output/validointiartikkeli_kuvailevatmitat.csv"
)

# Kovarianssi- ja keskiarvomatriisi
matriisi <- data |>
  select(k3_1:k4_7, k12_1:k13_7, k27_1:k27_4) |>
  cov(
    use = "pairwise.complete.obs",
    method = "pearson"
  )

matriisi[upper.tri(matriisi, diag = TRUE)] <- NA
ka <- data |>
  select(k3_1:k4_7, k12_1:k13_7, k27_1:k27_4) |>
  summarise(
    across(
      everything(),
      ~ mean(.x, na.rm = TRUE)
    )
  ) |>
  as.numeric()
matriisi <- rbind(matriisi, ka)

write.csv2(
  x = matriisi,
  file = "output/validointiartikkeli_matriisi.csv"
)


```

::: panel-tabset
### Puuttuvien arvojen määrä

```{r}
#| label: fig-kohtelu_validointi-13-kohtelupuuttuvat
#| fig-cap: "Epäasiallisen ja väkivaltaisen kohtelun muuttujien puuttuvien arvojen määrät"
#| code-summary: "Määrien tulostaminen"

gg_miss_var(valitut)

```

### Puuttuvien arvojen piirteet

```{r}
#| label: fig-kohtelu_validointi-14-kohteluupset
#| fig-cap: "Epäasiallisen ja väkivaltaisen kohtelun muuttujien puuttuvien arvojen piirreanalyysi"
#| code-summary: "Kuvion piirtäminen"

gg_miss_upset(
  valitut,
  nsets = 28,
  point.size = 1.0,
  text.scale = 0.5
)

```
:::

Puuttuvia arvoja esiintyy eniten organisaation ulkopuolelta tulleen kollegahavaintojen muuttujien ryhmässä (@fig-kohtelu_validointi-13-kohtelupuuttuvat). Vähiten esiintyy vastaavasti organisaation sisällä omakohtaisten kokemusten ryhmässä.

Upset-kuvio (@fig-kohtelu_validointi-14-kohteluupset) osoittaa, että kun organisaatiosisäisillä muuttujilla puuttuu vastaus, puute heijastuu usein muihin organisaatiosisäisiin muuttujiin. Samalla tavalla organisaatioulkoisten muuttujien puute heijastuu toisiin organisaatioulkoisiin muuttujiin.

```{r}
#| label: tbl-kohtelu_validointi-15-mcar
#| tbl-cap: "Littlen MCAR-testi, epäasiallisen ja väkivaltaisen kohtelun muuttujat (k = 28)"
#| code-summary: "Littlen MCAR-testi"

valitut |>
  mcar_test() |>
  knitr::kable()

```

Littlen MCAR-testi on merkitsevä, osoittaen, että puuttuvat vastaukset mitä luultavammin eivät ole täysin satunnaisesti puuttuvia (engl. *missing completely at random*) (p \< .05). Merkitsevyys voi osittain johtua suuresta otoskoosta, mutta todisteet osoittaisivat kuitenkin, että puuttuvissa vastauksissa on jonkin tapaista systematiikkaa.

```{r}
#| label: tbl-kohtelu_validointi-16-khii-kohderyhmat
#| tbl-cap: "Epäasiallisen ja väkivaltaisen kohtelun muuttujat kohderyhmittäin, frekvenssitaulukko ja khii neliö -testin tulokset (vertailu riveittäin sarakkeiden välillä)"
#| code-summary: "Kohtelun puuttuvien arvojen vertailu kohderyhmien välillä"

data_long <- puuttuvat_valitut |>
  pivot_longer(
    cols = k3_1:k13_7,
    names_to = "variable",
    values_to = "value"
  )

kontingenssi <- data_long |>
  filter(value == 1) |>
  group_by(variable, k2) |>
  summarise(count = n(), .groups = "drop") |>
  pivot_wider(
    names_from = k2,
    values_from = count,
    values_fill = 0
  )

khiinelio <- data_long |>
  group_by(variable) |>
  summarise(
    khii2 = list(
      chisq.test(table(value, k2))
    ),
    .groups = "drop"
  ) |>
  mutate(
    p = map_dbl(khii2, ~ .x$p.value),
    khii2 = map_dbl(khii2, ~ .x$statistic)
  ) |>
  select(variable, p, khii2)

vrt.kohderyhmat <- left_join(kontingenssi, khiinelio, by = "variable")

write.csv2(vrt.kohderyhmat, file = "output/khii_kohderyhmat.csv")

knitr::kable(vrt.kohderyhmat)

```

[Taulukon -@tbl-kohtelu_validointi-16-khii-kohderyhmat] mukaan useimpien muuttujien puuttuvien arvojen määrät eivät eroa kohderyhmien välillä merkitsevästi. Poikkeuksena ovat muuttujat `k12_1` ja `k4_7`, eli organisaatioulkoisen omakohtaisesti koetun verbaalisen väkivallan sekä organisaatiosisäisen kollegahavaitun syrjinnän muuttujat. On kuitenkin huomattava, että määrät ovat hyvin pieniä, ja käytännössä jokainen testi sisältää odotettuja soluja, joiden koot ovat alle 5 havaintoa, jolloin khii neliö -testi ei ole luotettava riippuvuustesti.

```{r}
#| label: tbl-kohtelu_validointi-17-khii-ammattiryhma
#| tbl-cap: "Epäasiallisen ja väkivaltaisen kohtelun muuttujat ammattiryhmittäin, frekvenssitaulukko ja khii neliö -testin tulokset (vertailu riveittäin sarakkeiden välillä)"
#| code-summary: "Kohtelun puuttuvien arvojen vertailu ammattiryhmien välillä"

data_long <- puuttuvat_valitut |>
  filter(between(k40, 1, 2)) |>
  pivot_longer(
    cols = k3_1:k13_7,
    names_to = "variable",
    values_to = "value"
  )

kontingenssi <- data_long |>
  filter(value == 1) |>
  group_by(variable, k40) |>
  summarise(count = n(), .groups = "drop") |>
  pivot_wider(
    names_from = k40,
    values_from = count,
    values_fill = 0
  )

khiinelio <- data_long |>
  group_by(variable) |>
  summarise(
    khii2 = list(
      chisq.test(table(value, k40))
    ),
    .groups = "drop"
  ) |>
  mutate(
    p = map_dbl(khii2, ~ .x$p.value),
    khii2 = map_dbl(khii2, ~ .x$statistic)
  ) |>
  select(variable, p, khii2)

vrt.ammattiryhmat <- left_join(kontingenssi, khiinelio, by = "variable")

write.csv2(vrt.ammattiryhmat, file = "output/khii_ammattiryhmat.csv")

knitr::kable(vrt.ammattiryhmat)

```

[Taulukon -@tbl-kohtelu_validointi-17-khii-ammattiryhma] mukaan mikään muuttuja ei eroa merkitsevästi puuttuvien vastausten määrässä pelastajien ja ensihoitajien välillä. Puuttuvia arvoja on hyvin vähän, joten khii neliö-testit eivät ole luotettavia, mutta puuttuminen ei myöskään oletettavasti aiheuta haittaa mallille myöhemmässä vaiheessa.

```{r}
#| label: tbl-kohtelu_validointi-18-khii-kieli
#| tbl-cap: "Epäasiallisen ja väkivaltaisen kohtelun muuttujat kyselyn kielen mukaan, frekvenssitaulukko ja khii neliö -testin tulokset (vertailu riveittäin sarakkeiden välillä)"
#| code-summary: "Kohtelun puuttuvien arvojen vertailu kyselyn kielten välillä"

data_long <- puuttuvat_valitut |>
  pivot_longer(
    cols = k3_1:k13_7,
    names_to = "variable",
    values_to = "value"
  )

kontingenssi <- data_long |>
  filter(value == 1) |>
  group_by(variable, Kieliversio) |>
  summarise(count = n(), .groups = "drop") |>
  pivot_wider(
    names_from = Kieliversio,
    values_from = count,
    values_fill = 0
  )

khiinelio <- data_long |>
  group_by(variable) |>
  summarise(
    khii2 = list(
      chisq.test(table(value, Kieliversio))
    ),
    .groups = "drop"
  ) |>
  mutate(
    p = map_dbl(khii2, ~ .x$p.value),
    khii2 = map_dbl(khii2, ~ .x$statistic)
  ) |>
  select(variable, p, khii2)

vrt.kieli <- left_join(kontingenssi, khiinelio, by = "variable")

write.csv2(vrt.kieli, file = "output/khii_kieli.csv")

knitr::kable(vrt.kieli)

```

[Taulukon -@tbl-kohtelu_validointi-18-khii-kieli] mukaan mikään muuttuja ei eroa merkitsevästi puuttuvien vastausten määrässä suomen- ja ruotsinkielisen kyselyn täyttäneiden välillä. Puuttuvia arvoja on hyvin vähän varsinkin ruotsinkielisen version täyttäneiden kesken, joten khii neliö-testit eivät ole luotettavia, mutta puuttuminen ei myöskään oletettavasti aiheuta haittaa mallille myöhemmässä vaiheessa.

```{r}
#| label: tbl-kohtelu_validointi-19-khii-yhteydenotto
#| tbl-cap: "Epäasiallisen ja väkivaltaisen kohtelun muuttujat yhteydenottomenetelmien mukaan, frekvenssitaulukko ja khii neliö -testin tulokset (vertailu riveittäin sarakkeiden välillä)"
#| code-summary: "Kohtelun puuttuvien arvojen vertailu yhteydenottomenetelmien välillä"

data_long <- puuttuvat_valitut |>
  pivot_longer(
    cols = k3_1:k13_7,
    names_to = "variable",
    values_to = "value"
  )

kontingenssi <- data_long |>
  filter(value == 1) |>
  group_by(variable, Linkkiversio) |>
  summarise(count = n(), .groups = "drop") |>
  pivot_wider(
    names_from = Linkkiversio,
    values_from = count,
    values_fill = 0
  )

khiinelio <- data_long |>
  group_by(variable) |>
  summarise(
    khii2 = list(
      chisq.test(table(value, Linkkiversio))
    ),
    .groups = "drop"
  ) |>
  mutate(
    p = map_dbl(khii2, ~ .x$p.value),
    khii2 = map_dbl(khii2, ~ .x$statistic)
  ) |>
  select(variable, p, khii2)

vrt.yhteydenotto <- left_join(kontingenssi, khiinelio, by = "variable")

write.csv2(vrt.yhteydenotto, file = "output/khii_yhteydenotto.csv")

knitr::kable(vrt.yhteydenotto)

```

[Taulukon -@tbl-kohtelu_validointi-19-khii-yhteydenotto] mukaan mikään muuttuja ei eroa merkitsevästi puuttuvien vastausten määrässä yhteydenottomenetelmien välillä.

## Osatutkimus 1: Mittariston faktorirakenne {#sec-kohtelu_validointi-osatutkimus1}

```{r}
#| label: kohtelu_validointi-20-satunnaisotanta
#| code-summary: "Satunnaisotanta"

set.seed(987320)
otos <- sample(c(1, 2), replace = TRUE, nrow(data), prob = c(0.3, 0.7))
data <- data |>
  add_column(
    otos = otos,
    .after = "ID"
  )

data.efa <- data |>
  filter(otos == 1)

data.cfa <- data |>
  filter(otos == 2)

```

```{r}
#| label: kohtelu_validointi-21-efasopivuustestit
#| code-summary: "EFA-mallin sopivuustestit"

# Mahalanobiksen etäisyys ja merkitsevyys
data.efa$mahalanobis <- mahalanobis(
  x = data.efa |> select(k3_1:k4_7, k12_1:k13_7),
  center = data.efa |> select(k3_1:k4_7, k12_1:k13_7) |> colMeans(na.rm = TRUE),
  cov = data.efa |> select(k3_1:k4_7, k12_1:k13_7) |> cov(use = "pairwise.complete.obs", method = "pearson")
)
data.efa$mahalanobis.p <- data.efa |>
  select(mahalanobis) |>
  unlist() |>
  as.double() |>
  pchisq(
    df = data.efa |> select(k3_1:k4_7, k12_1:k13_7) |> ncol() - 1
  )

# Kerätään kaikki tulokset yhteen listaan
tulokset.efa.sopivuus <- list()

# Mahalanobiksen pohjalta poistettavat vastaajat
tulokset.efa.sopivuus$poisto_n <- data.efa |>
  filter(mahalanobis.p < .001) |>
  summarise(n()) |>
  as.numeric()

# Bartlettin testi
tulokset.efa.sopivuus$bart <- data.efa |>
  select(k3_1:k4_7, k12_1:k13_7) |>
  BARTLETT()

# KMO-suure
tulokset.efa.sopivuus$kmosuure <- data.efa |>
  select(k3_1:k4_7, k12_1:k13_7) |>
  KMO()

# Korrelaatiomatriisin determinantti
tulokset.efa.sopivuus$determinantti <- data.efa |>
  select(k3_1:k4_7, k12_1:k13_7) |>
  cor(method = "pearson", use = "pairwise.complete.obs") |>
  det()

# VIF-arvot
tulokset.efa.sopivuus$vif <- data.efa |>
  select(k3_1:k4_7, k12_1:k13_7) |>
  vif()

# Hullin menetelmä
tulokset.efa.sopivuus$hull <- data.efa |>
  select(k3_1:k4_7, k12_1:k13_7) |>
  HULL(
    method = "ML",
    eigentype = "SMC",
    decision_rule = "percentile"
  )

```

Mahalanobiksen etäisyyden merkitsevyystestaus (p \< .001) osoittaa, että yhteensä `r tulokset.efa.sopivuus$poisto_n` vastaajaa pitäisi poistaa mallista.

KMO-suureen koko on `r tulokset.efa.sopivuus$kmosuure$KMO`.

Bartlettin testi on merkitsevä ($\chi^2 = `r tulokset.efa.sopivuus$bart$chisq`, \text{df} = `r tulokset.efa.sopivuus$bart$df`, p = `r tulokset.efa.sopivuus$bart$p_value`$).

Korrelaatiomatriisin determinantti on `r tulokset.efa.sopivuus$determinantti`.

Kolmella muutujalla on VIF-suureet yli 10: `k12_1`, `k13_1` ja `k13_6`. Näiden lisäksi muuttuja `k12_3` on yli 9, eli lähellä raja-arvoa.

Hullin menetelmän tulokset riippuvat käytetystä sopivuusindeksistä. CAF-indeksi ehdottaa `r tulokset.efa.sopivuus$hull$n_fac_CAF` faktoria, CFI ehdottaa `r tulokset.efa.sopivuus$hull$n_fac_CFI` faktoria ja RMSEA ehdottaa `r tulokset.efa.sopivuus$hull$n_fac_RMSEA` faktoria.

Tulokset osoittavat kolmea suurempaa ongelmaa: Mahalanobiksen etäisyyden mukaan noin kolmannes vastaajista pitäisi poistaa mallista, Hullin menetelmän tulokset ovat osittain ristiriitaisia ja ehdottavat joko yhtä tai kahta faktoria, ja korrelaatiomatriisin determinantti on koko aineistolle liian pieni ja osoittaa multikollineariteettia.

Jos vertaamme determinanttiongelmaa aikaisemmin tarkistettuun korrelaatiomatriisiin (@fig-kohtelu_validointi-08-kohtelukorrelaatio), ongelmallisia korrelaatioita (r \> 0.8) esiintyy vain organisaatioulkoisten muuttujien ryhmässä. Suurimpana ongelmana on omakohtaisesti koettujen ja kollegan kautta havaittujen kohtelujen korrelaatioissa, jossa suurin korrelaatio on jopa r = 0.84.

Tarkistimme, jos ongelma johtuu ensisijaisesti organisaatioulkoisten muuttujien tekokontekstiryhmien välisistä korrelaatioista poistamalla kollegan kautta havaitut muuttujat analyysista.

```{r}
#| label: kohtelu_validointi-22-efasopivuustestit
#| code-summary: "EFA-mallin sopivuustestit, vain omakohtaisesti koettu kohtelu"

# Tehdään uusi df testausta varten
data.efa2 <- data.efa

# Mahalanobiksen etäisyys ja merkitsevyys
data.efa2$mahalanobis <- mahalanobis(
  x = data.efa2 |> select(k3_1:k3_7, k12_1:k12_7),
  center = data.efa2 |> select(k3_1:k3_7, k12_1:k12_7) |> colMeans(na.rm = TRUE),
  cov = data.efa2 |> select(k3_1:k3_7, k12_1:k12_7) |> cov(use = "pairwise.complete.obs", method = "pearson")
)
data.efa2$mahalanobis.p <- data.efa2 |>
  select(mahalanobis) |>
  unlist() |>
  as.double() |>
  pchisq(
    df = data.efa2 |> select(k3_1:k3_7, k12_1:k12_7) |> ncol() - 1
  )

# Kerätään kaikki tulokset yhteen listaan
tulokset.efa2.sopivuus <- list()

# Mahalanobiksen pohjalta poistettavat vastaajat
tulokset.efa2.sopivuus$poisto_n <- data.efa2 |>
  filter(mahalanobis.p < .001) |>
  summarise(n()) |>
  as.numeric()

# Bartlettin testi
tulokset.efa2.sopivuus$bart <- data.efa2 |>
  select(k3_1:k3_7, k12_1:k12_7) |>
  BARTLETT()

# KMO-suure
tulokset.efa2.sopivuus$kmosuure <- data.efa2 |>
  select(k3_1:k3_7, k12_1:k12_7) |>
  KMO()

# Korrelaatiomatriisin determinantti
tulokset.efa2.sopivuus$determinantti <- data.efa2 |>
  select(k3_1:k3_7, k12_1:k12_7) |>
  cor(method = "pearson", use = "pairwise.complete.obs") |>
  det()

# VIF-arvot
tulokset.efa2.sopivuus$vif <- data.efa2 |>
  select(k3_1:k3_7, k12_1:k12_7) |>
  vif()

# Hullin menetelmä
tulokset.efa2.sopivuus$hull <- data.efa2 |>
  select(k3_1:k3_7, k12_1:k12_7) |>
  HULL(
    method = "ML",
    eigentype = "SMC",
    decision_rule = "percentile"
  )

```

Mahalanobiksen etäisyyden merkitsevyystestaus (p \< .001) osoittaa, että yhteensä `r tulokset.efa2.sopivuus$poisto_n` vastaajaa pitäisi poistaa mallista.

KMO-suureen koko on `r tulokset.efa2.sopivuus$kmosuure$KMO`.

Bartlettin testi on merkitsevä ($\chi^2 = `r tulokset.efa2.sopivuus$bart$chisq`, \text{df} = `r tulokset.efa2.sopivuus$bart$df`, p = `r tulokset.efa2.sopivuus$bart$p_value`$).

Korrelaatiomatriisin determinantti on `r tulokset.efa2.sopivuus$determinantti`.

Kaikkien muuttujien VIF-suureet ovat alle 10. Suurin VIF-suure on muuttujalla `k12_1` (VIF = `r tulokset.efa2.sopivuus$vif[["k12_1"]]`).

Hullin menetelmän tulokset riippuvat käytetystä sopivuusindeksistä. CAF-indeksi ehdottaa `r tulokset.efa2.sopivuus$hull$n_fac_CAF` faktoria, CFI ehdottaa `r tulokset.efa2.sopivuus$hull$n_fac_CFI` faktoria ja RMSEA ehdottaa `r tulokset.efa2.sopivuus$hull$n_fac_RMSEA` faktoria.

Koska tulokset osoittavat useita eri ristiriitoja, päätimme ajaa yhteensä 4 eri mallia kahdessa ryhmässä. Mallit 1A ja 1B käyttävät kaikkia 28 muuttujaa. Mallit 2A ja 2B käyttävät vain omakohtaisesti koettuja kokemuksia, eli 14 muuttujaa. A-malleissa sovitimme yhden faktorin mallin kaikille vastaajille (Mallit 1A, 2A) ja B-malleissa sovitimme kahden faktorin mallin kaikille vastaajille (Mallit 1B, 2B).

```{r}
#| label: kohtelu_validointi-23-efamallit
#| code-summary: "EFA-mallit"

efa.malli.1A <- data.efa |>
  select(k3_1:k4_7, k12_1:k13_7) |>
  efa(
    nfactors = 1,
    rotation = "oblimin",
    estimator = "ML",
    missing = "fiml"
  )

yhteenveto.efa.1A <- summary(
  efa.malli.1A,
  fit.measures = TRUE,
  ci = TRUE,
  efa = TRUE,
  cutoff = 0
)

efa.malli.1B <- data.efa |>
  select(k3_1:k4_7, k12_1:k13_7) |>
  efa(
    nfactors = 2,
    rotation = "oblimin",
    estimator = "ML",
    missing = "fiml"
  )

yhteenveto.efa.1B <- summary(
  efa.malli.1B,
  fit.measures = TRUE,
  ci = TRUE,
  efa = TRUE,
  cutoff = 0
)

efa.malli.2A <- data.efa2 |>
  select(k3_1:k3_7, k12_1:k12_7) |>
  efa(
    nfactors = 1,
    rotation = "oblimin",
    estimator = "ML",
    missing = "fiml"
  )

yhteenveto.efa.2A <- summary(
  efa.malli.2A,
  fit.measures = TRUE,
  ci = TRUE,
  efa = TRUE,
  cutoff = 0
)

efa.malli.2B <- data.efa2 |>
  select(k3_1:k3_7, k12_1:k12_7) |>
  efa(
    nfactors = 2,
    rotation = "oblimin",
    estimator = "ML",
    missing = "fiml"
  )

yhteenveto.efa.2B <- summary(
  efa.malli.2B,
  fit.measures = TRUE,
  ci = TRUE,
  efa = TRUE,
  cutoff = 0
)

```

::: panel-tabset
### Malli 1A

```{r}
#| label: kohtelu_validointi-24-efa1

yhteenveto.efa.1A

```

### Malli 1B

```{r}
#| label: kohtelu_validointi-25-efa2

yhteenveto.efa.1B

```

### Malli 2A

```{r}
#| label: kohtelu_validointi-26-efa3

yhteenveto.efa.2A

```

### Malli 2B

```{r}
#| label: kohtelu_validointi-27-efa4

yhteenveto.efa.2B

```
:::

28 muuttujan mallit istuvat huonommin kuin 14 muuttujan mallit. Yhden faktorin mallit (A-mallit) istuvat aina huonommin kuin kahden faktorin mallit (B-mallit), ottaen huomioon myös faktorin lisäämisestä nousseen seliteasteen.

Seliteasteet yhden faktorin malleilla ovat noin kolmannes kaikesta varianssista, kahden faktorin malleilla noin 50 prosenttia.

Kahden faktorin malleissa faktorien välinen korrelaatio on noin 0,37-0,38 (merkitsevä 1 % alfatasolla).

Muuttuja `k3_5` (organisaatiosisäisesti koettu seksuaalinen häirintä tai väkivalta) ei tahdo asettua kahden faktorin malleissa selkeästi. Malli 1B:ssä muuttuja lataa merkitsevästi molemmille faktoreille, mutta latauskoko on alle 0,3 molemmissa tapauksissa. Malli 2B:ssä muuttuja lataa molemmille faktoreille, mutta vain ensimmäiselle faktorille yli 0,3.

Kokonaisuudessaan parhaiten sopiva malli on Malli 2B (14 omakohtaisen kokemuksen muuttujaa, kaksi faktoria). Teoreettisista syistä näemme, että muuttuja `k3_5` (organisaatiosisäisesti koettu seksuaalinen häirintä tai väkivalta) asettuu ensimmäiseen faktoriin, vaikka lataus ovat epäselvä. Heikot lataukset voivat osittain johtua pienestä varianssista. Muuttuja `k12_7` tulisi myös asettua faktorille `f2`, vaikka sen lataus on kuta kuinkin sama molemmille faktoreilla.

On kuitenkin huomattava, että sopivuusindeksit eivät ole varsin hyviä. Mallin CFI-suure on 0,887 (alle yleisen raja-arvon 0,95) ja RMSEA on 0,119 (yli yleisen raja-arvon 0,05).

Jatkamme toiseen osatutkimukseen seuraavalla mallilla:

1.  Malliin sisältyy 14 muuttujaa, jotka mittaavat omakohtaisesti koettua epäasiallista ja väkivaltaista kohtelua.
2.  14 muuttujasta 7 muuttujaa mittaavat kokemuksia organisaation sisäisesti, ja 7 muuttujaa organisaation ulkoisesti.
3.  Muuttujat lataavat kahdelle faktorille: Organisaatiosisäiset kokemukset ja organisaatioulkoiset kokemukset.
4.  Muuttujat eivät ristilataa faktoreiden välillä ollenkaan.
5.  Latausten kokoja ei ennalta määritellä.
6.  Faktorit korreloivat toistensa kanssa vapaasti.
7.  Muuttujien välisiä residuaalikorrelaatioita rajataan nollaan.
8.  Molempien faktorien mittatasot asetetaan ensimmäisen muuttujan mukaan (verbaalinen väkivalta).

## Eksploratiivinen analyysi: Noudatetaan Mahalanobiksen etäisyyden ehdotusta Malli 2B:ssä

```{r}
#| label: kohtelu_validointi-28-efamahalanobiksenmukaan
#| code-summary: "Mallin rakentaminen"

efa.malli.2Bekspl <- data.efa2 |>
  filter(mahalanobis.p > 0.001) |>
  select(k3_1:k3_7, k12_1:k12_7) |>
  efa(
    nfactors = 2,
    rotation = "oblimin",
    estimator = "ML",
    missing = "fiml"
  )

summary(
  efa.malli.2Bekspl,
  fit.measures = TRUE,
  ci = TRUE,
  efa = TRUE,
  cutoff = 0
)

```

Robustisuuden vuoksi kokeilimme jättää pois Mahalanobiksen etäisyystestin rikkoneet vastaajat. Sovitimme sitten EFA-mallin 2B käyttäen samoja asetuksia kuin aikaisemmin.

Mallin sopivuus on käytännössä sama. AIC- ja BIC-arvot tippuvat reilusti, mutta CFI- ja RMSEA-indeksit pysyvät samoissa tasoissa.

Faktorilataukset pysyvät kuta kuinkin samoilla tasoilla. Faktorilla `f1` muutokset vaihtelevat välillä $-0.049, 0.125$. Faktorilla `f2` muutokset vaihtelevat välillä $-0.059, 0.040$. Keskivertomuutokset ovat kuitenkin hyvin pieniä, $< .001 \text{( F1)}, -0.017 \text{ (F2)}$. Muuttujien latausten merkitsevyys pysyy samana.

Varianssiseliteaste laskee lievästi (aikaisempi $50.7\%$, nykyinen $46.5\%$). Suurin muutos on kuitenkin faktorikorrelaatioissa: aikaisempi korrelaatio oli $r = .369$ (merkitsevä 1 % alfatasolla), mutta vastaajien poisjättämisen myötä korrelaatio laskee tasolle $r = .175$ (ei merkitsevä).

## Eksploratiivinen analyysi: Syrjinnän poisjättö malli 2B:stä

Ulkoinen syrjintämuuttuja `k12_7` osoitti ongelmallisia latauksia molemmilla faktoreilla. Kokeilimme jättää muuttujan, sekä sen organisaatiosisäisen vastaavan parin `k3_7`, pois mallista.

```{r}
efa.malli.3 <- data.efa2 |>
  filter(mahalanobis.p > 0.001) |>
  select(k3_1:k3_6, k12_1:k12_6) |>
  efa(
    nfactors = 2,
    rotation = "oblimin",
    estimator = "ML",
    missing = "fiml"
  )

summary(
  efa.malli.3,
  fit.measures = TRUE,
  ci = TRUE,
  efa = TRUE,
  cutoff = 0,
  dot.cutoff = 0
)
```

Malli sopii paremmin, mutta ei vielä hyväksyttävästi ($\text{RMSEA} = .120, \text{CFI} = .893, \text{AIC} = 3462.5$).

Faktorin `f1` latausmuutokset vaihtelevat välillä $-.107, .147$. Faktorin `f2` latausmuutokset vaihtelevat välillä $-.070, .006$. Keskiarvomuutokset ovat kuitenkin matalia: $.022 \text{ (F1)}, -.026 \text{ (F2)}$. Toisin sanoen, muutokset vaihtelevat enemmän sisäisellä kuin ulkoisella faktorilla. Muuttujien latausten merkitsevyys ei muutu, eli muuttuja `k3_5` lataa vieläkin merkitsevästi molemmille muuttujille.

Kumulatiivinen varianssiaste laskee lievästi (aikaisempi $50.7\%$, nykyinen $48.4\%$). Faktorikorrelaatio laskee huomattavasti: aikaisemmin $r = .369$ (merkitsevä 1 % alfatasolla), nykyinen $r = .185$ (ei merkitsevä).

## Osatutkimus 2: Faktorirakenteen validiteetti ja invarianssi {#sec-kohtelu_validointi-osatutkimus2}

### Mallin estimointi

```{r}
#| label: kohtelu_validointi-29-cfamallimaaritelma
#| code-summary: "Malli 1:n määrittely"

# Käytetään pyöristettyjä faktoriarvoja EFA-mallista starttiarvoina, yrittääksemme korjata Heywood-tapauksen ongelman
# Vaputettu faktorikorrelaatio (0.3)
cfa.malli.1 <- '# latentit muuttujat
                f1 =~ start(0.8)*k3_1 + start(0.5)*k3_2 + start(0.7)*k3_3 + start(0.2)*k3_4 + start(0.2)*k3_5 + start(0.8)*k3_6 + start(0.7)*k3_7
                f2 =~ start(0.9)*k12_1 + start(0.6)*k12_2 + start(0.9)*k12_3 + start(0.8)*k12_4 + start(0.8)*k12_5 + start(0.8)*k12_6 + start(0.6)*k12_7
                
                # faktorikovarianssi
                f1 ~~ f2
                '
```

```{r}
#| label: kohtelu_validointi-30-cfamalli1
#| code-summary: "Malli 1:n estimointi"

malli.1 <- cfa(
  cfa.malli.1,
  data = data.cfa |> select(k3_1:k3_7, k12_1:k12_7),
  estimator = "MLR",
  missing = "fiml"
)

summary(malli.1, fit.measures = TRUE, standardized = TRUE, ci = TRUE)

```

### Dynaamisten raja-arvojen simulointi ja globaalin sopivuuden tarkastus

```{r}
#| label: kohtelu_validointi-31-rajaarvot
#| code-summary: "Dynaamisten raja-arvojen simulointi"
#| eval: false

likertHB(
  model = malli.1,
  data = data.cfa |> select(k3_1:k3_7, k12_1:k12_7),
  estimator = "MLR",
  reps = 100
)

```

Emme pysty simuloimaan raja-arvoja, sillä sisäisesti koetun fyysisen väkivallan muuttujalla on liian pieni varianssi. Simulaation tekemissä bootstrap-otoksissa syntyy tilanteita, joissa muuttujan varianssi on nolla, jolloin estimaattia ei voida laskea.

Dynaamisten raja-arvojen sijaan käytimme yleisesti hyväksyttyjä raja-arvoja: $\text{RMSEA} < .05, \text{CFI} > .95, \text{SRMR} < .08$ [@byrne1994].

Mallin robustit sopivuusindeksit ovat:

-   $\chi^2 = 244.4, \text{df} = 76, p < .001$
-   $\text{RMSEA} = .088 [90\% \text{ CI } .074, .102]$
-   $\text{CFI} = .913$
-   $\text{SRMR} = .073$

RMSEA- ja CFI-indeksit osoittavat, ettei malli sovi aineistoon. SRMR-indeksi täyttää hyväksyttävän sopivuuden rajan.

Kaikki mallissa määritetyt faktorilataukset ovat merkitseviä ($p < .001$).

Täysin standardisoitujen latauksien mukaan faktorilla `f1` pienin lataus on $b = .039 [.010, .069], \text{SD} = .015, \beta = .258$ (`k3_4`) ja suurin lataus on $b = 1.036 [.875, 1.197], \text{SD} = .095, \beta = .878$ (`k3_6`).

Samalla tavalla faktorilla `f2` pienin lataus on $b = .274 [.186, .362], \text{SD} = .045, \beta = .505$ (`k12_7`) ja suurin lataus on $b = .900 [\text{n/a}], \text{SD} = \text{n/a}, \beta = .921$ (`k12_1`).

Faktorien välinen estimoitu kovarianssi on $r = .246 [.115, .376], \text{SD} = .066$.

### Modifikaatioindeksit

```{r}
#| label: kohtelu_validointi-32-modifikaatioindeksit1
#| code-summary: "Modifikaatioindeksit, vain faktorilataukset"

modificationIndices(malli.1) |>
  arrange(desc(mi)) |>
  filter(op == "=~") |>
  rowwise() |>
  mutate(
    p = pchisq(.data$mi, df = 1, lower.tail = FALSE),
    p.holm = p.adjust(.data$p, method = "holm")
  ) |>
  ungroup() |>
  filter(p.holm < .05) |>
  select(lhs, op, rhs, mi, sepc.all, p.holm)

```

Tarkistimme ensin modifikaatioindeksit kaikille faktorilatausrajauksille. Laskimme Holm-korjatut p-arvot jokaiselle modifikaatioindeksille ja tarkastimme ne indeksit, jotka eroavat merkitsevästi nollasta.

Kuusi latausta aiheuttaisivat khii neliö -suureen merkitsevän laskun: muuttujien `k12_3`, `k12_4`, `k12_6` ja `k12_7` vapauttaminen faktorille `f1`, sekä muuttujien `k3_5` ja `k3_7` vapauttaminen faktorille `f2`.

```{r}
#| label: kohtelu_validointi-33-modifikaatioindeksit2
#| code-summary: "Modifikaatioindeksit, vain virhekorrelaatiot"

modificationIndices(malli.1) |>
  arrange(desc(mi)) |>
  filter(op == "~~") |>
  rowwise() |>
  mutate(
    p = pchisq(.data$mi, df = 1, lower.tail = FALSE),
    p.holm = p.adjust(.data$p, method = "holm")
  ) |>
  ungroup() |>
  filter(p.holm < .05) |>
  select(lhs, op, rhs, mi, sepc.all, p.holm)

```

Jopa 37 virhekorrelaatiota (41 prosenttia kaikista 91 virhekorrelaatiosta) aiheuttaisivat merkitsevän muutoksen globaalissa khii neliö -indeksissä.

Virhekorrelaatioiden suuri määrä johti meidät ajattelemaan, että faktorit eivät edusta aineistoa varsin hyvin. Suurimmat modifikaatioindeksit löytyvät usein samojen faktorien muuttujien väliltä (esim. `k12_4 ~~ k12_5`), mikä osoittaisi, ettei faktori onnistu kaappaamaan kaikkea muuttujien yhteiskorrelaatiota. Samanaikaisesti usea virhekorrelaatio kuitenkin myös esiintyy faktoreiden välillä (esim. `k3_1 ~~ k12_6`), eli myöskään faktorien välinen korrelaatio ei onnistu kaappaamaan muuttujien välistä korrelaatiota hyvin.

Tulosten pohjalta aloimme epäilemään mahdollista bifaktorirakennetta.

### Bifaktorimallin estimointi

```{r}
#| label: kohtelu_validointi-34-bifaktorimallimaaritelma
#| code-summary: "Bifaktorimallin määrittely"

cfa.malli.2  <- '# latentit muuttujat
                f1 =~ k3_1 + k3_2 + k3_3 + k3_4 + k3_5 + k3_6 + k3_7
                f2 =~ k12_1 + k12_2 + k12_3 + k12_4 + k12_5 + k12_6 + k12_7
                
                # yleinen faktori
                gen =~ k3_1 + k3_2 + k3_3 + k3_4 + k3_5 + k3_6 + k3_7 + k12_1 + k12_2 + k12_3 + k12_4 + k12_5 + k12_6 + k12_7
                
                # Heywood-tapauksen korjaaminen
                k3_1 ~~ 0*k3_1
                '

```

```{r}
#| label: kohtelu_validointi-35-bifaktorimalli
#| code-summary: "Bifaktorimallin estimointi"

malli.2 <- cfa(
  cfa.malli.2,
  data = data.cfa |> select(k3_1:k3_7, k12_1:k12_7),
  estimator = "MLR",
  missing = "fiml",
  orthogonal = TRUE
)

summary(malli.2, fit.measures = TRUE, standardized = TRUE, ci = TRUE)

```

Bifaktorimallin asettaminen tavallisin menetelmin aiheuttaa Heywood-tapauksen (muuttujan `k3_1` varianssi on negatiivinen). Ratkaisimme ongelman lukitsemalla muuttujan varianssin nollaan.

Mallin robustit globaalit sopivuusindeksit ovat:

-   $\chi^2 = 202.9, \text{df} = 64, p < .001$
-   $\text{RMSEA} = .083 [90\% \text{ CI } .068, .097]$
-   $\text{CFI} = .935$
-   $\text{SRMR} = .055$

Khii neliö-, RMSEA- ja CFI-indeksit osoittavat mallin epäsopivuutta aineistoon. SRMR-indeksi osoittaa mallin sopivan aineistoon.

Mallissa faktorin `f2` kaikki muuttujat ovat merkitseviä ($p < .001$). Faktorilla `f1` vain muuttuja `k3_5` on merkitsevä ($p = .020$). Yleisfaktorilla kaikki muuttujat paitsi `k12_4` ja `k12_5` ovat merkitseviä ($p < .028$).

Täysin standardisoitujen latauksien mukaan faktorilla `f1` pienin lataus on $b = -.086 [-.701, .529], \text{SD} = .314, \beta = -.053$ (`k3_7`) ja suurin lataus on $b = 1 [\text{n/a}], \text{SD} = \text{n/a}, \beta = .676$ (`k3_1`).

Samalla tavalla faktorilla `f2` pienin lataus on $b = .256 [.164, .348], \text{SD} = .052, \beta = .411$ (`k12_7`) ja suurin lataus on $b = 1 [\text{n/a}], \text{SD} = \text{n/a}, \beta = .893$ (`k12_1`).

Yleisellä faktorilla `gen` pienin lataus on $b = .037 [-.022, .096], \text{SD} = .030, \beta = .047$ (`k12_4`) ja suurin lataus on $b = 1.289 [.655, 1.923], \text{SD} = .324, \beta = .863$ (`k3_7`).

### Mallien vertailu

```{r}
#| label: kohtelu_validointi-36-mallivertailu
#| code-summary: "Mallien 1-2 vertailu"

vrt.tulos <- compareFit(
  malli.2,
  malli.1,
  nested = FALSE,
  moreIndices = TRUE
)

summary(vrt.tulos)

```

Bifaktorimalli (Malli 2) sopii kaikilla mittareilla perusmallia paremmin. Muutokset ovat tasaisesti jaettuja kaikille mittareille.

### Bifaktorimallin modifikaatioindeksit

```{r}
#| label: kohtelu_validointi-37-bf-mod1
#| code-summary: "Modifikaatioindeksit, vain faktorilataukset"

modificationIndices(malli.2) |>
  arrange(desc(mi)) |>
  filter(op == "=~") |>
  rowwise() |>
  mutate(
    p = pchisq(.data$mi, df = 1, lower.tail = FALSE),
    p.holm = p.adjust(.data$p, method = "holm")
  ) |>
  ungroup() |>
  filter(p.holm < .05) |>
  select(lhs, op, rhs, mi, sepc.all, p.holm)

```

Neljä latausta aiheuttaisivat khii neliö -suureen merkitsevän laskun: muuttujien `k3_5`, `k3_6` ja `k3_7` vapauttaminen faktorille `f2`, sekä muuttujan `k12_1` vapauttaminen faktorille `f1`.

Verrattuna ensimmäiseen malliin, muuttuja `k3_5` aiheuttaa vieläkin ison muutoksen, eli yleisfaktorin lisääminen ei ole korjannut muutostarvetta. Muuttujat `k3_7`, `k12_1` ja `k12_6` ovat uusia muutoksen tarpeen olevia muuttujia.

```{r}
#| label: kohtelu_validointi-38-bf-mod2
#| code-summary: "Modifikaatioindeksit, vain virhekorrelaatiot"

modificationIndices(malli.2) |>
  arrange(desc(mi)) |>
  filter(op == "~~") |>
  rowwise() |>
  mutate(
    p = pchisq(.data$mi, df = 1, lower.tail = FALSE),
    p.holm = p.adjust(.data$p, method = "holm")
  ) |>
  ungroup() |>
  filter(p.holm < .05) |>
  select(lhs, op, rhs, mi, sepc.all, p.holm)

```

Yhteensä 35 virhekorrelaatiota (38 prosenttia kaikista 91 virhekorrelaatiosta) aiheuttaisivat merkitsevän muutoksen globaalissa khii neliö -indeksissä. Aikaisemmassa mallissa oli 37 merkitsevää virhekorrelaatiota, joten määrä on lievästi vähentynyt.

Useat suurimmista modifikaatioindekseistä ovat muotokohtaisten muuttujaparien välillä (esim. `k3_5 ~~ k12_5`). Kuitenkin mallissa esiintyy myös niin faktoreiden välisiä kuin sisäisiä merkitseviä virhekorrelaatioiden modifikaatioindeksejä.

### Erotteluvaliditeetti

```{r}
#| label: fig-kohtelu_validointi-39-validiteettikorrelaatio
#| fig-cap: "Epäasiallisen ja väkivaltaisen kohtelun mittareiden korrelaatiomatriisi työuupumuksen mittareiden kanssa. Pearsonin tulomomenttikorrelaatiokerroin, Holm-muunnetut merkitsevyysarvot. Risti esittää 5 % alfatason ylittymistä, mustat viivat erottavat muuttujat neljään muuttujaryhmään kyselyssä mitatun tekokontekstin ja kohteen mukaisesti."
#| code-summary: "Kohtelun ja työuupumuksen korrelaatiomatriisi"

validiteetti_korr <- data.cfa |>
  select(k3_1:k3_7, k12_1:k12_7, k27_1:k27_4) |>
  cor(method = "pearson", use = "pairwise.complete.obs")

data.cfa |>
  select(k3_1:k3_7, k12_1:k12_7, k27_1:k27_4) |>
  ggcorrmat(
    ggcorrplot.args = list(lab_size = 1, tl.cex = 7, tl.srt = 90)
  ) +
  geom_vline(xintercept = 7.5, color = "black", size = 0.5) +
  geom_vline(xintercept = 14.5, color = "black", size = 0.5) +
  geom_vline(xintercept = 21.5, color = "black", size = 0.5) +
  geom_hline(yintercept = 6.5, color = "black", size = 0.5) +
  geom_hline(yintercept = 13.5, color = "black", size = 0.5) +
  geom_hline(yintercept = 20.5, color = "black", size = 0.5) 

```

Organisaatiosisäiset muuttujat korreloivat useimmiten merkitsevästi työuupumusmittareiden kanssa, paitsi mittari `k3_4`, joka ei korreloi ollenkaan työuupumuksen kanssa. Muuttuja `k3_5` ei korreloi neljännen työuupumusmittarin kanssa.

Organisaatioulkoiset muuttujat korreloivat yleensä vain ensimmäisen työuupumusmittarin kanssa, ja muut korrelaatiot ovat yleensä ei-merkitsevä. Muuttujat `k12_6` ja `k12_7` korreloivat myös toisen ja kolmannen työuupumusmittarin kanssa, ja muuttuja `k12_2` toisen työuupumusmittarin kanssa. Muuttuja `k12_4` ei korreloi minkään työuupumusmittarin kanssa merkitsevästi.

Korrelaatiot eivät ole liian suuria, eli mittarit näyttävät mittaavan eri asioita.

### Ulkoinen validiteetti

::: panel-tabset
#### Malli 1

```{r}
#| label: kohtelu_validointi-40-M1-ulkval
#| code-summary: "Ulkoisen validiteetin testaus"

cfa.malli.1.ulkval <- '# kohtelumuuttujat
                    f1 =~ start(0.8)*k3_1 + start(0.5)*k3_2 + start(0.7)*k3_3 + start(0.2)*k3_4 + start(0.2)*k3_5 + start(0.8)*k3_6 + start(0.7)*k3_7
                    f2 =~ start(0.9)*k12_1 + start(0.6)*k12_2 + start(0.9)*k12_3 + start(0.8)*k12_4 + start(0.8)*k12_5 + start(0.8)*k12_6 + start(0.6)*k12_7
                
                    # työuupumusmuuttuja, aikaisemman tutkimuksen painot
                    uup =~ 0.67 * k27_1 + 0.66 * k27_2 + 0.70 * k27_3 + 0.54 * k27_4
                
                    # faktorikovarianssi
                    f1 ~~ f2
                    f1 ~~ uup
                    f2 ~~ uup
                    '

malli.1.ulkval <- cfa(
  cfa.malli.1.ulkval,
  data = data.cfa |> select(k3_1:k3_7, k12_1:k12_7, k27_1:k27_4),
  estimator = "MLR",
  missing = "fiml"
)

summary(malli.1.ulkval, fit.measures = TRUE, standardized = TRUE, ci = TRUE)

```

Malli ei sovi hyväksyttävästi aineistoon ($\text{RMSEA} = .072 [90\% \text{ CI } .063, .081], \text{CFI} = .914, \text{SRMR} = .073$).

Työuupumuksen latentti muuttuja korreloi organisaatiosisäisen epäasiallisen ja väkivaltaisen kohtelun faktorin kanssa tasolla $r = 0,569$. Organisaatioulkoisen kohtelun faktorin kanssa korrelaatio on pienempi, $r = 0,202$. Molemmat korrelaatiot ovat merkitseviä.

#### Malli 2

```{r}
#| label: kohtelu_validointi-41-M2-ulkval
#| code-summary: "Ulkoisen validiteetin testaus"

cfa.malli.2.ulkval <- '# kohtelumuuttujat
                    f1 =~ start(0.8)*k3_1 + start(0.5)*k3_2 + start(0.7)*k3_3 + start(0.2)*k3_4 + start(0.2)*k3_5 + start(0.8)*k3_6 + start(0.7)*k3_7
                    f2 =~ start(0.9)*k12_1 + start(0.6)*k12_2 + start(0.9)*k12_3 + start(0.8)*k12_4 + start(0.8)*k12_5 + start(0.8)*k12_6 + start(0.6)*k12_7
                    gen =~ k3_1 + k3_2 + k3_3 + k3_4 + k3_5 + k3_6 + k3_7 + k12_1 + k12_2 + k12_3 + k12_4 + k12_5 + k12_6 + k12_7
                
                    # työuupumusmuuttuja, aikaisemman tutkimuksen painot
                    uup =~ 0.67 * k27_1 + 0.66 * k27_2 + 0.70 * k27_3 + 0.54 * k27_4
                
                    # faktorikovarianssi
                    f1 ~~ uup
                    f2 ~~ uup
                    gen ~~ uup
                    '

malli.2.ulkval <- cfa(
  cfa.malli.2.ulkval,
  data = data.cfa |> select(k3_1:k3_7, k12_1:k12_7, k27_1:k27_4),
  estimator = "MLR",
  missing = "fiml"
)

summary(malli.2.ulkval, fit.measures = TRUE, standardized = TRUE, ci = TRUE)

```

Malli ei sovi hyväksyttävästi aineistoon ($\text{RMSEA} = .072 [90\% \text{ CI } .066, .078], \text{CFI} = .834, \text{SRMR} = .058$).

Työuupumuksen latentti muuttuja ei korreloi merkitsevästi minkään latentin muuttujan kanssa. Korrelaatio organisaatiosisäisen kohtelun kanssa on pieni ($r = .130, p = .824$), kuten myös ulkoisen kohtelun kanssa ($r = .072, p = .914$). Yleisfaktorin kanssa korrelaatio on suuri mutta ei-merkitsevä ($r = .545, p = .148$).
:::

### Mittausinvarianssi

```{r}
#| label: kohtelu_validointi-42-datavalmistelu

data.cfa2 <- data.cfa |>
  select(k3_1:k3_7, k12_1:k12_7, k2, k40, Kieliversio, Linkkiversio)

```

#### Kohderyhmät

Koetimme verrata kahden faktorin mallin invarianssia kohderyhmien välillä (kolme kategoriaa). Malleja ei kuitenkaan voitu vähäisen invarianssin takia asettaa.

::: panel-tabset
##### Malli 1

```{r}
#| label: kohtelu_validointi-43-M1-invarianssi-kohderyhmat
#| code-summary: "Mittausinvarianssi: Kohderyhmät"
#| eval: false

# Malleissa käytetään kaikkia vastaajia.

inv.M1.kohderyhma.1 <- cfa(
  cfa.malli.1,
  data = data.cfa2 |> select(k3_1:k3_7, k12_1:k12_7, k2),
  estimator = "MLR",
  missing = "ml",
  group = "k2"
)

inv.M1.kohderyhma.2 <- cfa(
  cfa.malli.1,
  data = data.cfa2 |> select(k3_1:k3_7, k12_1:k12_7, k2),
  estimator = "MLR",
  missing = "ml",
  group = "k2",
  group.equal = "loadings"
)

inv.M1.kohderyhma.3 <- cfa(
  cfa.malli.1,
  data = data.cfa2 |> select(k3_1:k3_7, k12_1:k12_7, k2),
  estimator = "MLR",
  missing = "ml",
  group = "k2",
  group.equal = c("loadings", "intercepts")
)

inv.M1.kohderyhma.4 <- cfa(
  cfa.malli.1,
  data = data.cfa2 |> select(k3_1:k3_7, k12_1:k12_7, k2),
  estimator = "MLR",
  missing = "ml",
  group = "k2",
  group.equal = c("loadings", "intercepts", "residuals")
)

# Mallien vertailu
vrt.M1.kohderyhma <- compareFit(
  inv.M1.kohderyhma.4,
  inv.M1.kohderyhma.3,
  inv.M1.kohderyhma.2,
  inv.M1.kohderyhma.1,
  moreIndices = TRUE
)

summary(vrt.M1.kohderyhma)

```

##### Malli 2

```{r}
#| label: kohtelu_validointi-44-M2-invarianssi-kohderyhmat
#| code-summary: "Mittausinvarianssi: Kohderyhmät"
#| eval: false

# Malleissa käytetään kaikkia vastaajia.

inv.M2.kohderyhma.1 <- cfa(
  cfa.malli.2,
  data = data.cfa2 |> select(k3_1:k3_7, k12_1:k12_7, k2),
  estimator = "MLR",
  missing = "ml",
  group = "k2"
)

inv.M2.kohderyhma.2 <- cfa(
  cfa.malli.2,
  data = data.cfa2 |> select(k3_1:k3_7, k12_1:k12_7, k2),
  estimator = "MLR",
  missing = "ml",
  group = "k2",
  group.equal = "loadings"
)

inv.M2.kohderyhma.3 <- cfa(
  cfa.malli.2,
  data = data.cfa2 |> select(k3_1:k3_7, k12_1:k12_7, k2),
  estimator = "MLR",
  missing = "ml",
  group = "k2",
  group.equal = c("loadings", "intercepts")
)

inv.M2.kohderyhma.4 <- cfa(
  cfa.malli.2,
  data = data.cfa2 |> select(k3_1:k3_7, k12_1:k12_7, k2),
  estimator = "MLR",
  missing = "ml",
  group = "k2",
  group.equal = c("loadings", "intercepts", "residuals")
)

# Mallien vertailu
vrt.M2.kohderyhma <- compareFit(
  inv.M2.kohderyhma.4,
  inv.M2.kohderyhma.3,
  inv.M2.kohderyhma.2,
  inv.M2.kohderyhma.1,
  moreIndices = TRUE
)

summary(vrt.M2.kohderyhma)

```
:::

#### Ammattiasemat

Vertasimme kahden faktorin mallin invarianssia ammattiasemien välillä (kaksi kategoriaa: pelastajat ja ensihoitajat).

::: panel-tabset
##### Malli 1

```{r}
#| label: kohtelu_validointi-45-M1-invarianssi-ammattiasemat
#| code-summary: "Mittausinvarianssi: Ammattiasemat"

# Malleissa käytetään vain pelastajia (1) ja ensihoitajia (2)

inv.M1.ammattiryhma.1 <- cfa(
  cfa.malli.1,
  data = data.cfa2 |>
    select(k3_1:k3_7, k12_1:k12_7, k40) |>
    filter(between(k40, 1, 2)),
  estimator = "MLR",
  missing = "ml",
  group = "k40"
)

inv.M1.ammattiryhma.2 <- cfa(
  cfa.malli.1,
  data = data.cfa2 |>
    select(k3_1:k3_7, k12_1:k12_7, k40) |>
    filter(between(k40, 1, 2)),
  estimator = "MLR",
  missing = "ml",
  group = "k40",
  group.equal = "loadings"
)

inv.M1.ammattiryhma.3 <- cfa(
  cfa.malli.1,
  data = data.cfa2 |>
    select(k3_1:k3_7, k12_1:k12_7, k40) |>
    filter(between(k40, 1, 2)),
  estimator = "MLR",
  missing = "ml",
  group = "k40",
  group.equal = c("loadings", "intercepts")
)

inv.M1.ammattiryhma.4 <- cfa(
  cfa.malli.1,
  data = data.cfa2 |>
    select(k3_1:k3_7, k12_1:k12_7, k40) |>
    filter(between(k40, 1, 2)),
  estimator = "MLR",
  missing = "ml",
  group = "k40",
  group.equal = c("loadings", "intercepts", "residuals")
)

# Mallien vertailu
vrt.M1.ammattiasema <- compareFit(
  inv.M1.ammattiryhma.4,
  inv.M1.ammattiryhma.3,
  inv.M1.ammattiryhma.2,
  inv.M1.ammattiryhma.1,
  moreIndices = TRUE
)

summary(vrt.M1.ammattiasema)

```

Rakenneinvariantti malli sopivat suurin piirtein yhtä heikosti kuin yleismalli. Globaalit sopivuusindeksit eivät täytä raja-arvoja ($\text{RMSEA} = .120, \text{CFI} = .825, \text{SRMR} = .093)$.

Heikon invarianssin malli sopii samoin kuin kuin rakenneinvariantti malli ($p = .240$). CFI-mitan muutos on $\Delta\text{CFI} = -0.011$, mikä on hyväksyttävä (\<= 0.02). AIC-indeksi nousee hieman, BIC vastaavasti laskee erittäin vähän. RMSEA-indeksiin ei tule juurikaan muutosta, mutta SRMR nousee jonkin verran.

Vahvan invarianssin malli sopii samoin kuin heikon invarianssin malli ($p = .092$). CFI-mitan muutos on $\Delta\text{CFI} = -0.007¨6$, eli hyväksyttävä. AIC nousee erittäin vähän ja BIC laskee jonkin verran. RMSEA laskee hieman, mutta SRMR nousee lievästi.

Tiukan invarianssin malli sopii merkitsevästi huonommin kuin heikon invarianssin malli ($p = .003$). CFI-mitan muutos on $\Delta\text{CFI} = -0.070$, mikä on suurempi kuin hyväksyttävä muutos. AIC- ja BIC-arvot nousevat molemmat. RMSEA ja SRMR nousevat molemmat huomattavasti.

Khii neliö -suureen testit sekä CFI-indeksin enimmäismuutokset suosivat vahvaa invarianssia. CFI-, SRMR- ja AIC-arvot suosivat epäinvarianttia mallia. Khii neliö -suure itsessään suosii heikkoa invarianssia. BIC-arvo suosii vahvaa invarianssia.

##### Malli 2

```{r}
#| label: kohtelu_validointi-46-M2-invarianssi-ammattiasemat
#| code-summary: "Mittausinvarianssi: Ammattiasemat"

# Malleissa käytetään vain pelastajia (1) ja ensihoitajia (2)

inv.M2.ammattiryhma.1 <- cfa(
  cfa.malli.2,
  data = data.cfa2 |>
    select(k3_1:k3_7, k12_1:k12_7, k40) |>
    filter(between(k40, 1, 2)),
  estimator = "MLR",
  missing = "ml",
  group = "k40"
)

inv.M2.ammattiryhma.2 <- cfa(
  cfa.malli.2,
  data = data.cfa2 |>
    select(k3_1:k3_7, k12_1:k12_7, k40) |>
    filter(between(k40, 1, 2)),
  estimator = "MLR",
  missing = "ml",
  group = "k40",
  group.equal = "loadings"
)

inv.M2.ammattiryhma.3 <- cfa(
  cfa.malli.2,
  data = data.cfa2 |>
    select(k3_1:k3_7, k12_1:k12_7, k40) |>
    filter(between(k40, 1, 2)),
  estimator = "MLR",
  missing = "ml",
  group = "k40",
  group.equal = c("loadings", "intercepts")
)

inv.M2.ammattiryhma.4 <- cfa(
  cfa.malli.2,
  data = data.cfa2 |>
    select(k3_1:k3_7, k12_1:k12_7, k40) |>
    filter(between(k40, 1, 2)),
  estimator = "MLR",
  missing = "ml",
  group = "k40",
  group.equal = c("loadings", "intercepts", "residuals")
)

# Mallien vertailu
vrt.M2.ammattiasema <- compareFit(
  inv.M2.ammattiryhma.4,
  inv.M2.ammattiryhma.3,
  inv.M2.ammattiryhma.2,
  inv.M2.ammattiryhma.1,
  moreIndices = TRUE
)

summary(vrt.M2.ammattiasema)

```

Rakenneinvariantin mallin globaalit sopivuusindeksit ovat heikot ($\text{RMSEA} = .118, \text{CFI} = .846, \text{SRMR} = .080$).

Heikko invarianssimalli sopii merkitsevästi rakenneinvarianttia mallia huonommin ($p = .037$). CFI-mitan muutos on hyväksyttävä ($\Delta\text{CFI} = .015$). RMSEA paranee huomattavasti, mutta SRMR vastaavasti heikkenee huomattavasti. AIC nousee ja BIC laskee.

Vahvan invarianssin malli sopii yhtä hyvin kuin heikon invarianssin malli ($p = .991$). CFI-mitan muutos on hyväksyttävän pieni ($\Delta\text{CFI} = .015$), ja sekä RMSEA että SRMR paranee hyvin lievästi. AIC- ja BIC-arvot laskevat molemmat, joskin vain vähän.

Tiukan invarianssin malli sopii merkitsevästi vahvaa invarianssimallia huonommin ($p = 1.6*10^{-8}$). CFI-suureen muutos ei ole hyväksyttävissä rajoissa ($\Delta\text{CFI} = -.074$). RMSEA ja SRMR huonontuvat molemmat huomattavasti, ja sekä AIC että BIC noussee suuresti.

Khii neliö -testien mukaan malli on epäinvariantti. SRMR- ja AIC-suureet suosivat epäinvarianttia mallia. Khii neliö-, RMSEA-, CFI- ja BIC-suureet suosivat vahvaa invarianssia.
:::

#### Kyselyn kieliversio

Vertasimme kahden faktorin mallin invarianssia kyselyn kielen mukaan (kaksi kategoriaa: suomi ja ruotsi).

::: panel-tabset
##### Malli 1

```{r}
#| label: kohtelu_validointi-47-M1-invarianssi-kieliversiot
#| code-summary: "Mittausinvarianssi: Kyselyn kielet"

# Malleissa käytetään kaikkia vastaajia

inv.M1.kieliversio.1 <- cfa(
  cfa.malli.1,
  data = data.cfa2 |>
    select(k3_1:k3_7, k12_1:k12_7, Kieliversio),
  estimator = "MLR",
  missing = "ml",
  group = "Kieliversio"
)

inv.M1.kieliversio.2 <- cfa(
  cfa.malli.1,
  data = data.cfa2 |>
    select(k3_1:k3_7, k12_1:k12_7, Kieliversio),
  estimator = "MLR",
  missing = "ml",
  group = "Kieliversio",
  group.equal = "loadings"
)

inv.M1.kieliversio.3 <- cfa(
  cfa.malli.1,
  data = data.cfa2 |>
    select(k3_1:k3_7, k12_1:k12_7, Kieliversio),
  estimator = "MLR",
  missing = "ml",
  group = "Kieliversio",
  group.equal = c("loadings", "intercepts")
)

inv.M1.kieliversio.4 <- cfa(
  cfa.malli.1,
  data = data.cfa2 |>
    select(k3_1:k3_7, k12_1:k12_7, Kieliversio),
  estimator = "MLR",
  missing = "ml",
  group = "Kieliversio",
  group.equal = c("loadings", "intercepts", "residuals")
)

# Mallien vertailu
vrt.M1.kieliversio <- compareFit(
  inv.M1.kieliversio.4,
  inv.M1.kieliversio.3,
  inv.M1.kieliversio.2,
  inv.M1.kieliversio.1,
  moreIndices = TRUE
)

summary(vrt.M1.kieliversio)

```

Rakenneinvariantti mallii sopii heikohkosti aineistoon ($\text{RMSEA} = .092, \text{CFI} = .906, \text{SRMR} = .076$). Indekseistä SRMR täyttää hyväksyttävän sopivuuden rajan.

Heikon invarianssin malli sopii merkitsevästi huonommin kuin rakenneinvariantti malli ($p = 3.9*10^{-5}$). Muutokset mallin globaaleihin istuuvuusindekseihin ovat hyväksyttävissä rajoissa ($\Delta\text{RMSEA} = 0.005, \Delta\text{CFI} = -0.018, \Delta\text{SRMR} = 0.009$). Sekä AIC- että BIC-arvot nousevat.

Vahvan invarianssin malli sopii yhtä hyvin kuin heikon invarianssin malli ($p = .101$). Muutokset ovat hyväksyttävissä rajoissa ($\Delta\text{RMSEA} = -0.003, \Delta\text{CFI} = 0, \Delta\text{SRMR} = 0$). AIC- ja BIC-arvot laskevat molemmat, BIC reilusti AIC:tä enemmän.

Tiukan invarianssin malli istuu merkitsevästi huonommin kuin vahvan invarianssin malli ($p = .018$). Muutokset ovat kuitenkin osittain hyväksyttävissä rajoissa, paitsi SRMR-indeksin heikentyminen ($\Delta\text{RMSEA} = 0.001, \Delta\text{CFI} = -0.011, \Delta\text{SRMR} = 0.023$). Sekä AIC- että BIC-arvot nousevat selkeästi.

Khii neliö -testit suosivat epäinvarianttia mallia. Kaikki indeksit paitsi BIC-arvo suosivat epäinvarianttia mallia. BIC-arvo suosii vahvan invarianssin mallia.

##### Malli 2

```{r}
#| label: kohtelu_validointi-48-M2-invarianssi-kieliversiot
#| code-summary: "Mittausinvarianssi: Kyselyn kielet"

# Malleissa käytetään kaikkia vastaajia

inv.M2.kieliversio.1 <- cfa(
  cfa.malli.2,
  data = data.cfa2 |>
    select(k3_1:k3_7, k12_1:k12_7, Kieliversio),
  estimator = "MLR",
  missing = "ml",
  group = "Kieliversio"
)

inv.M2.kieliversio.2 <- cfa(
  cfa.malli.2,
  data = data.cfa2 |>
    select(k3_1:k3_7, k12_1:k12_7, Kieliversio),
  estimator = "MLR",
  missing = "ml",
  group = "Kieliversio",
  group.equal = "loadings"
)

inv.M2.kieliversio.3 <- cfa(
  cfa.malli.2,
  data = data.cfa2 |>
    select(k3_1:k3_7, k12_1:k12_7, Kieliversio),
  estimator = "MLR",
  missing = "ml",
  group = "Kieliversio",
  group.equal = c("loadings", "intercepts")
)

inv.M2.kieliversio.4 <- cfa(
  cfa.malli.2,
  data = data.cfa2 |>
    select(k3_1:k3_7, k12_1:k12_7, Kieliversio),
  estimator = "MLR",
  missing = "ml",
  group = "Kieliversio",
  group.equal = c("loadings", "intercepts", "residuals")
)

# Mallien vertailu
vrt.M2.kieliversio <- compareFit(
  inv.M2.kieliversio.4,
  inv.M2.kieliversio.3,
  inv.M2.kieliversio.2,
  inv.M2.kieliversio.1,
  moreIndices = TRUE
)

summary(vrt.M2.kieliversio)

```

Rakenneinvariantti malli sopii heikohkosti aineistoon ($\text{RMSEA} = .070, \text{CFI} = .914, \text{SRMR} = .059$). Vain SRMR-suure täyttää hyväksyttävän rajan.

Heikon invarianssin malli sopii merkitsevästi rakenneinvarianttia mallia huonommin ($p = 7.9 * 10^{-12}$). CFI-suureen muutos ei ole hyväksyttävä ($\Delta\text{CFI} = -.034$). RMSEA ja SRMR nousevat lievästi. AIC-suure nousee selkeästi, BIC-suure nousee lievästi.

Vahvan invarianssin malli sopii yhtä hyvin kuin heikko invarianssimalli ($p = .062$). CFI-suureen muutos on hyväksyttävä ($\Delta\text{CFI} = -.006$). RMSEA laskee erittäin lievästi ja SRMR ei muutu ollenkaan. Sekä AIC- että BIC-arvot laskevat jonkin verran, joskin AIC selkeästi BIC-arvoa vähemmän.

Tiukan invarianssin malli sopii merkitsevästi vahvaa invarianssimallia huonommin ($p = .022$). CFI-suureen muutos on vieläkin hyväksyttävä ($\Delta\text{CFI} = .004$). RMSEA laskee lievästi mutta SRMR nousee jo huomattavasti. Sekä AIC- että BIC-arvot nousevat huomattavasti.

Khii neliö -testi suosii epäinvarianttia mallia. Khii neliö-, RMSEA-, CFI- ja AIC-suureet suosivat epäinvarianttia mallia. BIC-suure suosii vahvan invarianssin mallia.
:::

#### Yhteydenottomenetelmät

Vertasimme kahden faktorin mallin invarianssia kyselyn yhteydenottonmenetelmien mukaan (kolme kategoriaa: johdon kautta, yhteyshenkilöiden ja toimistojen kautta, ja median kautta).

::: panel-tabset
##### Malli 1

```{r}
#| label: kohtelu_validointi-49-M1-invarianssi-yhteydenottomenetelmat
#| code-summary: "Mittausinvarianssi: Yhteydenottomenetelmät"

# Malleissa käytetään kaikkia vastaajia

inv.M1.yhteydenotto.1 <- cfa(
  cfa.malli.1,
  data = data.cfa2 |>
    select(k3_1:k3_7, k12_1:k12_7, Linkkiversio),
  estimator = "MLR",
  missing = "ml",
  group = "Linkkiversio"
)

inv.M1.yhteydenotto.2 <- cfa(
  cfa.malli.1,
  data = data.cfa2 |>
    select(k3_1:k3_7, k12_1:k12_7, Linkkiversio),
  estimator = "MLR",
  missing = "ml",
  group = "Linkkiversio",
  group.equal = "loadings"
)

inv.M1.yhteydenotto.3 <- cfa(
  cfa.malli.1,
  data = data.cfa2 |>
    select(k3_1:k3_7, k12_1:k12_7, Linkkiversio),
  estimator = "MLR",
  missing = "ml",
  group = "Linkkiversio",
  group.equal = c("loadings", "intercepts")
)

inv.M1.yhteydenotto.4 <- cfa(
  cfa.malli.1,
  data = data.cfa2 |>
    select(k3_1:k3_7, k12_1:k12_7, Linkkiversio),
  estimator = "MLR",
  missing = "ml",
  group = "Linkkiversio",
  group.equal = c("loadings", "intercepts", "residuals")
)

# Mallien vertailu
vrt.M1.yhteydenotto <- compareFit(
  inv.M1.yhteydenotto.4,
  inv.M1.yhteydenotto.3,
  inv.M1.yhteydenotto.2,
  inv.M1.yhteydenotto.1,
  moreIndices = TRUE
)

summary(vrt.M1.yhteydenotto)

```

Rakenneinvariantti malli sopii huonosti aineistoon ($\text{RMSEA} = .098, \text{CFI} = .894, \text{SRMR} = .087$).

Heikon invarianssin malli ei eroa merkitsevästi rakenneinvariantista mallista ($p = .255$). Muutokset mallin globaaleihin istuvuusindekseihin ovat hyväksyttävissä rajoissa, joskin SRMR-arvon nousu on suurempi kuin muut ($\Delta\text{RMSEA} = -0.001, \Delta\text{CFI} = -0.008, \Delta\text{SRMR} = 0.021$). AIC-arvo nousee jonkin verran mutta BIC-arvo laskee hieman.

Vahvan invarianssin malli istuu yhtä hyvin kuin heikon invarianssin malli ($p = .750$). Muutokset ovat hyväksyttävissä rajoissa ($\Delta\text{RMSEA} = -0.005, \Delta\text{CFI} = 0.001, \Delta\text{SRMR} = 0.001$). AIC- ja BIC-arvot laskevat molemmat, BIC selkesti enemmän.

Tiukan invarianssin malli istuu merkitsevästi huonommin kuin vahvan invarianssin malli ($p = .007$). Muutokset eivät ole hyväksyttävissä rajoissa ($\Delta\text{RMSEA} = 0.005, \Delta\text{CFI} = -0.025, \Delta\text{SRMR} = 0.035$). AIC- ja BIC-arvot nousevat reilusti.

Khii neliö -testi suosii vahvaa invarianssia. CFI-, SRMR- ja AIC-suureet suosivat epäinvarianttia mallia. Khii neliö -suure suosii heikkoa invarianssia. RMSEA- ja BIC-arvot suosivat vahvan invarianssin mallia.

##### Malli 2

```{r}
#| label: kohtelu_validointi-50-M2-invarianssi-yhteydenottomenetelmat
#| code-summary: "Mittausinvarianssi: Yhteydenottomenetelmät"

# Malleissa käytetään kaikkia vastaajia

inv.M2.yhteydenotto.1 <- cfa(
  cfa.malli.2,
  data = data.cfa2 |>
    select(k3_1:k3_7, k12_1:k12_7, Linkkiversio),
  estimator = "MLR",
  missing = "ml",
  group = "Linkkiversio"
)

inv.M2.yhteydenotto.2 <- cfa(
  cfa.malli.2,
  data = data.cfa2 |>
    select(k3_1:k3_7, k12_1:k12_7, Linkkiversio),
  estimator = "MLR",
  missing = "ml",
  group = "Linkkiversio",
  group.equal = "loadings"
)

inv.M2.yhteydenotto.3 <- cfa(
  cfa.malli.2,
  data = data.cfa2 |>
    select(k3_1:k3_7, k12_1:k12_7, Linkkiversio),
  estimator = "MLR",
  missing = "ml",
  group = "Linkkiversio",
  group.equal = c("loadings", "intercepts")
)

inv.M2.yhteydenotto.4 <- cfa(
  cfa.malli.2,
  data = data.cfa2 |>
    select(k3_1:k3_7, k12_1:k12_7, Linkkiversio),
  estimator = "MLR",
  missing = "ml",
  group = "Linkkiversio",
  group.equal = c("loadings", "intercepts", "residuals")
)

# Mallien vertailu
vrt.M2.yhteydenotto <- compareFit(
  inv.M2.yhteydenotto.4,
  inv.M2.yhteydenotto.3,
  inv.M2.yhteydenotto.2,
  inv.M2.yhteydenotto.1,
  moreIndices = TRUE
)

summary(vrt.M2.yhteydenotto)

```

Rakenneinvariantti malli ei sovi aineistoon ($\text{RMSEA} = .086, \text{CFI} = .865, \text{SRMR} = .069$). SRMR-indeksi täyttää kuitenkin hyväksyttävän mallin rajan.

Heikon invarianssin malli sopii yhtä hyvin kuin rakenneinvariantti malli ($p = .564$). CFI-suureen muutos ei ole hyväksyttävissä rajoissa, mutta osoittaa parempaa sopivuutta ($\Delta\text{CFI} = .027$). RMSEA paranee mutta SRMR heikkenee. AIC-arvo nousee ja BIC-arvo laskee.

Vahvan invarianssin malli sopii yhtä hyvin kuin heikon invarianssin malli ($p = .777$). CFI-suureen muutos on hyväksyttävä ($\Delta\text{CFI} = -.005$). RMSEA paranee lievästi ja SRMR huononee erittäin lievästi. AIC- ja BIC-arvot laskevat molemmat.

Tiukan invarianssin malli sopii merkitsevästi vahvaa invarianssia huonommin ($p = .015$). CFI-suureen muutos on hyväksyttävä ($\Delta\text{CFI} = -.002$). RMSEA laskee lievästi ja SRMR nousee selkeästi. AIC- ja BIC-arvot nousevat molemmat selkeästi.

Khii neliö -testi suosii vahvaa invarianssia. SRMR- ja AIC-arvot suosivat epäinvarianttia mallia. Khii neliö- ja CFI-suureet suosivat heikon invarianssin mallia. BIC suosii vahvan invarianssin mallia. RMSEA suosii tiukan invarianssin mallia.
:::

### Kovarianssi- ja keskiarvomatriisien tallennus

```{r}
#| label: kohtelu_validointi-51-matriisitallennus
#| code-summary: "Matriisien tallentaminen csv-muotoon"

write.csv2(
  x = rbind(
    lavInspect(malli.1, what = "obs")$cov,
    mean = lavInspect(malli.1, what = "obs")$mean
  ),
  file = "output/matriisi_malli1.csv"
)

write.csv2(
  x = rbind(
    lavInspect(malli.1.ulkval, what = "obs")$cov,
    mean = lavInspect(malli.1.ulkval, what = "obs")$mean
  ),
  file = "output/matriisi_malli1_ulkval.csv"
)

write.csv2(
  x = rbind(
    lavInspect(malli.2, what = "obs")$cov,
    mean = lavInspect(malli.2, what = "obs")$mean
  ),
  file = "output/matriisi_malli2.csv"
)

write.csv2(
  x = rbind(
    lavInspect(malli.2.ulkval, what = "obs")$cov,
    mean = lavInspect(malli.2.ulkval, what = "obs")$mean
  ),
  file = "output/matriisi_malli2_ulkval.csv"
)

```

Tallennetut tiedostot vastaavat käsikirjoituksen liitteitä 3-6.
