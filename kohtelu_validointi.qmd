# Epäasiallisen ja väkivaltaisen kohtelun esiintyvyyden mittarin validointi {#sec-kohtelu_validointi}

---
eval: true
cache: true
---

Tässä osiossa suoritamme tilastollisen validoinnin epäasiallisen ja väkivaltaisen kohtelun esiintyvyyden mittarille. Osio liittyy rekisteröityyn tutkimusraporttiin "Epäasiallisen ja väkivaltaisen kohtelun suomen- ja ruotsinkielisen mittarin validointi pelastus- ja ensihoitoalalla" (Saal, Silfverhuth & Huovinen, 2024). Viittaamme raportin rekisteröityihin protokolliin tekstissä.

```{r}
#| label: kohtelu_validointi-00-paketit
#| code-summary: "Osiossa käytetyt paketit"
#| output: false

library(ggstatsplot)
library(naniar)
library(HH)
library(EFAtools)
library(lavaan)
library(dynamic)
library(semTools)
library(moments)
library(tidyverse) # Tidyverse viimeiseksi, sillä HH:ssa useat dplyrin funktiot peittyvät

```

```{r}
#| label: kohtelu_validointi-01-avaaminen
#| code-summary: "Datan avaaminen"

data <- read.csv2("output/anonymisoitudata.csv", tryLogical = FALSE)

```

## Protokollamuutokset {#sec-kohtelu_validointi-protokollamuutokset}

Raportin luvussa 2.1. (Kohderyhmä) esitimme neljä kohderyhmää, niiden määritelmät sekä niiden yhteenlasketut otoskoot (ks. raportin Taulukko 2). Nämä kohderyhmät määriteltiin kontrollimuuttujina luvussa 2.5. (Kontrollimuuttujat). Olemme poikenneet kohderyhmistä seuraavalla tavalla:

-   Järjestöjen kohderyhmään lisättiin myös alueellisten pelastusliittojen henkilöstö

-   Anonymisoinnissa jouduimme yhdistämään järjestöt ja koulutusorganisaatiot yhdeksi muuttujaksi, jotta heidän anonymiteettinsa säilyisivät.

Raportin luvussa 2.2. (Yhteydenottomenetelmät) esitimme jokaiselle kohderyhmälle eritellyt yhteydenottomenetelmät. Menetelmät tarkentuivat ja laajenivat rekisteröinnin jälkeen (ks. @sec-tiedonkeruu). Poikkesimme suunnitelmasta seuraavalla tavalla:

-   Yhteydenottomenetelmät nimettiin uudelleen vastaamaan toteutettuja menetelmiä paremmin.

-   Vaihdoimme hyvinvointialueiden kirjaamot ja pelastuslaitosten viestinnät pelastuslaitosten ja ensihoidon yhteyshenkilöiksi.

-   Suomen Pelastusalan Keskusjärjestön kautta pelastusliittojen viestintään lähetetty viesti lähetettiin pelastusliittojen johdolle, samanaikaisesti kuin SPEK:n kautta pelastusliittojen johdolle lähetetty viesti.

-   Lisäsimme SPEK:n kautta sopimuspalokuntalaisten HAKA-järjestelmään ja siitä edelleen sopimuspalokunnille ja palokuntayhdistyksille välittetävä viesti. Tämä menetelmä laskettiin yhteyshenkilöiden ja viestinnän kautta välitettäväksi viestiksi.

-   Lisäsimme uutiskirjeet seuraavissa palveluissa: Palokuntaan.fi ja Pelastusopiston uutiskirjeet ensihoidolle, pelastustoimelle, onnettomuuksien ehkäisyyn sekä pelastustoimintaan. Nämä laskettiin yhteyshenkilöiden ja viestinnän kautta välitettäviksi viesteiksi.

-   Lisäsimme Spek.fi-sivustolla julkaistun tiedotteen sekä SSPL:n jäsenille lähetettävän tiedotteen. Nämä laskettiin median kautta välitettäviksi viesteiksi.

-   Lähetimme muistutusviestit järjestöjen ja koulutusorganisaatioiden johtajille, ensihoidon ja pelastuslaitosten yhteyshenkilöille sekä järjestöjen ja koulutusorganisaatioiden toimistoihin ja viestintään 3.9.2024.

## Deskriptiiviset tulokset {#sec-kohtelu_validointi-deskriptiiviset}

Tiedonkeruu suoritettiin 15.8.-15.9.2024 välisenä aikana. Aineistoon kuuluu n = `r nrow(data)` vastaajaa.

```{r}
#| label: kohtelu_validointi-02-taustamuuttujat
#| code-summary: "Sukupuoli"

sukupuoli <- data |>
  select(k31) |>
  mutate(
    k31 = factor(
      k31,
      labels = c("Nainen", "Mies", "Muu/EHV")
    )
  ) |>
  table() |>
  as.data.frame() |>
  mutate(
    Pros = (Freq / nrow(data)) * 100
  )
  
```

Vastaajista `r round(sukupuoli[2, "Pros"], digits = 1)` prosenttia (n = `r sukupuoli[2, "Freq"]`) olivat miehiä, `r round(sukupuoli[1, "Pros"], digits = 1)` prosenttia (n = `r sukupuoli[1, "Freq"]`) olivat naisia ja `r round(sukupuoli[3, "Pros"], digits = 1)` prosenttia (n = `r sukupuoli[3, "Freq"]`) muunsukupuolisia tai kieltäytyivät vastaamasta.

Verrattuna tunnettuihin sukupuolijakaumiin, aineistossa on yliedustettuna naissukupuoliset henkilöt.

```{r}
#| label: kohtelu_validointi-03-taustamuuttujat
#| code-summary: "Kohderyhmä"

kohderyhma <- data |>
  select(k2) |>
  mutate(
    k2 = factor(
      k2,
      labels = c(
        "Pelastuslaitos tai ensihoito",
        "Sopimuspalokunta tai palokuntayhdistys",
        "Järjestö, pelastusliitto tai koulu")
    )
  ) |>
  table() |>
  as.data.frame() |>
  mutate(
    Pros = (Freq / nrow(data)) * 100
  )
  
```

Vastaajista `r round(kohderyhma[1, "Pros"], digits = 1)` prosenttia (n = `r kohderyhma[1, "Freq"]`) olivat pelastuslaitokselta tai ensihoidosta, `r round(kohderyhma[2, "Pros"], digits = 1)` prosenttia (n = `r kohderyhma[2, "Freq"]`) olivat sopimuspalokunnista tai palokuntayhdistyksistä ja `r round(kohderyhma[3, "Pros"], digits = 1)` prosenttia (n = `r kohderyhma[3, "Freq"]`) olivat järjestöistä, pelastusliitoista tai koulutusorganisaatioista.

Kohderyhmätaulukon mukaan pelastuslaitosten ja ensihoidon osuus koko kohderyhmästä on noin 23,9 prosenttia, sopimuspalokuntien ja palokuntayhdistysten osuus noin 73,8 prosenttia, ja yhdistysten sekä koulutusorganisaatioiden yhteenlaskettu osuus noin 2,2 prosenttia. Aineistossamme on selkeästi yliedustettuina pelastuslaitokset ja ensihoito sekä hieman pienemmässä määrässä järjestöt, liitot ja koulutusorganisaatiot, ja aliedustettuina sopimuspalokunnat ja palokuntayhdistykset.

```{r}
#| label: kohtelu_validointi-04-taustamuuttujat
#| code-summary: "Ammattiasema"

ophenk_n <- data |>
  filter(Organisaatioasema == 2) |>
  filter(k2 == 1) |>
  nrow() - 70 # 70 henkilöä ovat alinta johtoa, eivätkä vastanneet suorittavan henkilöstön osuuteen. Jotta prosenttiosuudet olisivat oikein, arvoa on korjattava tämän verran.

ammattiasema <- data |>
  filter(Organisaatioasema == 2) |>
  select(k40) |>
  mutate(
    k40 = factor(
      k40,
      levels = c(1, 2, 3, -1),
      labels = c(
        "Pelastaja",
        "Ensihoitaja",
        "Muu",
        "Sopimuspalokuntalainen operatiivisessa toiminnassa"
      )
    )
  ) |>
  table() |>
  as.data.frame() |>
  mutate(
    Pros = (Freq / ophenk_n) * 100
  )

```

Operatiivista toimintaa suorittavasta pelastuslaitosten ja ensihoidon henkilöstöstä (n = `r ophenk_n`[^kohtelu_validointi-1]) `r round(ammattiasema[1, "Pros"], digits = 1)` prosenttia (n = `r ammattiasema[1, "Freq"]`) olivat pelastajia, `r round(ammattiasema[2, "Pros"], digits = 1)` prosenttia (n = `r ammattiasema[2, "Freq"]`) olivat ensihoitajia ja `r round(ammattiasema[3, "Pros"], digits = 1)` prosenttia (n = `r ammattiasema[3, "Freq"]`) ilmoittivat muun ammattiryhmän.

[^kohtelu_validointi-1]: Operatiiviseen henkilöstöön kuuluvat sekä suorittava henkilöstö (pelastajat, ensihoitajat) että alin johto (ryhmänjohtajat). Alin johto ei kuitenkaan kyselyvirheen takia vastanneet kysymykseen suorittavalle henkilöstölle. Tämän takia määrät ja prosenttiosuudet eivät vastaa todellisia. Prosenttiosuudet on laskettu käsin jakamalla kunkin ryhmän osiot oikealla otoskoolla (n = 428 operatiivista henkilöstöä - 70 alinta johtoa = 358 suorittavaa henkilöstöä).

Kohderyhmätaulukon mukaisesti pelastajien osuus pelastuslaitosten henkilöstöstä on noin 49,4 prosenttia, ensihoitajien osuus noin 42,0 prosenttia ja muun henkilöstön osuus noin 8,6 prosenttia. Otoksessamme ensihoitajat ovat lievästi yliedustettuna ja pelastajat vastaavasti aliedustettuna, muun henkilöstön osuus vastaa käytännössä populaation osuutta.

```{r}
#| label: kohtelu_validointi-05-taustamuuttujat
#| code-summary: "Kieliversio"

kieli <- data |>
  select(Kieliversio) |>
  mutate(
    Kieliversio = factor(
      Kieliversio,
      labels = c(
        "Suomi",
        "Ruotsi"
      )
    )
  ) |>
  table() |>
  as.data.frame() |>
  mutate(
    Pros = (Freq / nrow(data)) * 100
  )
  
```

Vastaajista `r round(kieli[1, "Pros"], digits = 1)` prosenttia (n = `r kieli[1, "Freq"]`) vastasivat suomeksi ja `r round(kieli[2, "Pros"], digits = 1)` prosenttia (n = `r kieli[2, "Freq"]`) vastasivat ruotsiksi. Vastauskieli ei välttämättä edusta äidinkielen tai käytetyn kielen jakautumista kohdepopulaatiossa.

```{r}
#| label: kohtelu_validointi-06-taustamuuttujat
#| code-summary: "Yhteydenottomenetelmät"

yhteydenotto <- data |>
  select(Linkkiversio) |>
  mutate(
    Linkkiversio = factor(
      Linkkiversio,
      labels = c(
        "Johdon kautta",
        "Henkilöstön kautta",
        "Median kautta"
      )
    )
  ) |>
  table() |>
  as.data.frame() |>
  mutate(
    Pros = (Freq / nrow(data)) * 100
  )
  
```

Vastaajista `r round(yhteydenotto[1, "Pros"], digits = 1)` prosenttia (n = `r yhteydenotto[1, "Freq"]`) vastasivat johdon kautta välitettyyn linkkiin, `r round(yhteydenotto[2, "Pros"], digits = 1)` prosenttia (n = `r yhteydenotto[2, "Freq"]`) vastasivat yhteyshenkilöiden tai toimistojen kautta välitettyyn linkkiin, ja `r round(yhteydenotto[3, "Pros"], digits = 1)` prosenttia (n = `r yhteydenotto[3, "Freq"]`) vastasivat median kautta välitettyyn linkkiin.

```{r}
#| label: tbl-kohtelu_validointi-07-kohtelu
#| tbl-cap: "Epäasiallisen ja väkivaltaisen kohtelun muuttujien keskiarvot, mediaanit, keskihajonnat ja validit otoskoot"
#| code-summary: "Kohtelun avainluvut"

# Korjataan muuttujien järjestys putkessa myöhemmin
jarjestys <- c(
  "k3_1", "k3_2", "k3_3", "k3_4", "k3_5", "k3_6", "k3_7",
  "k4_1", "k4_2", "k4_3", "k4_4", "k4_5", "k4_6", "k4_7",
  "k12_1", "k12_2", "k12_3", "k12_4", "k12_5", "k12_6", "k12_7",
  "k13_1", "k13_2", "k13_3", "k13_4", "k13_5", "k13_6", "k13_7"
)

kohtelu <- data |>
  select(k3_1:k4_7, k12_1:k13_7) |>
  summarise(
    across(
      everything(),
      list(
        mean = ~ round(mean(.x, na.rm = TRUE), digits = 2),
        sd = ~ round(sd(.x, na.rm = TRUE), digits = 2),
        skew = ~ round(skewness(.x, na.rm = TRUE), digits = 2),
        kurtosis = ~ round(kurtosis(.x, na.rm = TRUE), digits = 2),
        n = ~ sum(!is.na(.x))
      )
    )
  ) |>
  pivot_longer(
    cols = everything(),
    names_to = c("variable", "statistic"),
    names_pattern = "^(.*_\\d+)_(.*)$"
  ) |>
  pivot_wider(
    names_from = statistic,
    values_from = value
  ) |>
  arrange(
    factor(variable, levels = jarjestys)
  )

colnames(kohtelu) <- c("Muuttuja", "Keskiarvo", "Keskihajonta", "Vinous", "Huipukkuus", "Validi N")

kohtelu |>
  knitr::kable()

```

```{r}
#| label: fig-kohtelu_validointi-08-kohtelukorrelaatio
#| fig-cap: "Epäasiallisen ja väkivaltaisen kohtelun mittareiden korrelaatiomatriisi. Pearsonin tulomomenttikorrelaatiokerroin, Holm-muunnetut merkitsevyysarvot. Risti esittää 5 % alfatason ylittymistä, mustat viivat erottavat muuttujat neljään muuttujaryhmään kyselyssä mitatun tekokontekstin ja kohteen mukaisesti."
#| code-summary: "Kohtelun korrelaatiomatriisi"

kohtelu_korr <- data |>
  select(k3_1:k4_7, k12_1:k13_7) |>
  cor(method = "pearson", use = "pairwise.complete.obs")

data |>
  select(k3_1:k4_7, k12_1:k13_7) |>
  ggcorrmat(
    ggcorrplot.args = list(lab_size = 1, tl.cex = 7, tl.srt = 90)
  ) +
  geom_vline(xintercept = 7.5, color = "black", size = 0.5) +
  geom_vline(xintercept = 14.5, color = "black", size = 0.5) +
  geom_vline(xintercept = 21.5, color = "black", size = 0.5) +
  geom_hline(yintercept = 6.5, color = "black", size = 0.5) +
  geom_hline(yintercept = 13.5, color = "black", size = 0.5) +
  geom_hline(yintercept = 20.5, color = "black", size = 0.5)

```

Epäasiallisen ja väkivaltaisen kohtelun mittarit näyttävät korreloivan kahdessa osiossa: organisaatiosisäiset mittarit korreloivat toistensa kanssa merkitsevästi ja keskikokoisilla tai jopa suurilla kerroimilla, ja sama koskee organisaatioulkoisia mittareita. Mittarit korreloivat keskenään kuitenkin heikommin ja useammin ei-merkitsevästi, kuten näkyy korrelelogramin ylävasemmasta kulmasta (@fig-kohtelu_validointi-08-kohtelukorrelaatio).

Korrelaatioiden vahvuudet vaihtelevat välillä $r = `r min(kohtelu_korr[lower.tri(kohtelu_korr)])` - `r max(kohtelu_korr[lower.tri(kohtelu_korr)])`$. Pääsääntöisesti korrelaatiot ovat positiivisia. Korrelaatiomatriisin determinantti on $\det A = `r det(kohtelu_korr)`$.

```{r}
#| label: tbl-kohtelu_validointi-09-uupumus
#| tbl-cap: "BAT 4-menetelmän työuupumuksen muuttujien keskiarvot, mediaanit, keskihajonnat ja validit otoskoot"
#| code-summary: "Työuupumuksen avainluvut"

# Korjataan muuttujien järjestys putkessa myöhemmin
jarjestys <- c("k27_1", "k27_2", "k27_3", "k27_4")

uupumus <- data |>
  select(k27_1:k27_4) |>
  summarise(
    across(
      everything(),
      list(
        mean = ~ round(mean(.x, na.rm = TRUE), digits = 2),
        sd = ~ round(sd(.x, na.rm = TRUE), digits = 2),
        skew = ~ round(skewness(.x, na.rm = TRUE), digits = 2),
        kurtosis = ~ round(kurtosis(.x, na.rm = TRUE), digits = 2),
        n = ~ sum(!is.na(.x))
      )
    )
  ) |>
  pivot_longer(
    cols = everything(),
    names_to = c("variable", "statistic"),
    names_pattern = "^(.*_\\d+)_(.*)$"
  ) |>
  pivot_wider(
    names_from = statistic,
    values_from = value
  ) |>
  arrange(
    factor(variable, levels = jarjestys)
  )

colnames(uupumus) <- c("Muuttuja", "Keskiarvo", "Keskihajonta", "Vinous", "Huipukkuus", "Validi N")

uupumus |>
  knitr::kable()

```

```{r}
#| label: fig-kohtelu_validointi-10-uupumuskorrelaatio
#| fig-cap: "BAT 4-menetelmän työuupumuksen mittareiden korrelaatiomatriisi. Pearsonin tulomomenttikorrelaatiokerroin, Holm-muunnetut merkitsevyysarvot. Risti esittää 5 % alfatason ylittymistä."
#| code-summary: "Työuupumuksen korrelaatiomatriisi"

uupumus_korr <- data |>
  select(k27_1:k27_4) |>
  cor(method = "pearson", use = "pairwise.complete.obs")

data |>
  select(k27_1:k27_4) |>
  ggcorrmat()

```

Korrelaatiot ovat kaikki merkitsevästi positiivisia ja vaihtelevat välillä $r = `r min(uupumus_korr[lower.tri(uupumus_korr)])` - `r max(uupumus_korr[lower.tri(uupumus_korr)])`$. Korrelaatiomatriisin determinantti on $\det A = `r det(uupumus_korr)`$.

```{r}
#| label: kohtelu_validointi-11-puuttuviendata
#| code-summary: "Puuttuvien vastausten koodaus"

valitut <- data |>
  select(k3_1:k4_7, k12_1:k13_7)

puuttuvat_valitut <- data |>
  select(k3_1:k4_7, k12_1:k13_7, k2, k40, Kieliversio, Linkkiversio) |>
  mutate(
    across(
      k3_1:k13_7,
      ~ case_match(
        .x,
        NA ~ 1,
        .default = 0
      )
    )
  )

```

```{r}
#| label: kohtelu_validointi-12-kuvailevattallennus
#| code-summary: "Kuvailevien tulosten tallennus omiin tiedostoihin"

# Kuvailevat mitat esiintyvyys- ja työuupumusmittareille
write.csv2(
  x = bind_rows(kohtelu, uupumus),
  file = "output/validointiartikkeli_kuvailevatmitat.csv"
)

# Kovarianssi- ja keskiarvomatriisi
matriisi <- data |>
  select(k3_1:k4_7, k12_1:k13_7, k27_1:k27_4) |>
  cov(
    use = "pairwise.complete.obs",
    method = "pearson"
  )

matriisi[upper.tri(matriisi, diag = TRUE)] <- NA
ka <- data |>
  select(k3_1:k4_7, k12_1:k13_7, k27_1:k27_4) |>
  summarise(
    across(
      everything(),
      ~ mean(.x, na.rm = TRUE)
    )
  ) |>
  as.numeric()
matriisi <- rbind(matriisi, ka)

write.csv2(
  x = matriisi,
  file = "output/validointiartikkeli_matriisi.csv"
)


```

::: panel-tabset
### Puuttuvien arvojen määrä

```{r}
#| label: fig-kohtelu_validointi-13-kohtelupuuttuvat
#| fig-cap: "Epäasiallisen ja väkivaltaisen kohtelun muuttujien puuttuvien arvojen määrät"
#| code-summary: "Määrien tulostaminen"

gg_miss_var(valitut)

```

### Puuttuvien arvojen piirteet

```{r}
#| label: fig-kohtelu_validointi-14-kohteluupset
#| fig-cap: "Epäasiallisen ja väkivaltaisen kohtelun muuttujien puuttuvien arvojen piirreanalyysi"
#| code-summary: "Kuvion piirtäminen"

gg_miss_upset(
  valitut,
  nsets = 28,
  point.size = 1.0,
  text.scale = 0.5
)

```
:::

Puuttuvia arvoja esiintyy eniten organisaation ulkopuolelta tulleen kollegahavaintojen muuttujien ryhmässä (@fig-kohtelu_validointi-13-kohtelupuuttuvat). Vähiten esiintyy vastaavasti organisaation sisällä omakohtaisten kokemusten ryhmässä.

Upset-kuvio (@fig-kohtelu_validointi-14-kohteluupset) osoittaa, että kun organisaatiosisäisillä muuttujilla puuttuu vastaus, puute heijastuu usein muihin organisaatiosisäisiin muuttujiin. Samalla tavalla organisaatioulkoisten muuttujien puute heijastuu toisiin organisaatioulkoisiin muuttujiin.

```{r}
#| label: tbl-kohtelu_validointi-15-mcar
#| tbl-cap: "Littlen MCAR-testi, epäasiallisen ja väkivaltaisen kohtelun muuttujat (k = 28)"
#| code-summary: "Littlen MCAR-testi"

valitut |>
  mcar_test() |>
  knitr::kable()

```

Littlen MCAR-testi on merkitsevä, osoittaen, että puuttuvat vastaukset mitä luultavammin eivät ole täysin satunnaisesti puuttuvia (engl. *missing completely at random*) (p \< .05). Merkitsevyys voi osittain johtua suuresta otoskoosta, mutta todisteet osoittaisivat kuitenkin, että puuttuvissa vastauksissa on jonkin tapaista systematiikkaa.

```{r}
#| label: tbl-kohtelu_validointi-16-khii-kohderyhmat
#| tbl-cap: "Epäasiallisen ja väkivaltaisen kohtelun muuttujat kohderyhmittäin, frekvenssitaulukko ja khii neliö -testin tulokset (vertailu riveittäin sarakkeiden välillä)"
#| code-summary: "Kohtelun puuttuvien arvojen vertailu kohderyhmien välillä"

data_long <- puuttuvat_valitut |>
  pivot_longer(
    cols = k3_1:k13_7,
    names_to = "variable",
    values_to = "value"
  )

kontingenssi <- data_long |>
  filter(value == 1) |>
  group_by(variable, k2) |>
  summarise(count = n(), .groups = "drop") |>
  pivot_wider(
    names_from = k2,
    values_from = count,
    values_fill = 0
  )

khiinelio <- data_long |>
  group_by(variable) |>
  summarise(
    khii2 = list(
      chisq.test(table(value, k2))
    ),
    .groups = "drop"
  ) |>
  mutate(
    p = map_dbl(khii2, ~ .x$p.value),
    khii2 = map_dbl(khii2, ~ .x$statistic)
  ) |>
  select(variable, p, khii2)

vrt.kohderyhmat <- left_join(kontingenssi, khiinelio, by = "variable")

write.csv2(vrt.kohderyhmat, file = "output/khii_kohderyhmat.csv")

knitr::kable(vrt.kohderyhmat)

```

[Taulukon -@tbl-kohtelu_validointi-16-khii-kohderyhmat] mukaan useimpien muuttujien puuttuvien arvojen määrät eivät eroa kohderyhmien välillä merkitsevästi. Poikkeuksena ovat muuttujat `k12_1`, `k13_7` ja `k4_7`, eli organisaatioulkoisen omakohtaisesti koetun verbaalisen väkivallan, organisaatioulkoisen kollegahavaitun syrjinnän sekä organisaatiosisäisen kollegahavaitun syrjinnän muuttujat. On kuitenkin huomattava, että määrät ovat hyvin pieniä, ja käytännössä jokainen testi sisältää odotettuja soluja, joiden koot ovat alle 5 havaintoa, jolloin khii neliö -testi ei ole luotettava riippuvuustesti. Poikkeuksena voidaan nähdä organisaatioulkoisen kollegahavaitun syrjinnän muuttuja, jossa on moninkertaisesti enemmän puuttuvia arvoja pelastuslaitosten ja ensihoidon kohderyhmässä kuin muissa.

```{r}
#| label: tbl-kohtelu_validointi-17-khii-ammattiryhma
#| tbl-cap: "Epäasiallisen ja väkivaltaisen kohtelun muuttujat ammattiryhmittäin, frekvenssitaulukko ja khii neliö -testin tulokset (vertailu riveittäin sarakkeiden välillä)"
#| code-summary: "Kohtelun puuttuvien arvojen vertailu ammattiryhmien välillä"

data_long <- puuttuvat_valitut |>
  filter(between(k40, 1, 2)) |>
  pivot_longer(
    cols = k3_1:k13_7,
    names_to = "variable",
    values_to = "value"
  )

kontingenssi <- data_long |>
  filter(value == 1) |>
  group_by(variable, k40) |>
  summarise(count = n(), .groups = "drop") |>
  pivot_wider(
    names_from = k40,
    values_from = count,
    values_fill = 0
  )

khiinelio <- data_long |>
  group_by(variable) |>
  summarise(
    khii2 = list(
      chisq.test(table(value, k40))
    ),
    .groups = "drop"
  ) |>
  mutate(
    p = map_dbl(khii2, ~ .x$p.value),
    khii2 = map_dbl(khii2, ~ .x$statistic)
  ) |>
  select(variable, p, khii2)

vrt.ammattiryhmat <- left_join(kontingenssi, khiinelio, by = "variable")

write.csv2(vrt.ammattiryhmat, file = "output/khii_ammattiryhmat.csv")

knitr::kable(vrt.ammattiryhmat)

```

[Taulukon -@tbl-kohtelu_validointi-17-khii-ammattiryhma] mukaan mikään muuttuja ei eroa merkitsevästi puuttuvien vastausten määrässä pelastajien ja ensihoitajien välillä. Puuttuvia arvoja on hyvin vähän, joten khii neliö-testit eivät ole luotettavia, mutta puuttuminen ei myöskään oletettavasti aiheuta haittaa mallille myöhemmässä vaiheessa.

```{r}
#| label: tbl-kohtelu_validointi-18-khii-kieli
#| tbl-cap: "Epäasiallisen ja väkivaltaisen kohtelun muuttujat kyselyn kielen mukaan, frekvenssitaulukko ja khii neliö -testin tulokset (vertailu riveittäin sarakkeiden välillä)"
#| code-summary: "Kohtelun puuttuvien arvojen vertailu kyselyn kielten välillä"

data_long <- puuttuvat_valitut |>
  pivot_longer(
    cols = k3_1:k13_7,
    names_to = "variable",
    values_to = "value"
  )

kontingenssi <- data_long |>
  filter(value == 1) |>
  group_by(variable, Kieliversio) |>
  summarise(count = n(), .groups = "drop") |>
  pivot_wider(
    names_from = Kieliversio,
    values_from = count,
    values_fill = 0
  )

khiinelio <- data_long |>
  group_by(variable) |>
  summarise(
    khii2 = list(
      chisq.test(table(value, Kieliversio))
    ),
    .groups = "drop"
  ) |>
  mutate(
    p = map_dbl(khii2, ~ .x$p.value),
    khii2 = map_dbl(khii2, ~ .x$statistic)
  ) |>
  select(variable, p, khii2)

vrt.kieli <- left_join(kontingenssi, khiinelio, by = "variable")

write.csv2(vrt.kieli, file = "output/khii_kieli.csv")

knitr::kable(vrt.kieli)

```

[Taulukon -@tbl-kohtelu_validointi-18-khii-kieli] mukaan mikään muuttuja ei eroa merkitsevästi puuttuvien vastausten määrässä suomen- ja ruotsinkielisen kyselyn täyttäneiden välillä. Puuttuvia arvoja on hyvin vähän varsinkin ruotsinkielisen version täyttäneiden kesken, joten khii neliö-testit eivät ole luotettavia, mutta puuttuminen ei myöskään oletettavasti aiheuta haittaa mallille myöhemmässä vaiheessa.

```{r}
#| label: tbl-kohtelu_validointi-19-khii-yhteydenotto
#| tbl-cap: "Epäasiallisen ja väkivaltaisen kohtelun muuttujat yhteydenottomenetelmien mukaan, frekvenssitaulukko ja khii neliö -testin tulokset (vertailu riveittäin sarakkeiden välillä)"
#| code-summary: "Kohtelun puuttuvien arvojen vertailu yhteydenottomenetelmien välillä"

data_long <- puuttuvat_valitut |>
  pivot_longer(
    cols = k3_1:k13_7,
    names_to = "variable",
    values_to = "value"
  )

kontingenssi <- data_long |>
  filter(value == 1) |>
  group_by(variable, Linkkiversio) |>
  summarise(count = n(), .groups = "drop") |>
  pivot_wider(
    names_from = Linkkiversio,
    values_from = count,
    values_fill = 0
  )

khiinelio <- data_long |>
  group_by(variable) |>
  summarise(
    khii2 = list(
      chisq.test(table(value, Linkkiversio))
    ),
    .groups = "drop"
  ) |>
  mutate(
    p = map_dbl(khii2, ~ .x$p.value),
    khii2 = map_dbl(khii2, ~ .x$statistic)
  ) |>
  select(variable, p, khii2)

vrt.yhteydenotto <- left_join(kontingenssi, khiinelio, by = "variable")

write.csv2(vrt.yhteydenotto, file = "output/khii_yhteydenotto.csv")

knitr::kable(vrt.yhteydenotto)

```

[Taulukon -@tbl-kohtelu_validointi-19-khii-yhteydenotto] mukaan mikään muuttuja ei eroa merkitsevästi puuttuvien vastausten määrässä yhteydenottomenetelmien välillä. Poikkeuksena voi olla muuttuja `k4_7`, eli organisaatiosisäisesti kollegahavaittu syrjintä, joka mahdollisesti eroaa menetelmien välillä. P-arvo on kuitenkin yli vakiintuneen raja-arvon (p = .078), ja datan vähyys heikentää testin luotettavuutta.

## Osatutkimus 1: Mittariston faktorirakenne {#sec-kohtelu_validointi-osatutkimus1}

```{r}
#| label: kohtelu_validointi-20-satunnaisotanta
#| code-summary: "Satunnaisotanta"

set.seed(987320)
otos <- sample(c(1, 2), replace = TRUE, nrow(data), prob = c(0.3, 0.7))
data <- data |>
  add_column(
    otos = otos,
    .after = "ID"
  )

data.efa <- data |>
  filter(otos == 1)

data.cfa <- data |>
  filter(otos == 2)

```

```{r}
#| label: kohtelu_validointi-21-efasopivuustestit
#| code-summary: "EFA-mallin sopivuustestit"

# Mahalanobiksen etäisyys ja merkitsevyys
data.efa$mahalanobis <- mahalanobis(
  x = data.efa |> select(k3_1:k4_7, k12_1:k13_7),
  center = data.efa |> select(k3_1:k4_7, k12_1:k13_7) |> colMeans(na.rm = TRUE),
  cov = data.efa |> select(k3_1:k4_7, k12_1:k13_7) |> cov(use = "pairwise.complete.obs", method = "pearson")
)
data.efa$mahalanobis.p <- data.efa |>
  select(mahalanobis) |>
  unlist() |>
  as.double() |>
  pchisq(
    df = data.efa |> select(k3_1:k4_7, k12_1:k13_7) |> ncol() - 1
  )

# Kerätään kaikki tulokset yhteen listaan
tulokset.efa.sopivuus <- list()

# Mahalanobiksen pohjalta poistettavat vastaajat
tulokset.efa.sopivuus$poisto_n <- data.efa |>
  filter(mahalanobis.p < .001) |>
  summarise(n()) |>
  as.numeric()

# Bartlettin testi
tulokset.efa.sopivuus$bart <- data.efa |>
  select(k3_1:k4_7, k12_1:k13_7) |>
  BARTLETT()

# KMO-suure
tulokset.efa.sopivuus$kmosuure <- data.efa |>
  select(k3_1:k4_7, k12_1:k13_7) |>
  KMO()

# Korrelaatiomatriisin determinantti
tulokset.efa.sopivuus$determinantti <- data.efa |>
  select(k3_1:k4_7, k12_1:k13_7) |>
  cor(method = "pearson", use = "pairwise.complete.obs") |>
  det()

# VIF-arvot
tulokset.efa.sopivuus$vif <- data.efa |>
  select(k3_1:k4_7, k12_1:k13_7) |>
  vif()

# Hullin menetelmä
tulokset.efa.sopivuus$hull <- data.efa |>
  select(k3_1:k4_7, k12_1:k13_7) |>
  HULL(
    method = "ML",
    eigentype = "SMC",
    decision_rule = "percentile"
  )

```

Mahalanobiksen etäisyyden merkitsevyystestaus (p \< .001) osoittaa, että yhteensä `r tulokset.efa.sopivuus$poisto_n` vastaajaa pitäisi poistaa mallista.

KMO-suureen koko on `r tulokset.efa.sopivuus$kmosuure$KMO`.

Bartlettin testi on merkitsevä ($\chi^2 = `r tulokset.efa.sopivuus$bart$chisq`, \text{df} = `r tulokset.efa.sopivuus$bart$df`, p = `r tulokset.efa.sopivuus$bart$p_value`$).

Korrelaatiomatriisin determinantti on `r tulokset.efa.sopivuus$determinantti`.

Kolmella muutujalla on VIF-suureet yli 10: `k12_1`, `k13_1` ja `k13_3`. Näiden lisäksi muuttujat `k12_3` ja `k13_6` ovat yli 9, eli lähellä raja-arvoa.

Hullin menetelmän tulokset riippuvat käytetystä sopivuusindeksistä. CAF-indeksi ehdottaa `r tulokset.efa.sopivuus$hull$n_fac_CAF` faktoria, CFI ehdottaa `r tulokset.efa.sopivuus$hull$n_fac_CFI` faktoria ja RMSEA ehdottaa `r tulokset.efa.sopivuus$hull$n_fac_RMSEA` faktoria.

Tulokset osoittavat kolmea suurempaa ongelmaa: Mahalanobiksen etäisyyden mukaan noin kolmannes vastaajista pitäisi poistaa mallista, Hullin menetelmän tulokset ovat osittain ristiriitaisia ja ehdottavat joko yhtä tai kahta faktoria, ja korrelaatiomatriisin determinantti on koko aineistolle liian pieni ja osoittaa multikollineariteettia.

Jos vertaamme determinanttiongelmaa aikaisemmin tarkistettuun korrelaatiomatriisiin (@fig-kohtelu_validointi-08-kohtelukorrelaatio), ongelmallisia korrelaatioita (r \> 0.8) esiintyy vain organisaatioulkoisten muuttujien ryhmässä. Suurimpana ongelmana on omakohtaisesti koettujen ja kollegan kautta havaittujen kohtelujen korrelaatioissa, jossa suurin korrelaatio on jopa r = 0.87.

Tarkistimme, jos ongelma johtuu ensisijaisesti organisaatioulkoisten muuttujien tekokontekstiryhmien välisistä korrelaatioista poistamalla kollegan kautta havaitut muuttujat analyysista.

```{r}
#| label: kohtelu_validointi-22-efasopivuustestit
#| code-summary: "EFA-mallin sopivuustestit, vain omakohtaisesti koettu kohtelu"

# Tehdään uusi df testausta varten
data.efa2 <- data.efa

# Mahalanobiksen etäisyys ja merkitsevyys
data.efa2$mahalanobis <- mahalanobis(
  x = data.efa2 |> select(k3_1:k3_7, k12_1:k12_7),
  center = data.efa2 |> select(k3_1:k3_7, k12_1:k12_7) |> colMeans(na.rm = TRUE),
  cov = data.efa2 |> select(k3_1:k3_7, k12_1:k12_7) |> cov(use = "pairwise.complete.obs", method = "pearson")
)
data.efa2$mahalanobis.p <- data.efa2 |>
  select(mahalanobis) |>
  unlist() |>
  as.double() |>
  pchisq(
    df = data.efa2 |> select(k3_1:k3_7, k12_1:k12_7) |> ncol() - 1
  )

# Kerätään kaikki tulokset yhteen listaan
tulokset.efa2.sopivuus <- list()

# Mahalanobiksen pohjalta poistettavat vastaajat
tulokset.efa2.sopivuus$poisto_n <- data.efa2 |>
  filter(mahalanobis.p < .001) |>
  summarise(n()) |>
  as.numeric()

# Bartlettin testi
tulokset.efa2.sopivuus$bart <- data.efa2 |>
  select(k3_1:k3_7, k12_1:k12_7) |>
  BARTLETT()

# KMO-suure
tulokset.efa2.sopivuus$kmosuure <- data.efa2 |>
  select(k3_1:k3_7, k12_1:k12_7) |>
  KMO()

# Korrelaatiomatriisin determinantti
tulokset.efa2.sopivuus$determinantti <- data.efa2 |>
  select(k3_1:k3_7, k12_1:k12_7) |>
  cor(method = "pearson", use = "pairwise.complete.obs") |>
  det()

# VIF-arvot
tulokset.efa2.sopivuus$vif <- data.efa2 |>
  select(k3_1:k3_7, k12_1:k12_7) |>
  vif()

# Hullin menetelmä
tulokset.efa2.sopivuus$hull <- data.efa2 |>
  select(k3_1:k3_7, k12_1:k12_7) |>
  HULL(
    method = "ML",
    eigentype = "SMC",
    decision_rule = "percentile"
  )

```

Mahalanobiksen etäisyyden merkitsevyystestaus (p \< .001) osoittaa, että yhteensä `r tulokset.efa2.sopivuus$poisto_n` vastaajaa pitäisi poistaa mallista.

KMO-suureen koko on `r tulokset.efa2.sopivuus$kmosuure$KMO`.

Bartlettin testi on merkitsevä ($\chi^2 = `r tulokset.efa2.sopivuus$bart$chisq`, \text{df} = `r tulokset.efa2.sopivuus$bart$df`, p = `r tulokset.efa2.sopivuus$bart$p_value`$).

Korrelaatiomatriisin determinantti on `r tulokset.efa2.sopivuus$determinantti`.

Kaikkien muuttujien VIF-suureet ovat alle 10. Suurin VIF-suure on muuttujalla `k12_1` (VIF = `r tulokset.efa2.sopivuus$vif[["k12_1"]]`).

Hullin menetelmän tulokset riippuvat käytetystä sopivuusindeksistä. CAF-indeksi ehdottaa `r tulokset.efa2.sopivuus$hull$n_fac_CAF` faktoria, CFI ehdottaa `r tulokset.efa2.sopivuus$hull$n_fac_CFI` faktoria ja RMSEA ehdottaa `r tulokset.efa2.sopivuus$hull$n_fac_RMSEA` faktoria.

Koska tulokset osoittavat useita eri ristiriitoja, päätimme ajaa yhteensä 4 eri mallia kahdessa ryhmässä. Mallit 1A ja 1B käyttävät kaikkia 28 muuttujaa. Mallit 2A ja 2B käyttävät vain omakohtaisesti koettuja kokemuksia, eli 14 muuttujaa. A-malleissa sovitimme yhden faktorin mallin kaikille vastaajille (Mallit 1A, 2A) ja B-malleissa sovitimme kahden faktorin mallin kaikille vastaajille (Mallit 1B, 2B).

```{r}
#| label: kohtelu_validointi-23-efamallit
#| code-summary: "EFA-mallit"

efa.malli.1A <- data.efa |>
  select(k3_1:k4_7, k12_1:k13_7) |>
  efa(
    nfactors = 1,
    rotation = "oblimin",
    estimator = "ML",
    missing = "fiml"
  )

yhteenveto.efa.1A <- summary(
  efa.malli.1A,
  fit.measures = TRUE,
  ci = TRUE,
  efa = TRUE,
  cutoff = 0
)

efa.malli.1B <- data.efa |>
  select(k3_1:k4_7, k12_1:k13_7) |>
  efa(
    nfactors = 2,
    rotation = "oblimin",
    estimator = "ML",
    missing = "fiml"
  )

yhteenveto.efa.1B <- summary(
  efa.malli.1B,
  fit.measures = TRUE,
  ci = TRUE,
  efa = TRUE,
  cutoff = 0
)

efa.malli.2A <- data.efa2 |>
  select(k3_1:k3_7, k12_1:k12_7) |>
  efa(
    nfactors = 1,
    rotation = "oblimin",
    estimator = "ML",
    missing = "fiml"
  )

yhteenveto.efa.2A <- summary(
  efa.malli.2A,
  fit.measures = TRUE,
  ci = TRUE,
  efa = TRUE,
  cutoff = 0
)

efa.malli.2B <- data.efa2 |>
  select(k3_1:k3_7, k12_1:k12_7) |>
  efa(
    nfactors = 2,
    rotation = "oblimin",
    estimator = "ML",
    missing = "fiml"
  )

yhteenveto.efa.2B <- summary(
  efa.malli.2B,
  fit.measures = TRUE,
  ci = TRUE,
  efa = TRUE,
  cutoff = 0
)

```

::: panel-tabset
### Malli 1A

```{r}
#| label: kohtelu_validointi-24-efa1

yhteenveto.efa.1A

```

### Malli 1B

```{r}
#| label: kohtelu_validointi-25-efa2

yhteenveto.efa.1B

```

### Malli 2A

```{r}
#| label: kohtelu_validointi-26-efa3

yhteenveto.efa.2A

```

### Malli 2B

```{r}
#| label: kohtelu_validointi-27-efa4

yhteenveto.efa.2B

```
:::

28 muuttujan mallit istuvat huonommin kuin 14 muuttujan mallit. Yhden faktorin mallit (A-mallit) istuvat aina huonommin kuin kahden faktorin mallit (B-mallit), ottaen huomioon myös faktorin lisäämisestä nousseen seliteasteen.

Seliteasteet yhden faktorin malleilla ovat noin kolmannes kaikesta varianssista, kahden faktorin malleilla noin 50 prosenttia.

Kahden faktorin malleissa faktorien välinen korrelaatio on noin 0,3 (merkitsevä 1 % alfatasolla).

Useimmissa malleissa muuttuja `k3_5` (organisaatiosisäisesti koettu seksuaalinen häirintä tai väkivalta) ei tahdo asettua faktoreille kunnolla. Malli 1B:ssä muuttuja lataa merkitsevästi molemmille faktoreille, mutta latauskoko on alle 0,3 molemmissa tapauksissa. Malli 2A:ssa muuttuja on ainoa organisaatiosisäisten muuttujien ryhmästä, jonka lataus yhden faktorin mallissa on yli 0,3 (lataus = 0,411, merkitsevä 1 % alfa-tasolla). Malli 2B:ssä muuttuja samoin kuin Malli 1B:ssä, eli merkitsevästi mutta alle 0,3 tason molemmille faktoreille.

Kokonaisuudessaan parhaiten sopiva malli on Malli 2B (14 omakohtaisen kokemuksen muuttujaa, kaksi faktoria). Teoreettisista syistä näemme, että muuttujat `k3_4` ja `k3_5` (organisaatiosisäisesti koettu fyysinen väkivalta sekä seksuaalinen häirintä tai väkivalta) asettuvat ensimmäiseen faktoriin, vaikka lataukset ovat matalampia. Heikot lataukset voivat osittain johtua pienestä varianssista, sillä varsinkin fyysisen väkivallan kohdalla kokemuksia on aineistossa erittäin vähän.

On kuitenkin huomattava, että sopivuusindeksit eivät ole varsin hyviä. Mallin CFI-suure on 0.906 (alle yleisen raja-arvon 0.95) ja RMSEA on 0.108 (yli yleisen raja-arvon 0.05).

Jatkamme toiseen osatutkimukseen seuraavalla mallilla:

1.  Malliin sisältyy 14 muuttujaa, jotka mittaavat omakohtaisesti koettua epäasiallista ja väkivaltaista kohtelua.
2.  14 muuttujasta 7 muuttujaa mittaavat kokemuksia organisaation sisäisesti, ja 7 muuttujaa organisaation ulkoisesti.
3.  Muuttujat lataavat kahdelle faktorille: Organisaatiosisäiset kokemukset ja organisaatioulkoiset kokemukset.
4.  Muuttujat eivät ristilataa faktoreiden välillä ollenkaan.
5.  Latausten kokoja ei ennalta määritellä.
6.  Faktorit korreloivat arvolla r = 0,3.
7.  Muuttujien välisiä residuaalikorrelaatioita rajataan nollaan.
8.  Molempien faktorien mittatasot asetetaan ensimmäisen muuttujan mukaan (verbaalinen väkivalta).

## Eksploratiivinen analyysi: Noudatetaan Mahalanobiksen etäisyyden ehdotusta Malli 2B:ssä

```{r}
#| label: kohtelu_validointi-28-efamahalanobiksenmukaan
#| code-summary: "Mallin rakentaminen"

efa.malli.2Bekspl <- data.efa2 |>
  filter(mahalanobis.p > 0.001) |>
  select(k3_1:k3_7, k12_1:k12_7) |>
  efa(
    nfactors = 2,
    rotation = "oblimin",
    estimator = "ML",
    missing = "fiml"
  )

summary(
  efa.malli.2Bekspl,
  fit.measures = TRUE,
  ci = TRUE,
  efa = TRUE,
  cutoff = 0.4,
  dot.cutoff = 0
)

```

Robustisuuden vuoksi kokeilimme jättää pois Mahalanobiksen etäisyystestin rikkoneet vastaajat. Sovitimme sitten EFA-mallin 2B käyttäen samoja asetuksia kuin aikaisemmin.

Mallin sopivuus on käytännössä sama. AIC- ja BIC-arvot tippuvat reilusti, mutta CFI- ja RMSEA-indeksit pysyvät samoissa tasoissa.

Faktorilataukset pysyvät kuta kuinkin samoilla tasoilla. Suurin muutos on muuttujan `k3_7` faktorilatauksen pienentyminen 0,061 pisteellä. Faktorilla `f2` kaikkien muuttujien lataukset laskevat noin 0,02-0,03 pisteellä, faktorilla `f1` useimmat muuttujat laskevat hieman enemmän, mutta muuttuja `k3_3` nousee 0,042 pistettä.

Muuttuja `k3_1` lataa nyt myös merkitsevästi faktorille `f2`, mitä se ei tehnyt aikaisemmassa mallissa. Muutoin faktorilatausten merkitsevyydet pysyvät samoina kuin mallissa 2B.

Varianssiseliteaste laskee lievästi (aikaisempi 51,4 %, nykyinen 47,9 %). Suurin muutos on kuitenkin faktorikorrelaatioissa: aikaisempi korrelaatio oli r = ,295 (merkitsevä 1 % alfatasolla), mutta vastaajien poisjättämisen myötä korrelaatio laskee tasolle r = ,1 (ei merkitsevä).

## Osatutkimus 2: Faktorirakenteen validiteetti ja invarianssi {#sec-kohtelu_validointi-osatutkimus2}

### Mallin estimointi

```{r}
#| label: kohtelu_validointi-29-cfamallimaaritelma
#| code-summary: "Malli 1:n määrittely"

# Käytetään pyöristettyjä faktoriarvoja EFA-mallista starttiarvoina, yrittääksemme korjata Heywood-tapauksen ongelman
# Vaputettu faktorikorrelaatio (0.3)
cfa.malli.1 <- '# latentit muuttujat
                f1 =~ start(0.8)*k3_1 + start(0.5)*k3_2 + start(0.7)*k3_3 + start(0.2)*k3_4 + start(0.2)*k3_5 + start(0.8)*k3_6 + start(0.7)*k3_7
                f2 =~ start(0.9)*k12_1 + start(0.6)*k12_2 + start(0.9)*k12_3 + start(0.8)*k12_4 + start(0.8)*k12_5 + start(0.8)*k12_6 + start(0.6)*k12_7
                
                # faktorikovarianssi
                f1 ~~ f2
                '
```

```{r}
#| label: kohtelu_validointi-30-cfamalli1
#| code-summary: "Malli 1:n estimointi"

malli.1 <- cfa(
  cfa.malli.1,
  data = data.cfa |> select(k3_1:k3_7, k12_1:k12_7),
  estimator = "MLR",
  missing = "fiml"
)

summary(malli.1, fit.measures = TRUE, standardized = TRUE, ci = TRUE)

```

### Dynaamisten raja-arvojen simulointi ja globaalin sopivuuden tarkastus

```{r}
#| label: kohtelu_validointi-31-rajaarvot
#| code-summary: "Dynaamisten raja-arvojen simulointi"
#| eval: false

likertHB(
  model = malli.1,
  data = data.cfa |> select(k3_1:k3_7, k12_1:k12_7),
  estimator = "MLR",
  reps = 100
)

```

Emme pysty simuloimaan raja-arvoja, sillä sisäisesti koetun fyysisen väkivallan muuttujalla on liian pieni varianssi. Simulaation tekemissä bootstrap-otoksissa syntyy tilanteita, joissa muuttujan varianssi on nolla, jolloin estimaattia ei voida laskea.

Dynaamisten raja-arvojen sijaan käytimme yleisesti hyväksyttyjä raja-arvoja: $\text{RMSEA} < .05, \text{CFI} > .95, \text{SRMR} < .08$ [@byrne1994].

Mallin robustit sopivuusindeksit ovat:

-   $\chi^2 = 250.7, \text{df} = 76, p < .001$
-   $\text{RMSEA} = .086 [90\% \text{ CI } .074, .099]$
-   $\text{CFI} = .917$
-   $\text{SRMR} = .076$

RMSEA- ja CFI-indeksit osoittavat, ettei malli sovi aineistoon. SRMR-indeksi täyttää hyväksyttävän sopivuuden rajan.

Kaikki mallissa määritetyt faktorilataukset ovat merkitseviä ($p < .001$).

Täysin standardisoitujen latauksien mukaan faktorilla `f1` pienin lataus on $b = .055 [.018, .091], \text{SD} = .019, \beta = .285$ (`k3_4`) ja suurin lataus on $b = 1.040 [.849, 1.232], \text{SD} = .098, \beta = .850$ (`k3_6`).

Samalla tavalla faktorilla `f2` pienin lataus on $b = .308 [.215, .402], \text{SD} = .048, \beta = .507$ (`k12_7`) ja suurin lataus on $b = .900 [\text{n/a}], \text{SD} = \text{n/a}, \beta = .924$ (`k12_1`).

Faktorien välinen estimoitu kovarianssi on $r = .262 [.129, .395], \text{SD} = .086$.

### Modifikaatioindeksit

```{r}
#| label: kohtelu_validointi-32-modifikaatioindeksit1
#| code-summary: "Modifikaatioindeksit, vain faktorilataukset"

modificationIndices(malli.1) |>
  arrange(desc(mi)) |>
  filter(op == "=~") |>
  rowwise() |>
  mutate(
    p = pchisq(.data$mi, df = 1, lower.tail = FALSE),
    p.holm = p.adjust(.data$p, method = "holm")
  ) |>
  ungroup() |>
  filter(p.holm < .05) |>
  select(lhs, op, rhs, mi, sepc.all, p.holm)

```

Tarkistimme ensin modifikaatioindeksit kaikille faktorilatausrajauksille. Laskimme Holm-korjatut p-arvot jokaiselle modifikaatioindeksille ja tarkastimme ne indeksit, jotka eroavat merkitsevästi nollasta.

Neljä latausta aiheuttaisivat khii neliö -suureen merkitsevän laskun: muuttujien `k12_3`, `k12_4` ja `k12_7` vapauttaminen faktorille `f1`, sekä muuttujan `k3_5` vapauttaminen faktorile `f2`.

```{r}
#| label: kohtelu_validointi-33-modifikaatioindeksit2
#| code-summary: "Modifikaatioindeksit, vain virhekorrelaatiot"

modificationIndices(malli.1) |>
  arrange(desc(mi)) |>
  filter(op == "~~") |>
  rowwise() |>
  mutate(
    p = pchisq(.data$mi, df = 1, lower.tail = FALSE),
    p.holm = p.adjust(.data$p, method = "holm")
  ) |>
  ungroup() |>
  filter(p.holm < .05) |>
  select(lhs, op, rhs, mi, sepc.all, p.holm)

```

Jopa 40 virhekorrelaatiota (44 prosenttia kaikista 91 virhekorrelaatiosta) aiheuttaisivat merkitsevän muutoksen globaalissa khii neliö -indeksissä.

Virhekorrelaatioiden suuri määrä johti meidät ajattelemaan, että faktorit eivät edusta aineistoa varsin hyvin. Suurimmat modifikaatioindeksit löytyvät usein samojen faktorien muuttujien väliltä (esim. `k12_4 ~~ k12_5`), mikä osoittaisi, ettei faktori onnistu kaappaamaan kaikkea muuttujien yhteiskorrelaatiota. Samanaikaisesti usea virhekorrelaatio kuitenkin myös esiintyy faktoreiden välillä (esim. `k3_1 ~~ k12_6`), eli myöskään faktorien välinen korrelaatio ei onnistu kaappaamaan muuttujien välistä korrelaatiota hyvin.

Tulosten pohjalta aloimme epäilemään mahdollista bifaktorirakennetta.

### Bifaktorimallin estimointi

```{r}
#| label: kohtelu_validointi-34-bifaktorimallimaaritelma
#| code-summary: "Bifaktorimallin määrittely"

cfa.malli.2  <- '# latentit muuttujat
                f1 =~ k3_1 + k3_2 + k3_3 + k3_4 + k3_5 + k3_6 + k3_7
                f2 =~ k12_1 + k12_2 + k12_3 + k12_4 + k12_5 + k12_6 + k12_7
                
                # yleinen faktori
                gen =~ k3_1 + k3_2 + k3_3 + k3_4 + k3_5 + k3_6 + k3_7 + k12_1 + k12_2 + k12_3 + k12_4 + k12_5 + k12_6 + k12_7
                
                # Heywood-tapauksen korjaaminen
                k3_1 ~~ 0*k3_1
                '

```

```{r}
#| label: kohtelu_validointi-35-bifaktorimalli
#| code-summary: "Bifaktorimallin estimointi"

malli.2 <- cfa(
  cfa.malli.2,
  data = data.cfa |> select(k3_1:k3_7, k12_1:k12_7),
  estimator = "MLR",
  missing = "fiml",
  orthogonal = TRUE
)

summary(malli.2, fit.measures = TRUE, standardized = TRUE, ci = TRUE)

```

Bifaktorimallin asettaminen tavallisin menetelmin aiheuttaa Heywood-tapauksen (muuttujan `k3_1` varianssi on negatiivinen). Ratkaisimme ongelman lukitsemalla muuttujan varianssin nollaan.

Mallin robustit globaalit sopivuusindeksit ovat:

-   $\chi^2 = 159.3, \text{df} = 64, p < .001$
-   $\text{RMSEA} = .067 [90\% \text{ CI } .053, .082]$
-   $\text{CFI} = .957$
-   $\text{SRMR} = .050$

Khii neliö- ja RMSEA-indeksit osoittavat mallin epäsopivuutta aineistoon. CFI- ja SRMR-indeksit osoittavat mallin sopivan aineistoon.

Mallisa faktorin `f2` kaikki muuttujat ovat merkitseviä ($p < .001$). Faktorilla `f1` kaikki muuttujat paitsi `k3_2` ja `k3_7` ovat merkitseviä ($p < .036$). Yleisfaktorilla kaikki muuttujat paitsi `k12_4` ovat merkitseviä ($p < .028$).

Täysin standardisoitujen latauksien mukaan faktorilla `f1` pienin lataus on $b = .064 [-.018, .146], \text{SD} = .042, \beta = .126$ (`k3_2`) ja suurin lataus on $b = 1 [\text{n/a}], \text{SD} = \text{n/a}, \beta = .724$ (`k3_1`).

Samalla tavalla faktorilla `f2` pienin lataus on $b = .262 [.172, .352], \text{SD} = .046, \beta = .372$ (`k12_7`) ja suurin lataus on $b = 1 [\text{n/a}], \text{SD} = \text{n/a}, \beta = .889$ (`k12_1`).

Yleisellä faktorilla `gen` pienin lataus on $b = .043 [-.018, .103], \text{SD} = .031, \beta = .049$ (`k12_4`) ja suurin lataus on $b = 1.582 [1.133, 2.032], \text{SD} = .229, \beta = .889$ (`k3_7`).

### Mallien vertailu

```{r}
#| label: kohtelu_validointi-36-mallivertailu
#| code-summary: "Mallien 1-2 vertailu"

vrt.tulos <- compareFit(
  malli.2,
  malli.1,
  nested = FALSE,
  moreIndices = TRUE
)

summary(vrt.tulos)

```

Bifaktorimalli (Malli 2) sopii kaikilla mittareilla perusmallia paremmin. Muutokset ovat tasaisesti jaettuja kaikille mittareille.

### Bifaktorimallin modifikaatioindeksit

```{r}
#| label: kohtelu_validointi-37-bf-mod1
#| code-summary: "Modifikaatioindeksit, vain faktorilataukset"

modificationIndices(malli.2) |>
  arrange(desc(mi)) |>
  filter(op == "=~") |>
  rowwise() |>
  mutate(
    p = pchisq(.data$mi, df = 1, lower.tail = FALSE),
    p.holm = p.adjust(.data$p, method = "holm")
  ) |>
  ungroup() |>
  filter(p.holm < .05) |>
  select(lhs, op, rhs, mi, sepc.all, p.holm)

```

Neljä latausta aiheuttaisivat khii neliö -suureen merkitsevän laskun: muuttujien `k3_5` ja `k3_7` vapauttaminen faktorille `f2`, sekä muuttujien `k12_1` ja `k12_6` vapauttaminen faktorille `f1`.

Verrattuna ensimmäiseen malliin, muuttuja `k3_5` aiheuttaa vieläkin ison muutoksen, eli yleisfaktorin lisääminen ei ole korjannut muutostarvetta. Muuttujat `k3_7`, `k12_1` ja `k12_6` ovat uusia muutoksen tarpeen olevia muuttujia.

```{r}
#| label: kohtelu_validointi-38-bf-mod2
#| code-summary: "Modifikaatioindeksit, vain virhekorrelaatiot"

modificationIndices(malli.2) |>
  arrange(desc(mi)) |>
  filter(op == "~~") |>
  rowwise() |>
  mutate(
    p = pchisq(.data$mi, df = 1, lower.tail = FALSE),
    p.holm = p.adjust(.data$p, method = "holm")
  ) |>
  ungroup() |>
  filter(p.holm < .05) |>
  select(lhs, op, rhs, mi, sepc.all, p.holm)

```

Yhteensä 32 virhekorrelaatiota (35 prosenttia kaikista 91 virhekorrelaatiosta) aiheuttaisivat merkitsevän muutoksen globaalissa khii neliö -indeksissä. Aikaisemmassa mallissa oli 40 merkitsevää virhekorrelaatiota, joten määrä on lievästi vähentynyt.

Useat suurimmista modifikaatioindekseistä ovat muotokohtaisten muuttujaparien välillä (esim. `k3_5 ~~ k12_5`). Kuitenkin mallissa esiintyy myös niin faktoreiden välisiä kuin sisäisiä merkitseviä virhekorrelaatioiden modifikaatioindeksejä.

### Erotteluvaliditeetti

```{r}
#| label: fig-kohtelu_validointi-39-validiteettikorrelaatio
#| fig-cap: "Epäasiallisen ja väkivaltaisen kohtelun mittareiden korrelaatiomatriisi työuupumuksen mittareiden kanssa. Pearsonin tulomomenttikorrelaatiokerroin, Holm-muunnetut merkitsevyysarvot. Risti esittää 5 % alfatason ylittymistä, mustat viivat erottavat muuttujat neljään muuttujaryhmään kyselyssä mitatun tekokontekstin ja kohteen mukaisesti."
#| code-summary: "Kohtelun ja työuupumuksen korrelaatiomatriisi"

validiteetti_korr <- data.cfa |>
  select(k3_1:k3_7, k12_1:k12_7, k27_1:k27_4) |>
  cor(method = "pearson", use = "pairwise.complete.obs")

data.cfa |>
  select(k3_1:k3_7, k12_1:k12_7, k27_1:k27_4) |>
  ggcorrmat(
    ggcorrplot.args = list(lab_size = 1, tl.cex = 7, tl.srt = 90)
  ) +
  geom_vline(xintercept = 7.5, color = "black", size = 0.5) +
  geom_vline(xintercept = 14.5, color = "black", size = 0.5) +
  geom_vline(xintercept = 21.5, color = "black", size = 0.5) +
  geom_hline(yintercept = 6.5, color = "black", size = 0.5) +
  geom_hline(yintercept = 13.5, color = "black", size = 0.5) +
  geom_hline(yintercept = 20.5, color = "black", size = 0.5) 

```

Organisaatiosisäiset muuttujat korreloivat useimmiten merkitsevästi työuupumusmittareiden kanssa, paitsi mittari `k3_4`, joka ei korreloi ollenkaan työuupumuksen kanssa. Muuttuja `k3_2` ei korreloi kolmannen työuupumusmittarin kanssa, ja muuttuja `k3_5` ei korreloi neljännen työuupumusmittarin kanssa.

Organisaatioulkoiset muuttujat korreloivat yleensä vain ensimmäisen työuupumusmittarin kanssa, ja muut korrelaatiot ovat yleensä ei-merkitsevä. Muuttujat `k12_6` ja `k12_7` korreloivat myös toisen ja kolmannen työuupumusmittarin kanssa, ja muuttuja `k12_2` toisen työuupumusmittarin kanssa.

Korrelaatiot eivät ole liian suuria, eli mittarit näyttävät mittaavan eri asioita.

### Ulkoinen validiteetti

::: panel-tabset
#### Malli 1

```{r}
#| label: kohtelu_validointi-40-M1-ulkval
#| code-summary: "Ulkoisen validiteetin testaus"

cfa.malli.1.ulkval <- '# kohtelumuuttujat
                    f1 =~ start(0.8)*k3_1 + start(0.5)*k3_2 + start(0.7)*k3_3 + start(0.2)*k3_4 + start(0.2)*k3_5 + start(0.8)*k3_6 + start(0.7)*k3_7
                    f2 =~ start(0.9)*k12_1 + start(0.6)*k12_2 + start(0.9)*k12_3 + start(0.8)*k12_4 + start(0.8)*k12_5 + start(0.8)*k12_6 + start(0.6)*k12_7
                
                    # työuupumusmuuttuja, aikaisemman tutkimuksen painot
                    uup =~ 0.67 * k27_1 + 0.66 * k27_2 + 0.70 * k27_3 + 0.54 * k27_4
                
                    # faktorikovarianssi
                    f1 ~~ f2
                    f1 ~~ uup
                    f2 ~~ uup
                    '

malli.1.ulkval <- cfa(
  cfa.malli.1.ulkval,
  data = data.cfa |> select(k3_1:k3_7, k12_1:k12_7, k27_1:k27_4),
  estimator = "MLR",
  missing = "fiml"
)

summary(malli.1.ulkval, fit.measures = TRUE, standardized = TRUE, ci = TRUE)

```

Malli ei sovi hyväksyttävästi aineistoon ($\text{RMSEA} = .053, \text{CFI} = .900, \text{SRMR} = .076$).

Työuupumuksen latentti muuttuja korreloi organisaatiosisäisen epäasiallisen ja väkivaltaisen kohtelun faktorin kanssa tasolla $r = 0,482$. Organisaatioulkoisen kohtelun faktorin kanssa korrelaatio on pienempi, $r = 0,208$.

#### Malli 2

```{r}
#| label: kohtelu_validointi-41-M2-ulkval
#| code-summary: "Ulkoisen validiteetin testaus"

cfa.malli.2.ulkval <- '# kohtelumuuttujat
                    f1 =~ start(0.8)*k3_1 + start(0.5)*k3_2 + start(0.7)*k3_3 + start(0.2)*k3_4 + start(0.2)*k3_5 + start(0.8)*k3_6 + start(0.7)*k3_7
                    f2 =~ start(0.9)*k12_1 + start(0.6)*k12_2 + start(0.9)*k12_3 + start(0.8)*k12_4 + start(0.8)*k12_5 + start(0.8)*k12_6 + start(0.6)*k12_7
                    gen =~ k3_1 + k3_2 + k3_3 + k3_4 + k3_5 + k3_6 + k3_7 + k12_1 + k12_2 + k12_3 + k12_4 + k12_5 + k12_6 + k12_7
                
                    # työuupumusmuuttuja, aikaisemman tutkimuksen painot
                    uup =~ 0.67 * k27_1 + 0.66 * k27_2 + 0.70 * k27_3 + 0.54 * k27_4
                
                    # faktorikovarianssi
                    f1 ~~ uup
                    f2 ~~ uup
                    gen ~~ uup
                    '

malli.2.ulkval <- cfa(
  cfa.malli.2.ulkval,
  data = data.cfa |> select(k3_1:k3_7, k12_1:k12_7, k27_1:k27_4),
  estimator = "MLR",
  missing = "fiml"
)

summary(malli.2.ulkval, fit.measures = TRUE, standardized = TRUE, ci = TRUE)

```

Malli sopii rajallisesti hyväksyttävästi aineistoon ($\text{RMSEA} = .049 [90\% \text{ CI } .044, .054], \text{CFI} = .924, \text{SRMR} = .055$).

Työuupumuksen latentti muuttuja korreloi merkitsevästi vain yleismuuttujan kanssa ($r = .502, p < .001$). Korrelaatiot epäasiallisen ja väkivaltaisen kohtelun kanssa ovat ei-merkitseviä sekä organisaatiosisäisellä ($r = -.010, = .933$) että organisaatioulkoisella ($r = .075, p = .286$) faktorilla.
:::

### Mittausinvarianssi

```{r}
#| label: kohtelu_validointi-42-datavalmistelu

data.cfa2 <- data.cfa |>
  select(k3_1:k3_7, k12_1:k12_7, k2, k40, Kieliversio, Linkkiversio)

```

#### Kohderyhmät

Koetimme verrata kahden faktorin mallin invarianssia kohderyhmien välillä (kolme kategoriaa). Malleja ei kuitenkaan voitu vähäisen invarianssin takia asettaa.

::: panel-tabset
##### Malli 1

```{r}
#| label: kohtelu_validointi-43-M1-invarianssi-kohderyhmat
#| code-summary: "Mittausinvarianssi: Kohderyhmät"
#| eval: false

# Malleissa käytetään kaikkia vastaajia.

inv.M1.kohderyhma.1 <- cfa(
  cfa.malli.1,
  data = data.cfa2 |> select(k3_1:k3_7, k12_1:k12_7, k2),
  estimator = "MLR",
  missing = "ml",
  group = "k2"
)

inv.M1.kohderyhma.2 <- cfa(
  cfa.malli.1,
  data = data.cfa2 |> select(k3_1:k3_7, k12_1:k12_7, k2),
  estimator = "MLR",
  missing = "ml",
  group = "k2",
  group.equal = "loadings"
)

inv.M1.kohderyhma.3 <- cfa(
  cfa.malli.1,
  data = data.cfa2 |> select(k3_1:k3_7, k12_1:k12_7, k2),
  estimator = "MLR",
  missing = "ml",
  group = "k2",
  group.equal = c("loadings", "intercepts")
)

inv.M1.kohderyhma.4 <- cfa(
  cfa.malli.1,
  data = data.cfa2 |> select(k3_1:k3_7, k12_1:k12_7, k2),
  estimator = "MLR",
  missing = "ml",
  group = "k2",
  group.equal = c("loadings", "intercepts", "residuals")
)

# Mallien vertailu
vrt.M1.kohderyhma <- compareFit(
  inv.M1.kohderyhma.4,
  inv.M1.kohderyhma.3,
  inv.M1.kohderyhma.2,
  inv.M1.kohderyhma.1,
  moreIndices = TRUE
)

summary(vrt.M1.kohderyhma)

```

##### Malli 2

```{r}
#| label: kohtelu_validointi-44-M2-invarianssi-kohderyhmat
#| code-summary: "Mittausinvarianssi: Kohderyhmät"
#| eval: false

# Malleissa käytetään kaikkia vastaajia.

inv.M2.kohderyhma.1 <- cfa(
  cfa.malli.2,
  data = data.cfa2 |> select(k3_1:k3_7, k12_1:k12_7, k2),
  estimator = "MLR",
  missing = "ml",
  group = "k2"
)

inv.M2.kohderyhma.2 <- cfa(
  cfa.malli.2,
  data = data.cfa2 |> select(k3_1:k3_7, k12_1:k12_7, k2),
  estimator = "MLR",
  missing = "ml",
  group = "k2",
  group.equal = "loadings"
)

inv.M2.kohderyhma.3 <- cfa(
  cfa.malli.2,
  data = data.cfa2 |> select(k3_1:k3_7, k12_1:k12_7, k2),
  estimator = "MLR",
  missing = "ml",
  group = "k2",
  group.equal = c("loadings", "intercepts")
)

inv.M2.kohderyhma.4 <- cfa(
  cfa.malli.2,
  data = data.cfa2 |> select(k3_1:k3_7, k12_1:k12_7, k2),
  estimator = "MLR",
  missing = "ml",
  group = "k2",
  group.equal = c("loadings", "intercepts", "residuals")
)

# Mallien vertailu
vrt.M2.kohderyhma <- compareFit(
  inv.M2.kohderyhma.4,
  inv.M2.kohderyhma.3,
  inv.M2.kohderyhma.2,
  inv.M2.kohderyhma.1,
  moreIndices = TRUE
)

summary(vrt.M2.kohderyhma)

```
:::

#### Ammattiasemat

Vertasimme kahden faktorin mallin invarianssia ammattiasemien välillä (kaksi kategoriaa: pelastajat ja ensihoitajat).

::: panel-tabset
##### Malli 1

```{r}
#| label: kohtelu_validointi-45-M1-invarianssi-ammattiasemat
#| code-summary: "Mittausinvarianssi: Ammattiasemat"

# Malleissa käytetään vain pelastajia (1) ja ensihoitajia (2)

inv.M1.ammattiryhma.1 <- cfa(
  cfa.malli.1,
  data = data.cfa2 |>
    select(k3_1:k3_7, k12_1:k12_7, k40) |>
    filter(between(k40, 1, 2)),
  estimator = "MLR",
  missing = "ml",
  group = "k40"
)

inv.M1.ammattiryhma.2 <- cfa(
  cfa.malli.1,
  data = data.cfa2 |>
    select(k3_1:k3_7, k12_1:k12_7, k40) |>
    filter(between(k40, 1, 2)),
  estimator = "MLR",
  missing = "ml",
  group = "k40",
  group.equal = "loadings"
)

inv.M1.ammattiryhma.3 <- cfa(
  cfa.malli.1,
  data = data.cfa2 |>
    select(k3_1:k3_7, k12_1:k12_7, k40) |>
    filter(between(k40, 1, 2)),
  estimator = "MLR",
  missing = "ml",
  group = "k40",
  group.equal = c("loadings", "intercepts")
)

inv.M1.ammattiryhma.4 <- cfa(
  cfa.malli.1,
  data = data.cfa2 |>
    select(k3_1:k3_7, k12_1:k12_7, k40) |>
    filter(between(k40, 1, 2)),
  estimator = "MLR",
  missing = "ml",
  group = "k40",
  group.equal = c("loadings", "intercepts", "residuals")
)

# Mallien vertailu
vrt.M1.ammattiasema <- compareFit(
  inv.M1.ammattiryhma.4,
  inv.M1.ammattiryhma.3,
  inv.M1.ammattiryhma.2,
  inv.M1.ammattiryhma.1,
  moreIndices = TRUE
)

summary(vrt.M1.ammattiasema)

```

Rakenneinvariantti malli sopivat suurin piirtein yhtä heikosti kuin yleismalli. Globaalit sopivuusindeksit eivät täytä raja-arvoja ($\text{RMSEA} = .068, \text{CFI} = .940, \text{SRMR} = .082)$.

Heikon invarianssin malli sopii merkitsevästi huonommin kuin rakenneinvariantti malli ($p = .003$). CFI-mitan muutos on $\Delta\text{CFI} = -0.021$, mikä on juuri hyväksyttävän CFI-muutoksen rajalla (\<= 0.02). AIC- ja BIC-indeksit nousevat molemmat, osoittaen huonompaa sopivuutta.

Vahvan invarianssin malli sopii samoin kuin heikon invarianssin malli ($p = .129$). CFI-mitan muutos on $\Delta\text{CFI} = -0.007$, mikä hyväksyttävän muutoksen rajan sisällä. AIC nousee erittäin vähän ja BIC laskee hieman.

Tiukan invarianssin malli sopii merkitsevästi huonommin kuin heikon invarianssin malli ($p = .0004$). CFI-mitan muutos on $\Delta\text{CFI} = -0.134$, mikä on selkeästi suurempi kuin hyväksyttävä muutos. AIC- ja BIC-arvot nousevat molemmat.

Khii neliö -suureen testit eivät suosi invarianssia. Muutos vahvasta tiukkaan invarianssiin ei kuitenkaan ole merkitsevä. RMSEA-, CFI-, SRMR- sekä AIC-suureet suosivat rakenneinvarianttia mallia, mutta BIC-suure suosii vahvan invarianssin mallia.

##### Malli 2

```{r}
#| label: kohtelu_validointi-46-M2-invarianssi-ammattiasemat
#| code-summary: "Mittausinvarianssi: Ammattiasemat"

# Malleissa käytetään vain pelastajia (1) ja ensihoitajia (2)

inv.M2.ammattiryhma.1 <- cfa(
  cfa.malli.2,
  data = data.cfa2 |>
    select(k3_1:k3_7, k12_1:k12_7, k40) |>
    filter(between(k40, 1, 2)),
  estimator = "MLR",
  missing = "ml",
  group = "k40"
)

inv.M2.ammattiryhma.2 <- cfa(
  cfa.malli.2,
  data = data.cfa2 |>
    select(k3_1:k3_7, k12_1:k12_7, k40) |>
    filter(between(k40, 1, 2)),
  estimator = "MLR",
  missing = "ml",
  group = "k40",
  group.equal = "loadings"
)

inv.M2.ammattiryhma.3 <- cfa(
  cfa.malli.2,
  data = data.cfa2 |>
    select(k3_1:k3_7, k12_1:k12_7, k40) |>
    filter(between(k40, 1, 2)),
  estimator = "MLR",
  missing = "ml",
  group = "k40",
  group.equal = c("loadings", "intercepts")
)

inv.M2.ammattiryhma.4 <- cfa(
  cfa.malli.2,
  data = data.cfa2 |>
    select(k3_1:k3_7, k12_1:k12_7, k40) |>
    filter(between(k40, 1, 2)),
  estimator = "MLR",
  missing = "ml",
  group = "k40",
  group.equal = c("loadings", "intercepts", "residuals")
)

# Mallien vertailu
vrt.M2.ammattiasema <- compareFit(
  inv.M2.ammattiryhma.4,
  inv.M2.ammattiryhma.3,
  inv.M2.ammattiryhma.2,
  inv.M2.ammattiryhma.1,
  moreIndices = TRUE
)

summary(vrt.M2.ammattiasema)

```

Rakenneinvariantin mallin globaalit sopivuusindeksit ovat heikot ($\text{RMSEA} = .090, \text{CFI} = .903, \text{SRMR} = .080$).

Heikko invarianssimalli sopii merkitsevästi rakenneinvarianttia mallia huonommin ($p = .003$). CFI-mitan muutos on suurempi kuin suurin hyväksyttävä muutos ($\Delta\text{CFI} = -.028$). RMSEA-suureen muutos on hyvin pieni ($\Delta\text{RMSEA} = .003$). AIC-suure nousee hieman, kun taas BIC-suure laskee.

Vahvan invarianssin malli sopii merkitsevästi heikkoa invarianssimallia huonommin ($p = .031$). CFI-mitan muutos on hyväksyttävän pieni ($\Delta\text{CFI} = -.008$), ja RMSEA ei muutu ollenkaan. AIC nousee lievästi ja BIC laskee vastaavasti, mutta molemmat muutokset ovat heikon invarianssin mallia pienemmät.

Tiukan invarianssin malli sopii merkitsevästi vahvaa invarianssimallia huonommin ($p = 2*10^{-15}$). Heikkeneminen on suurta kaikilla mittareilla, ja sekä AIC- että BIC-arvot nousevat reilusti.

Khii neliö -testien mukaan malli ei ole invariantti. RMSEA-, CFI-, SRMR- ja AIC-suureet suosivat rakenneinvarianttia mallia, mutta BIC-suure on pienimmillään vahvan invarianssin mallilla.
:::

#### Kyselyn kieliversio

Vertasimme kahden faktorin mallin invarianssia kyselyn kielen mukaan (kaksi kategoriaa: suomi ja ruotsi).

::: panel-tabset
##### Malli 1

```{r}
#| label: kohtelu_validointi-47-M1-invarianssi-kieliversiot
#| code-summary: "Mittausinvarianssi: Kyselyn kielet"

# Malleissa käytetään kaikkia vastaajia

inv.M1.kieliversio.1 <- cfa(
  cfa.malli.1,
  data = data.cfa2 |>
    select(k3_1:k3_7, k12_1:k12_7, Kieliversio),
  estimator = "MLR",
  missing = "ml",
  group = "Kieliversio"
)

inv.M1.kieliversio.2 <- cfa(
  cfa.malli.1,
  data = data.cfa2 |>
    select(k3_1:k3_7, k12_1:k12_7, Kieliversio),
  estimator = "MLR",
  missing = "ml",
  group = "Kieliversio",
  group.equal = "loadings"
)

inv.M1.kieliversio.3 <- cfa(
  cfa.malli.1,
  data = data.cfa2 |>
    select(k3_1:k3_7, k12_1:k12_7, Kieliversio),
  estimator = "MLR",
  missing = "ml",
  group = "Kieliversio",
  group.equal = c("loadings", "intercepts")
)

inv.M1.kieliversio.4 <- cfa(
  cfa.malli.1,
  data = data.cfa2 |>
    select(k3_1:k3_7, k12_1:k12_7, Kieliversio),
  estimator = "MLR",
  missing = "ml",
  group = "Kieliversio",
  group.equal = c("loadings", "intercepts", "residuals")
)

# Mallien vertailu
vrt.M1.kieliversio <- compareFit(
  inv.M1.kieliversio.4,
  inv.M1.kieliversio.3,
  inv.M1.kieliversio.2,
  inv.M1.kieliversio.1,
  moreIndices = TRUE
)

summary(vrt.M1.kieliversio)

```

Rakenneinvariantti mallii sopii heikohkosti aineistoon ($\text{RMSEA} = .090, \text{CFI} = .909, \text{SRMR} = .080$).

Heikon invarianssin malli sopii yhtä hyvin kuin rakenneinvariantti malli ($p = .757$). Muutokset mallin globaaleihin istuuvuusindekseihin ovat hyväksyttävissä rajoissa ($\Delta\text{RMSEA} < 0.001, \Delta\text{CFI} = -0.008, \Delta\text{SRMR} = 0.005$). AIC-arvo nousee lievästi mutta BIC-arvo laskee lievästi.

Vahvan invarianssin malli istuu merkitsevästi huonommin kuin heikon invarianssin malli ($p = .047$). Muutokset ovat kuitenkin hyväksyttävissä rajoissa globaaleilla istuvuusindekseillä ($\Delta\text{RMSEA} = -0.003, \Delta\text{CFI} = -0.001, \Delta\text{SRMR} = 0$). AIC- ja BIC-arvot laskevat molemmat, BIC reilusti AIC:tä enemmän.

Tiukan invarianssin malli istuu merkitsevästi huonommin kuin vahvan invarianssin malli ($p = .0007$). Muutokset ylittävät myös hyväksyttävien muutosten rajat jokseenkin selkeästi ($\Delta\text{RMSEA} = 0.004, \Delta\text{CFI} = -0.018, \Delta\text{SRMR} = 0.038$). Sekä AIC- että BIC-arvot nousevat selkeästi.

Khii neliö -testit ehdottavat heikkoa invarianssia. CFI-, SRMR- ja AIC-suureet suosivat rakenneinvarianssia, mutta RMSEA- ja BIC-suureet suosivat vahvaa invarianssia.

##### Malli 2

```{r}
#| label: kohtelu_validointi-48-M2-invarianssi-kieliversiot
#| code-summary: "Mittausinvarianssi: Kyselyn kielet"

# Malleissa käytetään kaikkia vastaajia

inv.M2.kieliversio.1 <- cfa(
  cfa.malli.2,
  data = data.cfa2 |>
    select(k3_1:k3_7, k12_1:k12_7, Kieliversio),
  estimator = "MLR",
  missing = "ml",
  group = "Kieliversio"
)

inv.M2.kieliversio.2 <- cfa(
  cfa.malli.2,
  data = data.cfa2 |>
    select(k3_1:k3_7, k12_1:k12_7, Kieliversio),
  estimator = "MLR",
  missing = "ml",
  group = "Kieliversio",
  group.equal = "loadings"
)

inv.M2.kieliversio.3 <- cfa(
  cfa.malli.2,
  data = data.cfa2 |>
    select(k3_1:k3_7, k12_1:k12_7, Kieliversio),
  estimator = "MLR",
  missing = "ml",
  group = "Kieliversio",
  group.equal = c("loadings", "intercepts")
)

inv.M2.kieliversio.4 <- cfa(
  cfa.malli.2,
  data = data.cfa2 |>
    select(k3_1:k3_7, k12_1:k12_7, Kieliversio),
  estimator = "MLR",
  missing = "ml",
  group = "Kieliversio",
  group.equal = c("loadings", "intercepts", "residuals")
)

# Mallien vertailu
vrt.M2.kieliversio <- compareFit(
  inv.M2.kieliversio.4,
  inv.M2.kieliversio.3,
  inv.M2.kieliversio.2,
  inv.M2.kieliversio.1,
  moreIndices = TRUE
)

summary(vrt.M2.kieliversio)

```

Rakenneinvariantti malli sopii rajallisesti aineistoon ($\text{RMSEA} = .060, \text{CFI} = .936, \text{SRMR} = .052$).

Heikon invarianssin malli sopii merkitsevästi rakenneinvarianttia mallia huonommin ($p = .002$). CFI-suureen muutos on hyväksyttävissä rajoissa ($\Delta\text{CFI} = -.010$). RMSEA ei muutu juuri ollenkaan. AIC-suure nousee ja BIC-suure vastaavasti laskee.

Vahvan invarianssin malli sopii merkitsevästi heikkoa invarianssimallia huonommin ($p = .014$). CFI-suureen muutos on tässäkin hyväksyttävä ($\Delta\text{CFI} = -.005$). RMSEA ei muutu ollenkaan, ja sekä AIC- että BIC-suureet laskevat, joskin AIC-suure vain vajaa kahden pisteen verran.

Tiukan invarianssin malli sopii merkitsevästi vahvaa invarianssimallia huonommin ($p = .0003$). CFI-suureen muutos on vieläkin hyväksyttävä ($\Delta\text{CFI} = -.016$). RMSEA nousee lievästi, ja sekä AIC- että BIC-suureet nousevat selkeästi.

Khii neliö -testi suosii rakenneinvarianttia mallia. CFI-, SRMR- ja AIC-suureet suosivat myös rakenneinvarianssia, mutta RMSEA- ja BIC-suureet suosisivat vahvaa invarianssia.
:::

#### Yhteydenottomenetelmät

Vertasimme kahden faktorin mallin invarianssia kyselyn yhteydenottonmenetelmien mukaan (kolme kategoriaa: johdon kautta, yhteyshenkilöiden ja toimistojen kautta, ja median kautta).

::: panel-tabset
##### Malli 1

```{r}
#| label: kohtelu_validointi-49-M1-invarianssi-yhteydenottomenetelmat
#| code-summary: "Mittausinvarianssi: Yhteydenottomenetelmät"

# Malleissa käytetään kaikkia vastaajia

inv.M1.yhteydenotto.1 <- cfa(
  cfa.malli.1,
  data = data.cfa2 |>
    select(k3_1:k3_7, k12_1:k12_7, Linkkiversio),
  estimator = "MLR",
  missing = "ml",
  group = "Linkkiversio"
)

inv.M1.yhteydenotto.2 <- cfa(
  cfa.malli.1,
  data = data.cfa2 |>
    select(k3_1:k3_7, k12_1:k12_7, Linkkiversio),
  estimator = "MLR",
  missing = "ml",
  group = "Linkkiversio",
  group.equal = "loadings"
)

inv.M1.yhteydenotto.3 <- cfa(
  cfa.malli.1,
  data = data.cfa2 |>
    select(k3_1:k3_7, k12_1:k12_7, Linkkiversio),
  estimator = "MLR",
  missing = "ml",
  group = "Linkkiversio",
  group.equal = c("loadings", "intercepts")
)

inv.M1.yhteydenotto.4 <- cfa(
  cfa.malli.1,
  data = data.cfa2 |>
    select(k3_1:k3_7, k12_1:k12_7, Linkkiversio),
  estimator = "MLR",
  missing = "ml",
  group = "Linkkiversio",
  group.equal = c("loadings", "intercepts", "residuals")
)

# Mallien vertailu
vrt.M1.yhteydenotto <- compareFit(
  inv.M1.yhteydenotto.4,
  inv.M1.yhteydenotto.3,
  inv.M1.yhteydenotto.2,
  inv.M1.yhteydenotto.1,
  moreIndices = TRUE
)

summary(vrt.M1.yhteydenotto)

```

Rakenneinvariantti malli ei sovi aineistoon ($\text{RMSEA} = .094, \text{CFI} = .901, \text{SRMR} = .085$).

Heikon invarianssin malli ei eroa merkitsevästi rakenneinvariantista mallista ($p = .180$). Muutokset mallin globaaleihin istuvuusindekseihin ovat hyväksyttävissä rajoissa, joskin SRMR-arvon nousu on suurempi kuin muut ($\Delta\text{RMSEA} = -0.002, \Delta\text{CFI} = -0.006, \Delta\text{SRMR} = 0.023$). BIC-arvo tippuu hieman, mutta AIC-arvo nousee vastaavasti.

Vahvan invarianssin malli istuu merkitsevästi heikon invarianssin mallia huonommin ($p = .025$). Muutokset ovat kuitenkin hyväksyttävissä rajoissa ($\Delta\text{RMSEA} = -0.003, \Delta\text{CFI} = -0.003, \Delta\text{SRMR} = 0.001$). AIC- ja BIC-arvot laskevat molemmat, BIC selkesti enemmän.

Tiukan invarianssin malli istuu merkitsevästi huonommin kuin vahvan invarianssin malli ($p = .0000002$). Kaikki indeksiarvot muuttuvat enemmän kuin hyväksyttävän muutoksen rajat sallivat ($\Delta\text{RMSEA} = 0.021, \Delta\text{CFI} = -0.073, \Delta\text{SRMR} = 0.066$). AIC- ja BIC-arvot nousevat reilusti.

Khii neliö -testi suosii heikkoa invarianssia. CFI-, SRMR- ja AIC-suureet suosivat rakenneinvarianssia, mutta RMSEA- ja BIC-suureet suosivat vahvaa invarianssia.

##### Malli 2

```{r}
#| label: kohtelu_validointi-50-M2-invarianssi-yhteydenottomenetelmat
#| code-summary: "Mittausinvarianssi: Yhteydenottomenetelmät"

# Malleissa käytetään kaikkia vastaajia

inv.M2.yhteydenotto.1 <- cfa(
  cfa.malli.2,
  data = data.cfa2 |>
    select(k3_1:k3_7, k12_1:k12_7, Linkkiversio),
  estimator = "MLR",
  missing = "ml",
  group = "Linkkiversio"
)

inv.M2.yhteydenotto.2 <- cfa(
  cfa.malli.2,
  data = data.cfa2 |>
    select(k3_1:k3_7, k12_1:k12_7, Linkkiversio),
  estimator = "MLR",
  missing = "ml",
  group = "Linkkiversio",
  group.equal = "loadings"
)

inv.M2.yhteydenotto.3 <- cfa(
  cfa.malli.2,
  data = data.cfa2 |>
    select(k3_1:k3_7, k12_1:k12_7, Linkkiversio),
  estimator = "MLR",
  missing = "ml",
  group = "Linkkiversio",
  group.equal = c("loadings", "intercepts")
)

inv.M2.yhteydenotto.4 <- cfa(
  cfa.malli.2,
  data = data.cfa2 |>
    select(k3_1:k3_7, k12_1:k12_7, Linkkiversio),
  estimator = "MLR",
  missing = "ml",
  group = "Linkkiversio",
  group.equal = c("loadings", "intercepts", "residuals")
)

# Mallien vertailu
vrt.M2.yhteydenotto <- compareFit(
  inv.M2.yhteydenotto.4,
  inv.M2.yhteydenotto.3,
  inv.M2.yhteydenotto.2,
  inv.M2.yhteydenotto.1,
  moreIndices = TRUE
)

summary(vrt.M2.yhteydenotto)

```

Rakenneinvariantti malli ei sovi aineistoon ($\text{RMSEA} = .075, \text{CFI} = .901, \text{SRMR} = .063$).

Heikon invarianssin malli sopii yhtä hyvin kuin rakenneinvariantti malli ($p = .212$). CFI-suureen muutos on hyväksyttävä ja jopa positiivinen ($\Delta\text{CFI} = .012$). RMSEA- ja BIC-suureet paranevat, mutta SRMR- ja AIC-suureet heikkenevät.

Vahvan invarianssin malli sopii merkitsevästi heikkoa invarianssia huonommin ($p = .047$). CFI-suureen muutos on hyväksyttävä ($\Delta\text{CFI} = -.006$). RMSEA- ja SRMR-suureet eivät juurikaan muutu. AIC- ja BIC-suureet pienenevät.

Tiukan invarianssin malli sopii merkitsevästi vahvaa invarianssia huonommin ($p < 2*10^{-16}$). CFI-suureen muutos ei enää ole hyväksyttävissä rajoissa ($\Delta\text{CFI} = -.087$). RMSEA- ja SRMR-suureet heikkenevät molemmat, ja AIC- ja BIC-suureet nousevat reilusti.

Khii neliö -testi suosii heikkoa invarianssia. CFI-suure suosii samoin heikkoa invarianssia. SRMR- ja AIC-suureet suosivat rakenneinvarianssia, mutta RMSEA- ja BIC-suureet suosivat vahvaa invarianssia.

:::

### Kovarianssi- ja keskiarvomatriisien tallennus

```{r}
#| label: kohtelu_validointi-51-matriisitallennus
#| code-summary: "Matriisien tallentaminen csv-muotoon"

write.csv2(
  x = rbind(
    lavInspect(malli.1, what = "obs")$cov,
    mean = lavInspect(malli.1, what = "obs")$mean
  ),
  file = "output/matriisi_malli1.csv"
)

write.csv2(
  x = rbind(
    lavInspect(malli.1.ulkval, what = "obs")$cov,
    mean = lavInspect(malli.1.ulkval, what = "obs")$mean
  ),
  file = "output/matriisi_malli1_ulkval.csv"
)

write.csv2(
  x = rbind(
    lavInspect(malli.2, what = "obs")$cov,
    mean = lavInspect(malli.2, what = "obs")$mean
  ),
  file = "output/matriisi_malli2.csv"
)

write.csv2(
  x = rbind(
    lavInspect(malli.2.ulkval, what = "obs")$cov,
    mean = lavInspect(malli.2.ulkval, what = "obs")$mean
  ),
  file = "output/matriisi_malli2_ulkval.csv"
)

```

Tallennetut tiedostot vastaavat käsikirjoituksen liitteitä 3-6.
