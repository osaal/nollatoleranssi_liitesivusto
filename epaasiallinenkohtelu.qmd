# Epäasiallisen kohtelun mittaristo

## Mallien määrittely

```{r}
#| eval: false

# Epäasiallisen kohtelun kuuden ulottuvuuden CFA-malli
yleismalli <- '
  # Malli 1

  # Latentit muuttujat
    omakohtainen_a =~ verb1 + oma1 + uhk1 + fyy1 + seks1 + viha1
    havaittu_a =~ verb2 + oma2 + uhk2 + fyy2 + seks2 + viha2
    omakohtainen_b =~ verb3 + oma3 + uhk3 + fyy3 + seks3 + viha3
    havaittu_b =~ verb4 + oma4 + uhk4 + fyy4 + seks4 + viha4

  # Estimoitavat kovarianssit
    omakohtainen_a ~~ havaittu_a
    omakohtainen_b ~~ havaittu_b
    
  # Kovarianssit, jotka lukitaan nollaan
    omakohtainen_a ~~ 0*omakohtainen_b
    havaittu_a ~~ 0*havaittu_b
'

## Ulottuvuuskohtaiset IRT-mallit
# Sisäinen, itseen kohdistuva
verb_sisä_itse <- 'verb1 = verb1.1-verb1.10'
oma_sisä_itse <- 'oma1 = oma1.1-oma1.4'
uhk_sisä_itse <- 'uhk1 = uhk1.1-uhk1.13'
fyy_sisä_itse <- 'fyy1 = fyy1.1-fyy1.9'
seks_sisä_itse <- 'seks1 = seks1.1-seks1.8'
viha_sisä_itse <- 'viha1 = viha1.1-viha1.18'

# Sisäinen, kollegaan kohdistuva
verb_sisä_koll <- 'verb2 = verb2.1-verb2.10'
oma_sisä_koll <- 'oma2 = oma2.1-oma2.4'
uhk_sisä_koll <- 'uhk2 = uhk2.1-uhk2.13'
fyy_sisä_koll <- 'fyy2 = fyy2.1-fyy2.9'
seks_sisä_koll <- 'seks2 = seks2.1-seks2.8'
viha_sisä_koll <- 'viha2 = viha2.1-viha2.18'

# Ulkoinen, itseen kohdistuva
verb_ulk_itse <- 'verb3 = verb3.1-verb3.10'
oma_ulk_itse <- 'oma3 = oma3.1-oma3.4'
uhk_ulk_itse <- 'uhk3 = uhk3.1-uhk3.13'
fyy_ulk_itse <- 'fyy3 = fyy3.1-fyy3.9'
seks_ulk_itse <- 'seks3 = seks3.1-seks3.8'
viha_ulk_itse <- 'viha3 = viha3.1-viha3.18'

# Ulkoinen, kollegaan kohdistuva
verb_ulk_koll <- 'verb4 = verb4.1-verb4.10'
oma_ulk_koll <- 'oma4 = oma4.1-oma4.4'
uhk_ulk_koll <- 'uhk4 = uhk4.1-uhk4.13'
fyy_ulk_koll <- 'fyy4 = fyy4.1-fyy4.9'
seks_ulk_koll <- 'seks4 = seks4.1-seks4.8'
viha_ulk_koll <- 'viha4 = viha4.1-viha4.18'
```

Muuttuja `yleismalli` on Malli 1: Epäasiallisen kohtelun kuusi ulottuvuutta neljässä tekijä. ja tekokontekstiryhmässä. Jokainen ulottuvuus on mitattu erikseen kyselytutkimuksessa. Mallissa on seuraavat latentit muuttujat:

-   `omakohtainen_a`: Itse kohdattu epäasiallinen kohtelu organisaation sisällä.

-   `omakohtainen_b`: Itse kohdattu epäasiallinen kohtelu organisaation ulkopuolella.

-   `havaittu_a`: Kollegan havaittu epäasiallinen kohtelu organisaation sisällä.

-   `havaittu_b`: Kollegan havaittu epäasiallinen kohtelu organisaation ulkopuolella.

Mallissa estimoidaan kahden faktoriparin kovarianssit: `omakohtainen_a ~~ havaittu_a` ja `omakohtainen_b ~~ havaittu_b`. Omakohtaisten kokemusten kahden faktorin kovarianssi lukitaan nollaan, samoin havaittujen kokemusten kahden faktorin kovarianssi: `omakohtainen_a ~~ 0*omakohtainen_b` ja `havaittu_a ~~ 0*havaittu_b`.

## CFA-mallin asettaminen ja testaaminen

```{r}
#| eval: false

library(lavaan)
library(semTools)

# Muista lisätä itse data!
mallidata <- data.frame()

sovitettu_yleinen <- lavaan::cfa(
  yleismalli,
  data = mallidata,
  fit.measures = TRUE,
  standardized = TRUE,
  estimator = "MLMVS", # Satterthwaite-robusti ML-estimaattori
  missing = "ML", # FIML-menetelmä puuttuville arvoille
  test = "robust",
  se = "robust"
)

# Mallin invarianssitestaus suoritetaan lavaan-paketilla automaattisesti. Käytetään Satorra-Bentley-korjattu khiin neliötä.

# Kohderyhmä
invarianssi_kohderyhmä <- semTools::measurementInvariance(
  model = sovitettu_yleinen,
  data = mallidata,
  group = "kohderyhmä",
  strict = TRUE
)
# Kieliversio
invarianssi_kieli <- semTools::measurementInvariance(
  model = sovitettu_yleinen,
  data = mallidata,
  group = "kieli",
  strict = TRUE
)
# Yhteydenottomenetelmät
invarianssi_yhteydenotto <- semTools::measurementInvariance(
  model = sovitettu_yleinen,
  data = mallidata,
  group = "yhteydenotto",
  strict = TRUE
)

```

Sovitettava malli estimoidaan Satterthwaite-tapaisella keskiarvo- ja varianssikorjatulla testillä (`estimator = "MLMVS"`). Puuttuvat arvot käsitellään "full information maximum likelihood"-menetelmällä (`missing = "ML"`).

## IRT-mallien asettaminen ja testaaminen

```{r}
#| eval: false

library(mirt)

# Määritellään wrapper-funktio, jotta kirjoittaminen onnistuu helpommin.

testaa.malli <- function(malli) {
  mirt::mirt(
    data = mallidata,
    model = malli,
    itemtype = "3PL",
    verbose = FALSE)
}

# Mallit ovat numeroituna 1.1-1.6, 2.1-2.6, 3.1-3.6 ja 4.1-4.6 lyhentämisen takia. Ensimmäinen numero osoittaa ryhmäkohtaista mallia (sisäinen itseen kohdistuva, sisäinen kollegaan kohdistuva, ulkoinen itseen kohdistuva ja ulkoinen kollegaan kohdistuva), toinen numero osoittaa ulottuvuuden (verbaalinen, omaisuus, uhkailu, fyysinen, seksuaalinen ja vihamielisyys).

m1.1 <- testaa.malli(verb_sisä_itse)
m1.2 <- testaa.malli(oma_sisä_itse)
m1.3 <- testaa.malli(uhk_sisä_itse)
m1.4 <- testaa.malli(fyy_sisä_itse)
m1.5 <- testaa.malli(seks_sisä_itse)
m1.6 <- testaa.malli(viha_sisä_itse)

m2.1 <- testaa.malli(verb_sisä_koll)
m2.2 <- testaa.malli(oma_sisä_koll)
m2.3 <- testaa.malli(uhk_sisä_koll)
m2.4 <- testaa.malli(fyy_sisä_koll)
m2.5 <- testaa.malli(seks_sisä_koll)
m2.6 <- testaa.malli(viha_sisä_koll)

m3.1 <- testaa.malli(verb_ulk_itse)
m3.2 <- testaa.malli(oma_ulk_itse)
m3.3 <- testaa.malli(uhk_ulk_itse)
m3.4 <- testaa.malli(fyy_ulk_itse)
m3.5 <- testaa.malli(seks_ulk_itse)
m3.6 <- testaa.malli(viha_ulk_itse)

m4.1 <- testaa.malli(verb_ulk_koll)
m4.2 <- testaa.malli(oma_ulk_koll)
m4.3 <- testaa.malli(uhk_ulk_koll)
m4.4 <- testaa.malli(fyy_ulk_koll)
m4.5 <- testaa.malli(seks_ulk_koll)
m4.6 <- testaa.malli(viha_ulk_koll)

# Laitetaan mallit listaan helpomman käsittelyn vuoksi

kaikki_mallit <- c(m1.1, m1.2, m1.3, m1.4, m1.5, m1.6, m2.1, m2.2, m2.3, m2.4, m2.5, m2.6, m3.1, m3.2, m3.3, m3.4, m3.5, m3.6, m4.1, m4.2, m4.3, m4.4, m4.5, m4.6)

# Haetaan mallien M2-indeksit yhteen dataframeen

kolumnit <- c("Malli", "M2", "df", "p", "RMSEA", "RMSEA_5", "RMSEA_95", "SRMSR", "TLI", "CFI")
indeksit <- data.frame(matrix(nrow = 0, ncol = length(kolumnit)))
colnames(indeksit) = kolumnit

for (x in kaikki_mallit) {
  indeksit <- rbind(indeksit, M2(x))
   # Haetaan mallin muuttujanimi tekstinä ja asetetaan mallin rivin ensimmäiseen sarakkeeseen
  indeksit[-1,1] <- deparse(substitute(x))
}

```
