{
  "hash": "3524f998f539f565b3492a7d72267124",
  "result": {
    "markdown": "# Anonymisointi\n\n\n---\neval: false\n---\n\n\nTutkimus anonymisoidaan [anonymisointisuunnitelman](https://osf.io/r3hs2) mukaisesti.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# HUOM: Funktio ei nimeä kuvia! Funktio tulostaa NA jos niitä on.\nplot_freq <- function(x) {\n  as.matrix(x) %>%\n    table(useNA = \"ifany\") %>%\n    barplot()\n}\n\n# Projektipäällikön kirjoittama funktio k-anonymiteetin tarkistamiseksi.\n# Funktio haettu manuaalisesti GitHubista (osaal/ranon#a114b6a).\n# Funktio vaatii paketit checkmate, cli, dplyr ja rlang.\n# HUOM: Muutettu paketin versiosta toimivaksi.\nk_anonymity <- function(data, limit, ...) {\n  # Argument checks\n  if (!(checkmate::check_data_frame(data) || checkmate::check_tibble(data))) {\n    cli::cli_abort(c(\n      \"{.var data} must be a data frame or tibble\",\n      \"x\" = \"You supplied the type {.cls class(data)}\"\n    ))\n  }\n  if (!(checkmate::check_int(limit))) {\n    cli::cli_abort(c(\n      \"{.var limit} must be a single integer\",\n      \"x\" = \"You supplied the type {.cls class(limit)}\"\n    ))\n  }\n\n  # Select data according to variables\n  cols <- dplyr::quos(...)\n\n  # Capture error from incorrect cols and return more helpful error message\n  selected_data <- rlang::try_fetch(\n    data |> dplyr::select(!!!cols),\n    error = function(cnd) {\n      cli::cli_abort(c(\n        \"All supplied columns must exist in {.var data}\",\n        \"X\" = \"You supplied the column names {sapply(cols, rlang::f_text)}\",\n        \"i\" = \"{.var data} contains the columns {names(data)}\",\n        \"i\" = \"Tip: Negated columns must also exist in the data\"\n      ),\n      parent = cnd)\n    }\n  )\n\n  # Crosstabulate and retrieve all unique combinations that fall below the limit\n  low_count_cells <- as.data.frame(table(selected_data)) |>\n    dplyr::filter(Freq < limit)\n\n  # Exit early if no cells fall below the threshold\n  if (length(low_count_cells) == 0) {\n    message(\"All variable combinations are at or above the supplied threshold\")\n    return(NULL)\n  }\n\n  return(low_count_cells)\n}\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\n\ndata <- read.csv2(\"output/puhdistettudata.csv\")\n```\n:::\n\n\n## Järjestys\n\n1.  Tarkistetaan taustamuuttujien kategoriat harvinaisten vastausten osalta yksitellen, ja yhdistetään kategorioita tarpeen mukaan.\n2.  Tarkistetaan harvinaisten ilmiöiden muuttujien kategoriat harvinaisten vastausten osalta yksitellen, ja yhdistetään tai poistetaan kategorioita/muuttujia tarpeen mukaan.\n3.  Taustamuuttujat 5-anonymisoidaan kahden ja kolmen muuttujan yhdistelmissä, ja yhdistetään kategorioita tarpeen mukaan.\n4.  Harvinaiset ilmiöt 5-anonymisoidaan taustamuuttujia vastaan kahden muuttujan yhdistelmissä, ja yhdistetään tai poistetaan kategorioita/muuttujia tarpeen mukaan.\n\n**Kohta 1: Käsiteltävät taustamuuttujat:**\n\n1.  Organisaatiokuuluvuus (`k2`, neljä kategoriaa)\n    1.  Kaikilla vastaajilla tulee olla yksi arvo.\n    2.  Määräsääntö: `n > 5`\n    3.  Yhdistetään luokat `1` ja `2` sekä `3` ja `4` tarpeen vaatiessa.\n2.  Sukupuoli (`k31`, neljä kategoriaa)\n    1.  Kaikilla vastaajilla tulee olla yksi arvo.\n    2.  Määräsääntö: `n > 30`\n    3.  Yhdistetään luokat `1`, `3` ja `4` pienimpään toiseen luokkaan, joka täyttää määräsäännön.\n3.  Työrytmi (`k32-k35`, `k37`)\n    1.  Kaikilla vastaajilla tulee olla yksi arvo, organisaatiokuuluvuudensa mukaisesti.\n    2.  Määräsääntö: `n > 10`\n    3.  Muuttuja `k32`: Yhdistetään samanaiheiseen kategoriaan tarpeen vaatiessa.\n    4.  Muuttuja `k33`: Yhdistetään viereiseen kategoriaan tarpeen vaatiessa.\n    5.  Muuttuja `k34`: Ei muutoksia.\n    6.  Muuttuja `k35`: Yhdistetään viereiseen kategoriaan tarpeen vaatiessa.\n    7.  Muuttuja `k37`: Yhdistetään samanaiheiseen kategoriaan tarpeen vaatiessa.\n4.  Organisaatioasema (`Organisaatioasema`, kuusi kategoriaa)\n    1.  Kaikilla vastaajilla tulee olla yksi arvo.\n    2.  Rakennetaan eri organisaatioasemamuuttujista, ks. @sec-organisaatioaseman-ryhmäkoodaus.\n    3.  Määräsääntö: `n > 10`\n    4.  Yhdistetään luokat `1` ja `4` tarpeen vaatiessa.\n    5.  Muut luokat yhdistetään aiheittain tarpeen vaatiessa.\n5.  Työuran pituus (`k41`) --\\> Viiden fraktiilin luokitus\n    1.  Kaikilla vastaajilla tulee olla yksi arvo.\n    2.  Luokitellaan viiteen fraktiiliin, mikä riittää yksimuuttuja-anonymisoinnille.\n\n**Kohta 2: Harvinaisten ilmiöiden muuttujat:**\n\n1.  Epäasiallisen ja väkivaltaisen kohtelun yleisyys (`k3_1:k4_7`, `k12_1:k13_7`)\n    1.  Yhteensä 28 muuttujaa\n    2.  Kaikilla vastaajilla tulee olla yksi arvo, mikä voi myös olla arvo `NA`\n    3.  Sovelletaan 5-anonymiteettia (ks. kohta 4)\n2.  Kohtelun selventävät mittarit (`k5_3_1:k5_3_2`, `k7_10_1:k7_10_2`, `k8_11_1:k8_11_2`, `k9_5_1:k9_5_2`, `k9_10_1:k9_10_2`, `k10_2_1:k10_2_2`, `k10_10_1:k10_10_2`, `k10_11_1:k10_11_2`, `k11_6_1:k11_6_2`, `k14_3_1:k14_3_2`, `k16_10_1:k16_10_2`, `k17_11_1:k17_11_2`, `k18_5_1:k18_5_2`, `k18_10_1:k18_10_2`, `k19_2_1:k19_2_2`, `k19_10_1:k19_10_2`, `k19_11_1:k19_11_2`)\n    1.  Yhteensä 34 muuttujaa\n    2.  Kaikilla vastaajilla tulee olla yksi arvo, mikä voi myös olla arvo `NA` tai `-1`\n    3.  Määräsääntö: `n > 5`\n    4.  Muuttuja poistetaan jos määräsääntö ei täyty jokaisen kategorian osalta (`NA`, `-1`, `1`)\n3.  Vaikutukset jatkuvat yhä (`k22_1_1:k22_3_1`)\n    1.  Yhteensä 3 muuttujaa\n    2.  Kaikilla vastaajilla tulee olla yksi arvo, mikä voi myös olla arvo `NA` tai `-1`\n    3.  Sovelletaan 5-anonymiteettia (ks. kohta 4)\n4.  Reaktiot kohteluun (`k23_1:k23_11`)\n    1.  Yhteensä 11 muuttujaa\n    2.  Kaikilla vastaajilla tulee olla yksi arvo, mikä voi myös olla arvo `NA` tai `-1`\n    3.  Sovelletaan 5-anonymiteettia (ks. kohta 4)\n\n**Kohta 3: Taustamuuttujien 5-anonymisointi ristiintaulukoimalla**\n\n1.  Organisaatiokuuluvuus x Organisaatioasema (`k2 * Organisaatioasema`)\n2.  Organisaatiokuuluvuus \\* Organisaatioasema \\* Sukupuoli (`k2 * Organisaatioasema * k31`)\n3.  Organisaatiokuuluvuus x Organisaatioasema x Työrytmi (`k2 * Organisaatioasema * k32, k33, k34, k35, k37`)\n4.  Organisaatiokuuluvuus x Organisaatioasema x Työuran pituus (`k2 * Organisaatioasema * k41`)\n\nKaikilla taustamuuttujilla seurataan seuraavaa prioriteettijärjestystä muutoksissa:\n\n1.  Organisaatioaseman (`Organisaatioasema`) kategoriat yhdistetään vähintään neljäksi kategoriaksi.\n2.  Työrytmin (`k32, k33, k34, k35, k37`) kategoriat yhdistetään vähintään kolmeksi kategoriaksi.\n    1.  Poikkeuksena `k34`, jolle ei voida tehdä muutoksia.\n3.  Työuran pituuden (`k41`) fraktiileja vähennetään vähintään kolmeen fraktiiliin.\n4.  Sukupuolen (`k31`) kategoriat yhdistetään vähintään kahteen kategoriaan.\n5.  Organisaatiokuuluvuuden (`k2`) kategoriat yhdistetään vähintään kolmeen kategoriaan.\n\n**Kohta 4: Harvinaisten ilmiöiden 5-anonymisointi taustamuuttujia vastaan**\n\nJokainen kohdassa 2 listattu muuttuja ristiintaulukoidaan yksitellen jokaista taustamuuttujaa kohtaan. Koska taustamuuttujia on yhdeksän kappaletta ja harvinaisia ilmiöitä 62, vertailuja tehdään yhteensä 558 kappaletta.\n\nTätä varten projektipäällikkö on kirjoittanut funktion `k_anonymity()`, joka löytyy osana R-pakettia `ranon` ([GitHubissa](https://github.com/osaal/ranon) `osaal/ranon`)[^anonymisointi-1]. Funktio ottaa yhden tai useamman kategorisen muuttujan, ja palauttaa kaikki kategoriayhdistelmät, joiden solumäärät ristiintaulukoinnissa alittavat ennalta määritetyn raja-arvon (tässä tutkimuksessa viisi). Jos funktiolle annetaan vain yksi muuttuja, tarkistus tehdään muuttujan kategorioille, jolloin kyseessä on yksinkertainen määräsäännön anonymisointitarkistus.\n\n[^anonymisointi-1]: Kirjoitushetkellä (12.9.2024) `master`-haaralla on virhe funktiossa. Virhe on korjattu commitissa `#7cdd062`, joka löytyy haaralta `v0.2`. Kunnes uusi versio on mergattu `master`-haaraan, paketin kannattaa asentaa käyttäen `renv::install(osaal/ranon@v0.2)`.\n\n**HUOM:** Kirjoitushetkellä paketin funktio ei toimi kuten pitäisi. Olemme korjanneet funktion ja testanneet kaikki alla olevat koodaukset simuloidulla datalla ennen anonymisoinnin suorittamista. Korjattu funktio löytyy tämän luvun alusta, ensimmäisestä koodiblokista.\n\n## Kohta 1: Taustamuuttujien anonymisointi\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Muuttujaa voi käyttää myöhemmin looppaamiseen\ntaustamuuttujat <- rlang::exprs(\n  k2,\n  k31, k32, k33, k34, k35, k37,\n  Organisaatioasema,\n  k41\n)\n\n# Tässä ei voida loopata helposti, sillä muuttujien raja-arvot eroavat ja muuttujaa k41 ei tarkisteta ollenkaan\n# Testattu toimivaksi tekaistulla datalla. HUOM: Vaatii nykyiset funktiossa olevat korjaukset (ks. code block 00_anon_funktiot)\n\nk_anonymity(data, limit = 5, k2)\nk_anonymity(data, limit = 30, k31)\nk_anonymity(data, limit = 10, k32)\nk_anonymity(data, limit = 10, k33)\nk_anonymity(data, limit = 10, k34)\nk_anonymity(data, limit = 10, k35)\nk_anonymity(data, limit = 10, k37)\nk_anonymity(data, limit = 10, Organisaatioasema)\n```\n:::\n\n\nTulokset kuvaillaan tässä.\n\nMuutokset kuvaillaan tässä.\n\n\n::: {.cell}\n\n:::\n\n\n## Kohta 2: Harvinaisten ilmiöiden anonymisointi\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Muuttujaa voi käyttää nyt ja myöhemmin looppaamiseen\nmuuttujat <- rlang::exprs(\n  k3_1, k3_2, k3_3, k3_4, k3_5, k3_6, k3_7,\n  k4_1, k4_2, k4_3, k4_4, k4_5, k4_6, k4_7,\n  k12_1, k12_2, k12_3, k12_4, k12_5, k12_6, k12_7,\n  k13_1, k13_2, k13_3, k13_4, k13_5, k13_6, k13_7,\n  k5_3_1, k5_3_2,\n  k7_10_1, k7_10_2,\n  k8_11_1, k8_11_2,\n  k9_5_1, k9_5_2, k9_10_1, k9_10_2,\n  k10_2_1, k10_2_2, k10_10_1, k10_10_2, k10_11_1, k10_11_2,\n  k11_6_1, k11_6_2,\n  k14_3_1, k14_3_2,\n  k16_10_1, k16_10_2,\n  k17_11_1, k17_11_2,\n  k18_5_1, k18_5_2, k18_10_1, k18_10_2,\n  k19_2_1, k19_2_2, k19_10_1, k19_10_2, k19_11_1, k19_11_2,\n  k22_1_1, k22_2_1, k22_3_1,\n  k23_1, k23_2, k23_3, k23_4, k23_5, k23_6, k23_7, k23_8, k23_9, k23_10, k23_11\n  )\n\n# Loopataan harvinaisten ilmiöiden muuttujien läpi ja suoritettaan yhden muuttujan k-anonymisointi (eli yksinkertainen solujen tarkastus)\n# HUOM: Listaus sisältää muuttujaryhmät k3_1:k4_7, k12_1:k13_7, k22_1_1:k22_3_1 ja k23_1:k23_11. Näitä ei anonymisointisuunnitelman mukaisesti kuitenkaan tarkisteta.\n# Testattu toimivaksi tekaistulla datalla. HUOM: Vaatii nykyiset funktiossa olevat korjaukset (ks. code block 00_anon_funktiot)\n\ntulokset_kohta2 <- list()\nfor (i in muuttujat) {\n  tulokset_kohta2[[rlang::as_string(i)]] <- k_anonymity(data, limit = 5, i)\n}\n\n# Poistetaan väliaikaiset muuttujat siisteyden vuoksi\nrm(i, temp)\n```\n:::\n\n\nTulokset kuvaillaan tässä.\n\nMuutokset kuvaillaan tässä.\n\n\n::: {.cell}\n\n:::\n\n\n## Kohta 3: Taustamuuttujien k-anonymisointi toisiaan vastaan\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Testattu toimivaksi tekaistulla datalla. HUOM: Vaatii nykyiset funktiossa olevat korjaukset (ks. code block 00_anon_funktiot)\n\nk_anonymity(data, limit = 5, k2, Organisaatioasema)\nk_anonymity(data, limit = 5, k2, Organisaatioasema, k31)\nk_anonymity(data, limit = 5, k2, Organisaatioasema, k32)\nk_anonymity(data, limit = 5, k2, Organisaatioasema, k33)\nk_anonymity(data, limit = 5, k2, Organisaatioasema, k34)\nk_anonymity(data, limit = 5, k2, Organisaatioasema, k35)\nk_anonymity(data, limit = 5, k2, Organisaatioasema, k37)\nk_anonymity(data, limit = 5, k2, Organisaatioasema, k41)\n```\n:::\n\n\nTulokset kuvaillaan tässä.\n\nMuutokset kuvaillaan tässä.\n\n\n::: {.cell}\n\n:::\n\n\n## Kohta 4: Harvinaisten ilmiöiden k-anonymisointi taustamuuttujia vastaan\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Testattu toimivaksi tekaistulla datalla. HUOM: Vaatii nykyiset funktiossa olevat korjaukset (ks. code block 00_anon_funktiot)\n\ntulokset_kohta4 <- list()\n\nfor (i in muuttujat) {\n  temp <- list()\n  for (j in taustamuuttujat) {\n    temp[[rlang::as_string(j)]] <- k_anonymity(data, limit = 5, i, j)\n  }\n  tulokset_kohta4[[rlang::as_string(i)]] <- temp\n}\n\n# Poistetaan väliaikaiset muuttujat siisteyden vuoksi\nrm(i, j, temp)\n```\n:::\n\n\nTulokset kuvaillaan tässä.\n\nMuutokset kuvaillaan tässä.\n\n\n::: {.cell}\n\n:::\n\n\n## Datan tallennus\n\nAnonymisoinnin jälkeen tallensimme lopullisen datatiedoston `csv`-muotoon. Tallennusta ei ole saatavilla verkkosivun lähdekoodista tietosuojan takia.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwrite.csv2(\n  data,\n  file = \"output/anonymisoitudata.csv\"\n)\n```\n:::\n",
    "supporting": [
      "anonymisointi_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}